<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from logging import exception
from math import nan
import os
from datetime import datetime
import sqlalchemy
from numpy import string_
from urllib3 import get_host
import Module.Persistence.connection as con
import Module.Logs.logs as log
import pandas as pd
import pyarrow.parquet as pq
from dotenv import load_dotenv
import os,sys
import shutil
import pathlib
import psycopg2

class get_adapters:
    &#34;&#34;&#34;Class for adapter&#39;s method

    Params:
        customer_code (str): customer code
        log_name (str): name of logs
    
    &#34;&#34;&#34;
    def __init__(self, customer_code: str, log_name: str):
        load_dotenv()
        self.ps = con.connect_to_postgreSQL()
        self.s3 = con.connect_to_s3()
        self.structured = os.getenv(&#34;STRUCTURED_BUCKET&#34;)
        self.log = os.getenv(&#34;LOG_BUCKET&#34;)
        self.customer_code = customer_code
        self.log_name = log_name
        self.module = &#39;ADAPTER&#39;
        path_to_file = &#34;FILES/ADAPTERS/&#34;
        self.debug = os.getenv(&#34;DEBUG&#34;)
        pathlib.Path(path_to_file).mkdir(parents=True, exist_ok=True)

    def visa_read_sms(self, df: pd.DataFrame , list_columns : list, column_tcr : str, base_count : int, log_name: str = None, client:str = None) -&gt; pd.DataFrame:
        &#34;&#34;&#34;SMS type reading function

        Args:
            df (dataframe) : dataframe with data
            list_columns (list): list of columns
            column_tcr (str): column with tcr data
            base_count (int): counter

        Returns:
            pd.DataFrame: Dataframe with data
        
        &#34;&#34;&#34;
        list_sms = []
        dict_sms = {}
        count = base_count
        module = &#39;ADAPTER&#39;

        for index, value in enumerate(df[column_tcr].values):
            if value[40:42] == &#39;00&#39;:
                if index &gt; 0:
                    list_sms.append(dict_sms)
                dict_sms = {}
                count += 1
                dict_sms.update({list_columns[0] : count})
                for base in range(1,len(list_columns)):
                    dict_sms.update({list_columns[base] : df[list_columns[base]].values[index]})
            dict_sms.update({value[36:42] : value})
        list_sms.append(dict_sms)
        return pd.DataFrame(list_sms)

    def visa_read_condition(self, condition: str, delimiter: str, log_name: str = None, client:str = None) -&gt; list:
        &#34;&#34;&#34;convert to a readable condition list

        Args:
            condition (str): string of conditions
            delimiter (str): conditions delimiter (&amp; or |)

        Returns:
            list_return (list): readable condition list
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;

        list_condition = []
        list_return = []
        list_condition = condition.split(delimiter)
        for string in list_condition:
            if string[0:1] == &#39;P&#39;:
                value_name = string[0:1]
                substring = string[1:string.find(&#39; &#39;)].split(&#39;-&#39;)
                string_start_position = int(substring[0])
                string_end_position = int(substring[1])
                if string.find(&#39;==&#39;)&gt;-1:
                    value_start_position = string.find(&#39;==&#39;)
                if string.find(&#39;!=&#39;)&gt;-1:
                    value_start_position = string.find(&#39;!=&#39;)
                string_value = string[value_start_position+3:].replace(&#34;&#39;&#34;,&#39;&#39;)
                string_tcr = None
                string_operator = string[value_start_position:value_start_position + 2]
            elif string[0:3] == &#39;TCR&#39;:
                value_name = string[0:3]
                list_string = string.split(&#39;:&#39;)
                string_tcr = list_string[0].replace(&#39;TCR &#39;,&#39;&#39;)
                substring = list_string[1][2:list_string[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                string_value = list_string[1][list_string[1].find(&#39;==&#39;)+3:].replace(&#34;&#39;&#34;,&#39;&#39;)
                string_start_position = int(substring[0])
                string_end_position = int(substring[1])
                string_operator = &#39;==&#39;
            list_return.append({&#39;value_name&#39; : value_name,&#39;value_start_position&#39; : string_start_position, &#39;value_end_position&#39; : string_end_position, &#39;value&#39; : string_value, &#39;value_tcr&#39; : string_tcr, &#39;value_operator&#39; : string_operator})
        return list_return

    def visa_apply_condition(self, df : pd.DataFrame, column_apply_condition: str, list_condition : list ,operator : str , skip_character : int, skip_columns : int, log_name: str = None, client:str = None) -&gt; pd.DataFrame:
        &#34;&#34;&#34;Visa conditions applicator

        Args:
            df (dataframe): dataframe with data
            column_apply_condition (str): column conditions
            list_condition (list): list of conditions
            operator (str): operator for condition
            skip_character (int): characters to skip in reading
            skip_columns (int): columns to skip

        Returns:
            pd.Dataframe: Dataframe with data    
        
        &#34;&#34;&#34;
        if operator == &#39;&amp;&#39;:
            for value in list_condition:
                if value[0:1] == &#39;P&#39;:
                    substring_condition = value[1:value.find(&#39; &#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = value[value.find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df = df[df[column_apply_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value]
                if value[0:3] == &#39;TCR&#39;:
                    list_string_condition = value.split(&#39;:&#39;)
                    tcr_condition = list_string_condition[0].replace(&#39;TCR &#39;,&#39;&#39;)
                    if tcr_condition == &#39;0&#39;:
                        column_condition = str(skip_columns)
                    substring_condition = list_string_condition[1][2:list_string_condition[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = list_string_condition[1][list_string_condition[1].find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df = df[df[column_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value]
            return df
        elif operator ==&#39;|&#39;:
            df_tmp = pd.DataFrame()
            df_tmp = df_tmp.join(df.head(0),how=&#39;right&#39;)
            for value in list_condition:
                df_condition_tmp = pd.DataFrame()
                if value[0:1] == &#39;P&#39;:
                    substring_condition = value[1:value.find(&#39; &#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = value[value.find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df_condition_tmp = df_condition_tmp.join(df[df[column_apply_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value],how=&#39;right&#39;)
                if value[0:3] == &#39;TCR&#39;:
                    list_string_condition = value.split(&#39;:&#39;)
                    tcr_condition = list_string_condition[0].replace(&#39;TCR &#39;,&#39;&#39;)
                    if tcr_condition == &#39;0&#39;:
                        column_condition = str(skip_columns)
                    substring_condition = list_string_condition[1][2:list_string_condition[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = list_string_condition[1][list_string_condition[1].find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df_condition_tmp = df_condition_tmp.join(df[df[column_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value],how=&#39;right&#39;)
                if not df_condition_tmp.empty:
                    df_tmp = pd.concat([df_tmp,df_condition_tmp],ignore_index=True).drop_duplicates()
            if not df_tmp.empty:
                return df_tmp
            else:
                return df
        
    def visa_upload_adapter(self, filename_parquet: str, file_type: str = &#39;in&#39;,hash_file:str = None, number_file:str = None, string_date:str = None)-&gt; str:
        &#34;&#34;&#34;Load visa adapter based on type as csv object
        
        Args:
            filename_parquet (str): local parquet file to read
            file_type (str): type of file 
            hash_file (str): hash code of file
            number_file (str): number of file in queue
            string_date (str): date of file

        Returns:
            str: Message

        &#34;&#34;&#34;
        try:
            module = &#39;ADAPTER&#39;
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                &#34;loading adapter file :&#34; + hash_file,
                self.module
            )

            bucket = self.structured
            table_name_adapter = &#39;control.t_visa_adapter&#39;
            table_name_stg_base = &#39;operational.stg_adapter_visa_transaction&#39;
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
            records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
            df = pd.read_parquet(filename_parquet,engine=&#39;pyarrow&#39;)
            filename = &#39;adapter_visa.csv&#39;
            customer = self.customer_code
            skip_columns = 5
            skip_character = -1
            start_position_tcr = 3
            end_position_tcr = 4
            len_tcr = 2
            list_record = []
            list_record_tmp = []
            dict_record = []
            list_base = [&#39;0&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;]
            len_df = len(df.index)
            if file_type == &#39;in&#39;:
                skip_character += 2
                start_position_tcr += 2
                end_position_tcr += 2
                len_tcr += 2
            for record in records_adapter:
                record_tc = record[&#39;type_record&#39;]
                if record_tc not in list_record:
                    list_record.append(record_tc)
                    dict_record.append({&#39;tc&#39;:record[&#39;tc&#39;].replace(&#39; &#39;,&#39;&#39;) , &#39;type_record&#39; : record[&#39;type_record&#39;], &#39;condition_type_record&#39; : record[&#39;condition_type_record&#39;]})
            for value in dict_record:
                list_record_tmp+=value[&#39;tc&#39;].split(&#39;,&#39;)
            for row in dict_record:
                table_name = table_name_stg_base

                if row[&#39;type_record&#39;]!=&#39;transaction&#39;:
                    table_name += &#39;_&#39;+row[&#39;type_record&#39;]
                count_data_tc = 0
                filename_record = f&#34;FILES/ADAPTERS/{customer}_{file_type}_{number_file}_{row[&#39;type_record&#39;]}_{filename}&#34;
                dfnew = pd.DataFrame()
                list_row = row[&#39;tc&#39;].split(&#39;,&#39;)
                select_df = self.visa_apply_condition(df[df[str(skip_columns)].str.startswith(tuple(list_row), na=False)].reset_index(drop=True),str(skip_columns),str(row[&#39;condition_type_record&#39;]).split(&#39;&amp;&#39;),&#39;&amp;&#39;,skip_character,skip_columns)
                dfnew = dfnew.join(select_df[list_base].head(0),how=&#39;right&#39;)
                if row[&#39;type_record&#39;] == &#39;sms&#39;:
                    df_sms = self.visa_read_sms(select_df,list_base,str(skip_columns), len_df)
                for record in records_adapter:
                    str_tc = record[&#39;tc&#39;].replace(&#39; &#39;,&#39;&#39;)
                    str_type_record = record[&#39;type_record&#39;]
                    if str_tc==row[&#39;tc&#39;] and str_type_record == row[&#39;type_record&#39;]:
                        str_tcr = record[&#39;tcr&#39;].replace(&#39; &#39;,&#39;&#39;)
                        string_condition = str(record[&#39;additional_condition&#39;])
                        if record[&#39;position&#39;]&gt;2 or file_type == &#39;out&#39;:
                            start_position_column = record[&#39;position&#39;] + skip_character
                            end_position_column = record[&#39;position&#39;] + record[&#39;length&#39;] + skip_character
                        else:
                            start_position_column = record[&#39;position&#39;] - skip_character
                            end_position_column = record[&#39;position&#39;] + record[&#39;length&#39;] - skip_character
                        name_column = str(record[&#39;column_name&#39;]).replace(&#39;,&#39;,&#39;&#39;).replace(&#39;\n&#39;,&#39;&#39;)
                        for column in select_df:
                            if select_df[column].count()&gt;0:
                                str_row_max_len = select_df[column].str.len().max()
                                if str_row_max_len&gt;len_tcr and int(column)&gt;=skip_columns:
                                    df_column = pd.DataFrame()
                                    df_condition = pd.DataFrame()
                                    count_data_column = 0
                                    count_df_condition = 0
                                    str_temp = list(filter(lambda col: col!= None,select_df[column].str[start_position_tcr:end_position_tcr].drop_duplicates().to_list()))
                                    if record[&#39;type_record&#39;] == &#39;header&#39;:
                                        df_column = df_column.join(select_df[list_base],how=&#39;right&#39;)
                                        df_column[name_column] = select_df[str(skip_columns)].str[start_position_column:end_position_column]
                                        dfnew = pd.merge(dfnew,df_column,how=&#39;outer&#39;)
                                        count_data_tc+=1
                                        break
                                    if str_temp[0] == str_tcr:
                                        select_df_tmp = pd.DataFrame()
                                        list_condition = []
                                        
                                        if string_condition.find(&#39;&amp;&#39;) != -1:
                                            list_condition = string_condition.split(&#39;&amp;&#39;)
                                            select_df_tmp = select_df_tmp.join(self.visa_apply_condition(select_df,column,list_condition[1].split(&#39;|&#39;),&#39;&amp;&#39;,skip_character,skip_columns),how=&#39;right&#39;)
                                        else:
                                            select_df_tmp = select_df_tmp.join(select_df,how=&#39;right&#39;)
                                        string_condition_sub = string_condition.split(&#39;&amp;&#39;)
                                        if (string_condition_sub[0].find(&#39;|&#39;) != -1 or len(string_condition_sub[0])&gt;0):
                                            list_condition = string_condition_sub[0].split(&#39;|&#39;)
                                            if row[&#39;type_record&#39;] == &#39;sms&#39;:
                                                list_sms = self.visa_read_condition(string_condition_sub[0],&#39;|&#39;)
                                                df_condition = df_condition.join(df_sms,how=&#39;right&#39;)
                                                column = list_sms[0][&#39;value&#39;]
                                                if len(list_sms)&gt;1 and column in df_condition.columns.values:
                                                    if list_sms[1][&#39;value_operator&#39;] == &#39;!=&#39;:
                                                        df_condition.loc[df_condition[column].str[list_sms[1][&#39;value_start_position&#39;] - skip_character:list_sms[1][&#39;value_end_position&#39;]] != list_sms[1][&#39;value&#39;],column] = df_condition[column]
                                                    if list_sms[1][&#39;value_operator&#39;] == &#39;==&#39;:
                                                        df_condition.loc[df_condition[column].str[list_sms[1][&#39;value_start_position&#39;] - skip_character:list_sms[1][&#39;value_end_position&#39;]] == list_sms[1][&#39;value&#39;],column] = df_condition[column]
                                                    count_df_condition = df_condition[column].count()
                                            else:
                                                df_condition = df_condition.join(self.visa_apply_condition(select_df_tmp,column,list_condition,&#39;|&#39;,skip_character,skip_columns),how=&#39;right&#39;)
                                                count_df_condition = df_condition[column].count()
                                            df_column = df_column.join(df_condition[list_base],how=&#39;right&#39;)

                                            if count_df_condition&gt;0:
                                                df_column[name_column] = df_condition[column].str[start_position_column:end_position_column]
                                                count_data_column += 1
                                            else:
                                                df_column[name_column] = nan
                                        else:
                                            df_column = df_column.join(select_df_tmp[list_base],how=&#39;right&#39;)

                                            df_column[name_column] = select_df_tmp[column].str[start_position_column:end_position_column]
                                            count_data_column += 1
                                        if count_data_column&gt;0:
                                            dfnew = pd.merge(dfnew,df_column,how=&#39;outer&#39;)
                                            df_column = df_column[df_column[name_column].notna()]
                                            count_data_tc+=1
                                        break
                if count_data_tc &gt; 0:
                    dfnew = dfnew.rename(columns = {&#39;0&#39;:&#39;app_id&#39;,&#39;1&#39;:&#39;app_customer_code&#39;,&#39;2&#39;:&#39;app_type_file&#39;,&#39;3&#39;:&#39;app_hash_file&#39;,&#39;4&#39;:&#39;app_processing_date&#39;})
                    str_columns = &#39;&#34;&#39; + &#39;&#34;,&#34;&#39;.join(map(str,list(dfnew.columns.values))) + &#39;&#34;&#39;
                    dfnew.to_csv(filename_record,index=False,encoding=&#39;utf-8&#39;)
                    self.s3.upload_object(bucket,filename_record,f&#34;adapters/{filename_record}&#34;,)
                    result = self.ps.insert_from_csv(table_name,&#34;&#34;&#34;(format csv, header true, quote &#39;&#34;&#39; )&#34;&#34;&#34;,bucket,f&#34;adapters/{filename_record}&#34;,str_columns,False)
                    result_message = f&#34;{row[&#39;type_record&#39;]} : {len(dfnew)} {result}&#34;
                else:
                    result_message = f&#34;{row[&#39;type_record&#39;]} : data not found&#34;
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    self.customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;ADAPTER OF VISA FILE&#34;,
                    &#34;INFO&#34;,
                    result_message,
                    self.module
                )
            return &#39;finished&#39;
        except Exception as e:   
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                &#34;error loading adapter file :&#34; + hash_file
                + &#34; | exception reading file: &#34;
                + str(e),
                self.module
            )
              
    def mastercard_extract_pds(self, str_value : str, find_str : int,log_name: str = None, client:str = None) -&gt; str:
        &#34;&#34;&#34;Method to extract pds of Dataelements

        Args:
            str_value (str): value of data element
            find_str (str): pds number

        Returns:
            str: pds value
        &#34;&#34;&#34;

        
        if str_value[0:4].isnumeric():
            len_str = len(str_value)
            len_value = int(str_value[4:7])
            str_pds = int(str_value[0:4])
            len_max_value = len_value + 7
            
            if str_pds == find_str:
                return str_value[7:len_max_value]
            elif len_max_value &lt; len_str:
                return self.mastercard_extract_pds(str_value[len_max_value:],find_str)
            else:
                return &#39;&#39;
        else:
            return &#39;&#39;

    def mastercard_find_pds(self, df_pds : pd.DataFrame, list_column_pds: list,column_name_de: str,log_name: str = None, client:str = None)-&gt; pd.DataFrame:
        &#34;&#34;&#34;Method to find pds of Dataelements

        Args:
           df_pds(dataframe) : Dataframe with data
           list_column_pds (list): list of pds names
           column_name_de (str): column name of data element

        Returns:
            pd.DataFrame: dataframe with DE data
        &#34;&#34;&#34;
        list_pds = []
        for value in df_pds[column_name_de].values:
            dict_pds = {}
            dict_pds.update({&#39;de&#39; : column_name_de[2:]})
            for pds_value in list_column_pds:
                if value!=None:
                    dict_pds.update({pds_value : self.mastercard_extract_pds(value,int(pds_value))})
                else:
                    dict_pds.update({pds_value : &#39;&#39;})
            list_pds.append(dict_pds)
        return pd.DataFrame(list_pds)
    
    def mastercard_upload_adapter(self, filename_parquet: str, file_type: str = &#39;in&#39;,hash_file:str=None,number_file:str = None, string_date:str=None) -&gt; str:
        &#34;&#34;&#34;Load Mastercard adapter based on type as csv object
        
        Args:
            filename_parquet (str): local parquet file to read
            file_type (str): type of file 
            hash_file (str): hash code of file
            number_file (str): number of file in queue
            string_date (str): date of file

        Returns:
            str: Message

        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            &#34;loading mastercard adapter type file : &#34; + file_type,
            self.module
        )

        bucket = self.structured
        table_name_adapter = &#39;control.t_mastercard_adapter&#39;
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df = pd.read_parquet(filename_parquet,engine=&#39;pyarrow&#39;)
        df[&#39;app_id&#39;] = df.index + 1
        df[&#39;app_type_file&#39;] = file_type.upper()
        filename = &#39;adapter_mastercard.csv&#39;
        customer = self.customer_code
        table_name_base = &#39;operational.stg_adapter_mastercard&#39;
        list_columns_de = []
        list_columns_pds = []
        list_columns_base = [&#39;app_id&#39;,&#39;app_type_file&#39;,&#39;app_client&#39;,&#39;app_hash&#39;,&#39;MESSAGE_TYPE&#39;,&#39;app_file_date&#39;]
        list_columns_base_pds = [&#39;app_id&#39;,&#39;app_type_file&#39;,&#39;app_client&#39;,&#39;app_hash&#39;,&#39;app_file_date&#39;]
        dict_adapter_de = []
        list_adapter = []
        start_position_column = 0
        start_position_column_subfield = 0
        pds_start_position_column_subfield = 0
        pds_code = 2
        df_adapter = pd.DataFrame(records_adapter)
        df_adapter_de = pd.DataFrame()
        df_adapter[&#39;length&#39;] = df_adapter[&#39;field_max_length&#39;]
        df_adapter.loc[df_adapter[&#39;field_max_length&#39;] == 0, &#39;length&#39;] = df_adapter[&#39;field_min_length&#39;]

        df_adapter.loc[df_adapter[&#39;type_record&#39;] != pds_code, &#39;list_column_de&#39;] = &#39;DE&#39; + df_adapter[&#39;de&#39;].astype(str)
        list_columns_de.extend(list_columns_base)
        list_columns_de.extend(df_adapter[df_adapter[&#39;list_column_de&#39;].notna()][&#39;list_column_de&#39;].drop_duplicates().values)
        df = df.filter(items=list_columns_de)
        df_adapter_pds = df_adapter[df_adapter[&#39;pds&#39;] == pds_code].reset_index(drop=True)
        table_name_pds = table_name_base + &#39;_&#39; + df_adapter_pds[&#39;type_record&#39;][0]
        for type_record in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            df_new = pd.DataFrame()
            df_adapter_record = pd.DataFrame()
            select_df = pd.DataFrame()
            df_load = pd.DataFrame()
            filename_record = f&#34;FILES/ADAPTERS/{customer}_{file_type}_{number_file}_{type_record}_{filename}&#34;
            start_position_column_subfield = 0
            len_column_subfield = 0
            count = 0
            table_name = table_name_base + &#39;_&#39; + type_record
            df_adapter_record = df_adapter_record.join(df_adapter[(df_adapter[&#39;type_record&#39;]==type_record) &amp; (df_adapter[&#39;pds&#39;]&lt;pds_code)].sort_values(by=[&#39;de&#39;,&#39;subfield&#39;],ascending=True).reset_index(drop=True),how=&#39;right&#39;)
            list_row = df_adapter_record[&#39;message_type_identifier&#39;].drop_duplicates().values[0].split(&#39;,&#39;)
            select_df = select_df.join(df[df[&#39;MESSAGE_TYPE&#39;].str.startswith(tuple(list_row), na=False)].reset_index(drop=True),how=&#39;right&#39;)
            df_new = df_new.join(select_df[list_columns_base],how=&#39;right&#39;)
            for index,column_name in enumerate(df_adapter_record[&#39;column_name&#39;].values):
                if select_df.empty:
                    continue

                len_column = 0
                if df_adapter_record[&#39;subfield&#39;][index] == 0: 
                    len_column = df_adapter_record[&#39;field_max_length&#39;][index] if int(df_adapter_record[&#39;field_max_length&#39;][index]) &gt; 0 else df_adapter_record[&#39;field_min_length&#39;][index]
                    start_position_column_subfield = 0
                    start_position = 0
                else:
                    if df_adapter_record[&#39;subfield&#39;][index] == 1:
                        start_position_column_subfield = 0
                    len_column_subfield = df_adapter_record[&#39;subfield_max_length&#39;][index] if int(df_adapter_record[&#39;subfield_max_length&#39;][index]) &gt; 0 else df_adapter_record[&#39;subfield_min_length&#39;][index]
                    start_position = start_position_column_subfield
                    len_column = start_position + len_column_subfield
                    start_position_column_subfield += len_column_subfield

                df_load = pd.concat([df_load,select_df[df_adapter_record[&#39;list_column_de&#39;][index]].str[start_position:len_column]],axis=1)
                df_load = df_load.rename(columns = {df_adapter_record[&#39;list_column_de&#39;][index] : column_name})
                if df_adapter_record[&#39;pds&#39;][index] == 1:
                    pds_start_position_column_subfield = 0
                    pds_len_column_subfield = 0
                    df_adapter_pds = df_adapter_pds.sort_values(by=[&#39;de&#39;,&#39;subfield&#39;],ascending=True).reset_index(drop=True)
                    list_columns_pds = df_adapter_pds[&#39;de&#39;].drop_duplicates().values
                    df_load_sub = pd.DataFrame()
                    df_load_sub = pd.concat([df_load_sub,self.mastercard_find_pds(select_df,list_columns_pds,df_adapter_record[&#39;list_column_de&#39;][index])],axis=1)
                    for pds_index, pds_column_name in enumerate(df_adapter_pds[&#39;column_name&#39;].values):
                        df_column_pds = pd.DataFrame()
                        if not df_load_sub[df_load_sub[df_adapter_pds[&#39;de&#39;][pds_index]] !=&#39;&#39;].empty:
                            pds_len_column = 0
                            if df_adapter_pds[&#39;subfield&#39;][pds_index] == 0: 
                                pds_len_column = df_adapter_pds[&#39;field_max_length&#39;][pds_index] if int(df_adapter_pds[&#39;field_max_length&#39;][pds_index]) &gt; 0 else df_adapter_pds[&#39;field_min_length&#39;][pds_index]
                                pds_start_position_column_subfield = 0
                                pds_start_position = 0
                            else:
                                if df_adapter_pds[&#39;subfield&#39;][pds_index] == 1:
                                    pds_start_position_column_subfield = 0
                                pds_len_column_subfield = df_adapter_pds[&#39;subfield_max_length&#39;][pds_index] if int(df_adapter_pds[&#39;subfield_max_length&#39;][pds_index]) &gt; 0 else df_adapter_pds[&#39;subfield_min_length&#39;][pds_index]
                                pds_start_position = pds_start_position_column_subfield
                                pds_len_column = pds_start_position + pds_len_column_subfield
                                pds_start_position_column_subfield += pds_len_column_subfield
                            df_load = pd.concat([df_load,df_load_sub[df_adapter_pds[&#39;de&#39;][pds_index]].str[pds_start_position:pds_len_column]],axis=1)
                            df_load = df_load.rename(columns = {df_adapter_pds[&#39;de&#39;][pds_index] : pds_column_name})
                count+=1
            if count&gt;0:
                df_new = pd.concat([df_new,df_load],axis=1)
                df_new = df_new.rename(columns = {&#39;app_client&#39;:&#39;app_customer_code&#39;,&#39;app_hash&#39;:&#39;app_hash_file&#39;,&#39;MESSAGE_TYPE&#39;:&#39;app_message_type&#39;,&#39;app_file_date&#39; : &#39;app_processing_date&#39;})
                str_columns = &#39;&#34;&#39; + &#39;&#34;,&#34;&#39;.join(map(str,list(df_new.columns.values))) + &#39;&#34;&#39;
                df_new.to_csv(filename_record,index=False, encoding=&#39;utf-8&#39;)
                self.s3.upload_object(bucket,filename_record,f&#34;adapters/{filename_record}&#34;,)
                
                result = self.ps.insert_from_csv(table_name,&#34;&#34;&#34;(format csv, header true, quote &#39;&#34;&#39; )&#34;&#34;&#34;,bucket,f&#34;adapters/{filename_record}&#34;,str_columns,False)
                result_message = f&#34;{type_record} : {len(df_new)} {result}&#34;
            if count==0:
                result_message = f&#34;{type_record} : data not found&#34;
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
            )
        return &#39;finished&#39;
    
    def visa_clear_stg(self):
        &#34;&#34;&#34;Clean Visa staging tables for execution, returns message&#34;&#34;&#34;

        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        table_name_adapter = &#39;control.t_visa_adapter&#39;
        table_name_stg_base = &#39;operational.stg_adapter_visa_transaction&#39;
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df_records = pd.DataFrame(records_adapter)
        for value in df_records[&#39;type_record&#39;].drop_duplicates().reset_index(drop=True).values:
            table_name = table_name_stg_base
            if value!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value
            log.logs().exist_file(
                        &#34;OPERATIONAL&#34;,
                        self.customer_code,
                        &#34;VISA&#34;,
                        self.log_name,
                        &#34;ADAPTER OF VISA FILE&#34;,
                        &#34;INFO&#34;,
                        self.ps.truncate_table(table_name),
                        self.module
                    )
        return &#39;finished&#39;
    
    def mastercard_clear_stg(self):
        &#34;&#34;&#34;Clean Mastercard staging tables for execution, returns message&#34;&#34;&#34;
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        table_name_adapter = &#39;control.t_mastercard_adapter&#39;
        table_name_stg_base = &#39;operational.stg_adapter_mastercard&#39;
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df_records = pd.DataFrame(records_adapter)
        for value in df_records[&#39;type_record&#39;].drop_duplicates().reset_index(drop=True).values:
            table_name = table_name_stg_base
            table_name += &#39;_&#39;+value
            log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    self.customer_code,
                    &#34;MASTERCARD&#34;,
                    self.log_name,
                    &#34;ADAPTER OF MASTERCARD FILE&#34;,
                    &#34;INFO&#34;,
                    self.ps.truncate_table(table_name),
                    self.module
                )
        return &#39;finished&#39;

class get_others:
    &#34;&#34;&#34;Class for other methods relationated to adpaters
    
    Params:
        customer_code (str): customer code
        log_name (str): name of logs
    &#34;&#34;&#34;
    def __init__(self, customer_code: str, log_name: str):
   
        load_dotenv()
        self.ps = con.connect_to_postgreSQL()
        self.s3 = con.connect_to_s3()
        self.structured = os.getenv(&#34;STRUCTURED_BUCKET&#34;)
        self.log = os.getenv(&#34;LOG_BUCKET&#34;)
        self.customer_code = customer_code
        self.log_name = log_name
        self.module = &#39;ADAPTER&#39;
        self.region_country_global=&#39;9&#39;
        self.debug = os.getenv(&#34;DEBUG&#34;)
        print(os.getenv(&#34;DEBUG&#34;))

    
    def update_column_table_from_adapter(self, adapter_column_base:list, adapter_table_scheme:str, adapter_table_name: str, table_scheme: str, table_name: str, type_record: str, column_type: bool = False, column_format: bool = False, column_partition: str = None, partition_type: str = None, adapter_where: str = None, adapter_order: str = None,log_name: str = None, client:str = None)-&gt;str:
        &#34;&#34;&#34;Update columns from the adapter
        
        Args:
            adapter_column_base (list): List of columns for adapter
            adapter_table_scheme (str): adapter schema for table
            adapter_table_name (str): adapter table name
            table_scheme (str): temporal table schema
            table_name (str): temporal table name
            type_record (str): type of record
            column_type (bool): column type indicator
            column_format (bool): column format indicator
            column_partition (str): column for partition
            partition_type (str): type of partition
            adapter_where (str): condition for adapter query 
            adapter_order (str): column order by for adapter query

        Returns:
            result_message (str): Message
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_columns_name = &#39;column_name, length, column_type&#39;
        list_table_y = []
        list_table_x = []
        if adapter_where==None:
            adapter_where=&#39;&#39;
        if adapter_order==None:
            adapter_order=&#39;&#39;
        if column_format:
            adapter_columns_name = &#34; replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(column_name,&#39;]&#39;,&#39;&#39;),&#39;[&#39;,&#39;&#39;),&#39;.&#39;,&#39;&#39;),&#39;&#39;&#39;&#39;,&#39;&#39;),&#39;)&#39;,&#39;&#39;),&#39;(&#39;,&#39;&#39;),&#39;/&#39;,&#39;&#39;),&#39;-&#39;,&#39;_&#39;),&#39; &#39;,&#39;_&#39;),&#39;___&#39;,&#39;_&#39;),&#39;__&#39;,&#39;_&#39;) as column_name,length,column_type,column_decimal&#34;
        list_table_y.extend(adapter_column_base)
        list_table_x = self.ps.get_structure_table_from_db(table_scheme,table_name)
        list_table_y.extend(self.ps.select(adapter_table,f&#34;where type_record = &#39;{type_record}&#39; {adapter_where} {adapter_order}&#34;,adapter_columns_name))
        df_x = pd.DataFrame(list_table_x)
        df_y = pd.DataFrame(list_table_y)
        if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):
            self.ps.create_table(list_table_y,table_scheme+&#39;.&#39;+table_name,column_type,column_partition,partition_type)  

            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                &#34;table created : &#34;
                + table_scheme
                + &#34;.&#34;
                + table_name,
                self.module
            )

            return self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,type_record,column_format=column_format,adapter_where=adapter_where,adapter_order=adapter_order)
        if len(df_x) != len(df_y):
            list_table_difference = []
            for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                if not value in (df_x[&#39;column_name&#39;].values):
                    list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
            result_message = self.ps.add_column(list_table_difference,table_scheme,table_name)
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
            )
            if len(df_x)&lt;=len(df_y):
                return self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,type_record,column_format=column_format,adapter_where=adapter_where,adapter_order=adapter_order)
            result_message = f&#39;columns difference to table : {table_scheme}.{table_name}&#39;
        if len(df_x) == len(df_y):
            list_table_difference = []
            for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                if value in (df_x[&#39;column_name&#39;].values):
                    if str(df_x[df_x[&#39;column_name&#39;] == df_y[&#39;column_name&#39;][index]][&#39;data_type&#39;].values[0]).replace(&#39;character varyinresult_messageg&#39;,&#39;varchar&#39;) != df_y[&#39;column_type&#39;][index]:
                        list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
            result_message = f&#39;{len(list_table_difference)} columns difference to table : {table_scheme}.{table_name}&#39;
        return result_message

    def visa_config_table_adapter_dh(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the visa adapter table dh
        
        Args:
           string_start_date (str): starting date for range  
           string_end_date (str): ending date for range

        Returns:
            str: Message
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_visa_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_start_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_visa_transaction&#39;
            if value[&#39;type_record&#39;]!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value[&#39;type_record&#39;]
            result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],True,True,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by type_record,tcr,position,column_name&#39;)
            customer_code = self.customer_code
            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)
        
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )
                     
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )          
                            
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )                        
            
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )                   
            
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_idx&#39;,&#39;app_id,app_hash_file&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )
            
        message_index = self.ps.create_table_index(table_scheme,&#39;dh_visa_transaction&#39;,&#39;dh_visa_transaction_account_number_idx&#39;,&#39;account_number&#39;)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )          
        
        message_create_table_index = self.ps.create_table_index(table_scheme,&#39;dh_visa_transaction_sms&#39;,&#39;dh_visa_transaction_sms_card_number_idx&#39;,&#39;card_number&#39;)
        
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_create_table_index),
            self.module
            )        
    
        return &#39;finished&#39;
    def visa_config_table_adapter_stg(self, string_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the visa adapter table staging
        
        Args:
           string_date (str): date for range  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_visa_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;text&#39;}]
        table_scheme = &#39;operational&#39;
        table_name_base = &#39;stg_adapter_visa_transaction&#39;
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_name = table_name_base

            if value[&#39;type_record&#39;]!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value[&#39;type_record&#39;]             
            
            message_update = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],False,False,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by type_record,tcr,position,column_name&#39;)
                         
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_update),
            self.module
            )                      
            
            customer_code = self.customer_code

            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      


        return &#39;finished&#39;
    def mastercard_config_table_adapter_stg(self, string_date : str = None,log_name: str = None, client:str = None)-&gt;str:
        &#34;&#34;&#34;Configuration of the mastercard adapter table staging
        
        Args:
           string_date (str): date for range  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_message_type&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;text&#39;}]
        table_scheme = &#39;operational&#39;
        table_name_base = &#39;stg_adapter_mastercard&#39;
        module = &#39;ADAPTER&#39;

        pds_code = &#39;2&#39;
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where pds &lt;{pds_code} and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_name = table_name_base + &#39;_&#39; + value[&#39;type_record&#39;]        
                 
            result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],False,False,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by pds,de&#39;)
               
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            )             
           
            customer_code = self.customer_code

            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )         

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )         

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )         

        return &#39;finished&#39;
    def mastercard_config_table_adapter_dh(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the mastercard adapter table dh
        
        Args:
            string_start_date (str): starting date for range  
            string_end_date (str): ending date for range 

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_message_type&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        module = &#39;ADAPTER&#39;
        &#34;&#34;&#34;log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        &#34;Operational table configuration: &#34;
        + adapter_table_scheme
        + &#34;.&#34;
        + adapter_table_name,
        self.module
        )   &#34;&#34;&#34;
          
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_start_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date) and type_record&lt;&gt;&#39;private_data_subelement&#39;&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_mastercard&#39;
            table_name += &#39;_&#39;+value[&#39;type_record&#39;]
            result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],True,True,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by pds,de&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            )         
            customer_code = self.customer_code

            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  


            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  




            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  

            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_idx&#39;,&#39;app_id,app_hash_file&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )

        message_index = self.ps.create_table_index(table_scheme,&#39;dh_mastercard_data_element&#39;,&#39;dh_mastercard_data_pan_idx&#39;,&#39;pan&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        ) 
        return &#39;finished&#39;

    def visa_load_transaction(self, string_date: str = None,type_file: str = None)-&gt;str:
        &#34;&#34;&#34;Load of visa transaction
        
        Args:
            string_date (str): date for range condition  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_visa_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        hash_file = &#39;45b9c08a79b0a9ffc3803433b6cf241b86acb2aa94c78f51fe7147ed18a1423b&#39;
        number_file = &#39;1&#39;
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading transactions type file : &#34;+ type_file,
        self.module
        )   
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
        for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_visa_transaction&#39;
            table_name_stg = &#39;stg_adapter_visa_transaction&#39;
            if value!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value
                table_name_stg += &#39;_&#39;+value
            df_structure_dh = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name,&#39;order by column_name&#39;))
            df_structure_stg = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name_stg,&#39;order by column_name&#39;))
            select_query = &#39;select &#39;
            left_query = &#39;&#39;
            str_column_dh = &#39;&#39;
            for column in df_structure_stg[&#39;column_name&#39;].values:
                if column in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;):
                    continue
                str_column_format = column.replace(&#39;]&#39;,&#39;&#39;).replace(&#39;[&#39;,&#39;&#39;).replace(&#39;.&#39;,&#39;&#39;).replace(&#34;&#39;&#34;,&#39;&#39;).replace(&#39;)&#39;,&#39;&#39;).replace(&#39;(&#39;,&#39;&#39;).replace(&#39;/&#39;,&#39;&#39;).replace(&#39;-&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;_&#39;).replace(&#39;___&#39;,&#39;_&#39;).replace(&#39;__&#39;,&#39;_&#39;) + &#39;,&#39;
                str_column_dh += str_column_format
                column = f&#39;&#34;{column}&#34;&#39;
                if column == &#39;&#34;app_id&#34;&#39;:
                    column =&#39;a.app_id::numeric&#39;
                elif column in (&#39;&#34;app_customer_code&#34;&#39;,&#39;&#34;app_type_file&#34;&#39;,&#39;&#34;app_hash_file&#34;&#39;,&#39;&#34;app_creation_user&#34;&#39;,&#39;&#34;app_creation_date&#34;&#39;):
                    column = &#39;a.&#39;+column.replace(&#39;&#34;&#39;,&#39;&#39;)
                elif column == &#39;&#34;app_processing_date&#34;&#39;:
                    column = f&#34;to_date(app_processing_date,&#39;yyyy-mm-dd&#39;)&#34;
                elif column == &#39;&#34;account number&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                elif column == &#39;&#34;account number extension&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                elif column == &#39;&#34;account reference number date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} is not null then 
                            case 
                                when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;purchase date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} &lt;&gt; &#39;0000&#39; then 
                            case 
                                when left({column},2)::integer&lt;=substr(app_processing_date,6,2)::integer then to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||{column},&#39;yyyymmdd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;destination amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
                elif column == &#39;&#34;source amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
                elif column == &#39;&#34;central processing date&#34;&#39;:
                    column = f&#34;to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)&#34;
                elif column == &#39;&#34;national reimbursement fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
                elif column == &#39;&#34;conversion date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} &lt;&gt; &#39;0000&#39; then 
                            case 
                                when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;merchant country code&#34;&#39;:
                    column = f&#34;trim({column})&#34;
                elif column == &#39;&#34;surcharge amount sp&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount sd&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount in cardholder billing currency sp&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount in cardholder billing currency sd&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount df&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;money transfer foreign exchange fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;authorized amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;total authorized amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;interchange fee amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;source currency to base currency exchange rate&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;base currency to destination currency exchange rate&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;optional issuer isa amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;local tax&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;national tax&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;other tax&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;settlement date&#34;&#39;:
                    column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;report date 140&#34;&#39;:
                    column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;report date 110&#34;&#39;:
                    column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;credit amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;debit amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange amount (settlement currency) 140&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange amount (settlement currency) 130&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;clearing amount (clearing currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange value credits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;visa charges credits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;reimbursement fee credits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;visa charges debits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;reimbursement fee debits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange value debits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;processing date header&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;processing date&#34;&#39;:
                    column = f&#34;case when {column} &lt;&gt;&#39;00000&#39; then to_date({column},&#39;yyddd&#39;) end&#34;
                elif column == &#39;&#34;destination amount trailer&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;source amount trailer&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;rate table date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} is not null then 
                            case 
                                when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;local transaction date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} is not null then 
                            case 
                                when left({column},2)::integer&lt;=substr(app_processing_date,6,2)::integer then to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||{column},&#39;yyyymmdd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;online settlement date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;plus settlement date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;mmddyy&#39;)&#34;
                elif column == &#39;&#34;reimbursement fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;transaction amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;filed 54 - original amount - clearing currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;transmission date&#34;&#39;:
                    column = f&#34;to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)&#34;
                elif column == &#39;&#34;settlement amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;transaction integrity fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount sms&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;terminal transaction date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;settlement date sms&#34;&#39;:
                    column = f&#34;to_date({column},&#39;mmddyy&#39;)&#34;
                elif column == &#39;&#34;cardholder billing amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;vss processing date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;cryptogram amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;pre-currency conversion amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;cardholder bililng other amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;cryptogram cashback amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;optional issuer fee - settlement currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;optional issuer fee - cardholder billing currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;optional issuer isa amount in settlement currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;card number&#34;&#39;:
                    column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::numeric&#34;
                else:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    if df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0] in [&#39;numeric&#39;,&#39;integer&#39;,&#39;bigint&#39;]:
                        column = f&#34;case when operational.isnumeric({column}) then {column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]} end&#34;
                    else:
                        column = f&#34;{column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                select_query += f&#39; {column},&#39;
            if value in [&#39;vss_110&#39;,&#39;vss_120&#39;,&#39;vss_130&#39;,&#39;vss_140&#39;]:
                vss_report_code = value[-3:]
                left_query = f&#39;left join operational.m_currency c on (c.currency_numeric_code = case when operational.isnumeric(a.&#34;settlement currency code {vss_report_code}&#34;) then a.&#34;settlement currency code {vss_report_code}&#34;::integer end)&#39;
            
            str_column_dh = str_column_dh[:-1]
            insert_query = f&#39;insert into {table_scheme}.{table_name} ({str_column_dh}) &#39;
            select_query = select_query[:-1] + f&#39; from {table_scheme}.{table_name_stg}_{customer_code}_{type_file} a &#39;
            query = insert_query + select_query + left_query
            partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
            result_message = self.ps.insert(query,[(table_name)])

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            ) 
            result_message = str(self.ps.table_count(table_scheme,f&#39;{table_name}_{customer_code}_{type_file}&#39;)) +&#39; &#39; + result_message + &#39; &#39; + table_name
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        return &#39;finished&#39;

    def mastercard_load_transaction(self, string_date: str = None,type_file:str=None, hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Load of mastercard transaction
        
        Args:
            string_date (str): date for range condition  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading transactions type file : &#34;+ type_file,
        self.module
        ) 

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
        for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_mastercard&#39;
            table_name_stg = &#39;stg_adapter_mastercard&#39;
            table_name += &#39;_&#39;+value
            table_name_stg += &#39;_&#39;+value
            df_structure_dh = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name,&#39;order by column_name&#39;))
            df_structure_stg = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name_stg,&#39;order by column_name&#39;))

            select_query = &#39;select &#39;
            left_query = &#39;&#39;
            str_column_dh = &#39;&#39;
            for column in df_structure_stg[&#39;column_name&#39;].values:
                if column in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;):
                    continue
                str_column_format = column.replace(&#39;]&#39;,&#39;&#39;).replace(&#39;[&#39;,&#39;&#39;).replace(&#39;.&#39;,&#39;&#39;).replace(&#34;&#39;&#34;,&#39;&#39;).replace(&#39;)&#39;,&#39;&#39;).replace(&#39;(&#39;,&#39;&#39;).replace(&#39;/&#39;,&#39;&#39;).replace(&#39;-&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;_&#39;).replace(&#39;___&#39;,&#39;_&#39;).replace(&#39;__&#39;,&#39;_&#39;) + &#39;,&#39;
                str_column_dh += str_column_format
                column = f&#39;&#34;{column}&#34;&#39;
                if column == &#39;&#34;app_id&#34;&#39;:
                    column =&#39;a.app_id::numeric&#39;
                elif column in (&#39;&#34;app_customer_code&#34;&#39;,&#39;&#34;app_type_file&#34;&#39;,&#39;&#34;app_hash_file&#34;&#39;,&#39;&#34;app_message_type&#34;&#39;,&#39;&#34;app_creation_user&#34;&#39;,&#39;&#34;app_creation_date&#34;&#39;):
                    column = &#39;a.&#39;+column.replace(&#39;&#34;&#39;,&#39;&#39;)
                elif column == &#39;&#34;app_processing_date&#34;&#39;:
                    column = f&#34;to_date(app_processing_date,&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;pan&#34;&#39;:
                    column = f&#34;case when operational.isnumeric(replace({column},&#39;*&#39;,&#39;0&#39;)) then replace({column},&#39;*&#39;,&#39;0&#39;)::bigint end&#34;
                elif column == &#39;&#34;amount transaction&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amount reconciliation&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amount cardholder billing&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;conversion rate reconciliation&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then substr({column},2)::numeric/(10^left({column},1)::numeric) end&#34;
                elif column == &#39;&#34;conversion rate cardholder billing&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then substr({column},2)::numeric/(10^left({column},1)::numeric) end&#34;
                elif column == &#39;&#34;amount net transaction in reconciliation currency 2&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amounts transaction fee 5&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amounts transaction fee 7&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amount net fee in reconciliation currency 2&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;date and time local transaction&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_timestamp({column},&#39;YYMMDDhh24miss&#39;) end&#34;
                elif column == &#39;&#34;date action&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;amount currency conversion assessment&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;business activity 5&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;settlement data 6&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;settlement data 8&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;business date&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                else:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    if df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0] in [&#39;numeric&#39;,&#39;integer&#39;,&#39;bigint&#39;,&#39;timestamp&#39;,&#39;date&#39;]:
                        column = f&#34;case when operational.isnumeric({column}) then {column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]} end&#34;
                    else:
                        column = f&#34;{column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                select_query += f&#39; {column},&#39;
            
            left_query = f&#34;&#34;&#34;
            left join operational.m_currency c on (c.currency_numeric_code = case when operational.isnumeric(a.&#34;currency code transaction&#34;) then a.&#34;currency code transaction&#34;::integer end) 
            left join operational.m_currency d on (d.currency_numeric_code = case when operational.isnumeric(a.&#34;currency code reconciliation&#34;) then a.&#34;currency code reconciliation&#34;::integer end) 
            &#34;&#34;&#34;
            str_column_dh = str_column_dh[:-1]
            insert_query = f&#39;insert into {table_scheme}.{table_name} ({str_column_dh}) &#39;
            select_query = select_query[:-1] + f&#39; from {table_scheme}.{table_name_stg}_{customer_code}_{type_file} a &#39;
            query = insert_query + select_query + left_query
            partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
            result_message = self.ps.insert(query,[(table_name)])

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            )
            result_message = str(self.ps.table_count(table_scheme,f&#39;{table_name}_{customer_code}_{type_file}&#39;)) +&#39; &#39; + result_message + &#39; &#39; + table_name
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        return &#39;finished&#39;

    def mastercard_load_exclusion_transaction(self, string_date: str = None,type_file:str=None, hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Load of mastercard excluded transaction
        
        Args:
            string_date (str): date for range condition  
            type_file (str): Type of file
            type_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;mastercard file&#34;,
        &#34;INFO&#34;,
        f&#34;loading exclusion transactions type file : {type_file}&#34;,
        self.module
        ) 

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
        for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_mastercard_exclusion_messages&#39;

            select_query = f&#34;select app_id,app_customer_code,app_type_file,app_hash_file,app_processing_date,source_message_number_id,source_file_id from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date}  where app_message_type = &#39;1644&#39; and function_code =691&#34;
            
            table_tmp = f&#39;tmp_exclusion_transactions_{customer_code}&#39;
            partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
            self.ps.drop_table(table_tmp)
            self.ps.create_table_from_select(select_query,table_tmp)
            result_message = str(self.ps.insert_from_table(&#34;temporal&#34;, table_tmp, table_scheme, table_name))

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        return &#39;finished&#39;
    
    def config_additional_table(self, string_start_date : str = None, string_end_date : str = None, config_table_name : str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the additional tables
        Args:
            string_start_date (str): start date for range condition  
            string_end_date (str): ending date for range condition
            config_table_name (str): name of table to config

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;operational&#39;
        adapter_table_name = &#39;additional_tables_structure&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        list_except_table_type = [&#39;exchange_rate&#39;]
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_table = self.ps.select(adapter_table,&#39; order by table_name,column_order&#39;)
        df_table = pd.DataFrame(list_table)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        table_scheme = &#39;operational&#39;
        for table_name in df_table[&#39;table_name&#39;].drop_duplicates().values:
            columns = []
            table_type = df_table[df_table[&#39;table_name&#39;] == table_name].reset_index(drop=True)[&#39;table_type&#39;][0]
            table_frequency = df_table[df_table[&#39;table_name&#39;] == table_name].reset_index(drop=True)[&#39;table_load_frequency&#39;][0]
            customer_code = self.customer_code
            if config_table_name != None and config_table_name != table_name:
                continue
            columns.extend(column_base)
            for column_name in df_table[df_table[&#39;table_name&#39;] == table_name][&#39;column_name&#39;]:
                df_row = df_table[(df_table[&#39;table_name&#39;] == table_name) &amp; (df_table[&#39;column_name&#39;]== column_name)].reset_index(drop=True)
                columns.append({&#39;column_name&#39;:df_row[&#39;column_name&#39;][0],&#39;length&#39;:df_row[&#39;column_length&#39;][0],&#39;column_type&#39;:df_row[&#39;column_type&#39;][0],&#39;column_decimal&#39;:df_row[&#39;column_decimal&#39;][0]})
            if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):
                if table_type in list_except_table_type:
                    result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_processing_date&#39;,&#39;range&#39;)
                else:
                    result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_customer_code&#39;,&#39;list&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA AND MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
                )
            df_x = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name))
            df_y = pd.DataFrame(columns)
            if len(df_x) != len(df_y):
                list_table_difference = []
                for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                    if not value in (df_x[&#39;column_name&#39;].values):
                        list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
                result_message = self.ps.add_column(list_table_difference,table_scheme,table_name)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA AND MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
                )

            if table_type == &#39;transaction&#39;:
                partition_name = table_name+&#39;_&#39;+customer_code
                message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )

                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
     
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date,table_frequency)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )


                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date,table_frequency)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )


            elif table_type in list_except_table_type:
                partition_name = table_name
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name,table_scheme,partition_name,string_start_date,string_end_date,table_frequency)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                table_type,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
                message_create_table_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
            else:
                partition_name = table_name+&#39;_&#39;+customer_code
                message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_&#39;+table_type,f&#34;&#39;{table_type}&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )      
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_&#39;+table_type,table_scheme,partition_name+&#39;_&#39;+table_type,string_start_date,string_end_date,table_frequency)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )      
        
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_create_table_index),
            self.module
            )   
        return &#39;finished&#39;

    def config_additional_table_others(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the other additional tables
        
        Args:
            string_start_date (str): start date for range condition  
            string_end_date (str): ending date for range condition

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;operational&#39;
        adapter_table_name = &#39;additional_tables_structure&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_table = self.ps.select(adapter_table,&#39; order by table_name,column_order&#39;)
        df_table = pd.DataFrame(list_table)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        table_scheme = &#39;operational&#39;
        for table_name in df_table[&#39;table_name&#39;].drop_duplicates().values:
            columns = []
            columns.extend(column_base)
            for column_name in df_table[df_table[&#39;table_name&#39;] == table_name][&#39;column_name&#39;]:
                df_row = df_table[(df_table[&#39;table_name&#39;] == table_name) &amp; (df_table[&#39;column_name&#39;]== column_name)].reset_index(drop=True)
                columns.append({&#39;column_name&#39;:df_row[&#39;column_name&#39;][0],&#39;length&#39;:str(int(df_row[&#39;column_length&#39;][0])),&#39;column_type&#39;:df_row[&#39;column_type&#39;][0],&#39;column_decimal&#39;:str(int(df_row[&#39;column_decimal&#39;][0]))})
            if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):

                result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_customer_code&#39;,&#39;list&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
                )    

            df_x = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name))
            df_y = pd.DataFrame(columns)
            if len(df_x) != len(df_y):
                list_table_difference = []
                for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                    if not value in (df_x[&#39;column_name&#39;].values):
                        list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
                message_column = self.ps.add_column(list_table_difference,table_scheme,table_name)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_column,
                self.module
                )    


            for customer in list_customer:
                customer_code = customer[&#39;code&#39;]
                partition_name = table_name+&#39;_&#39;+customer_code
                message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )    

                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )    
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )  
                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
                
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )      
       
                message_partition  = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)
        
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )  
        
        
        return &#39;finished&#39;

    def visa_load_calculated_field_dh(self, string_date: str = None, type_file: str = None, hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message

        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)

        log.logs().exist_file(&#34;OPERATIONAL&#34;,self.customer_code,&#34;VISA&#34;,self.log_name,&#34;ADAPTER OF VISA FILE&#34;,&#34;INFO&#34;,f&#34;calculating field {table_scheme}.{table_name}&#34;,self.module)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        
        query_tmp = f&#34;&#34;&#34;
        with ardef_pre_1 as (
            select distinct 
            app_date_valid,
            rpad(left(trim(low_key_for_range),9),16,&#39;0&#39;)::BIGINT low_key_for_range,
            rpad(left(trim(table_key),9),16,&#39;9&#39;)::BIGINT high_key_for_range,
            ardef_country, a.account_funding_source,a.product_id,a.delete_indicator
            ,country issuer_country
            ,technology_indicator
            ,fast_funds
            ,travel_indicator
            ,b2b_program_id
            ,nnss_indicator
            ,product_subtype
            from operational.dh_visa_ardef a
            where app_date_valid&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
            --group by 1,2,3,4,5,6,7
        ), ardef_pre_r as (
            select a.* --app_date_valid,low_key_for_range,high_key_for_range,ardef_country,account_funding_source,product_id,
            ,row_number()over(partition by low_key_for_range order by app_date_valid desc,delete_indicator,high_key_for_range desc) rn
            from ardef_pre_1 a
        )
        select * from ardef_pre_r where rn=1
        &#34;&#34;&#34;
        
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_ardef_unique&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)

        create_message = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        create_message,
        self.module
        )  
        

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        case 
            when right(t.authorization_code, 1) = &#39;x&#39; then &#39;INVALID&#39;
            when right(t.authorization_code, 5) in (&#39;     &#39;,&#39;00000&#39;,&#39;0000 &#39;,&#39;0000n&#39;,&#39;0000p&#39;,&#39;0000y&#39;) then &#39;INVALID&#39;
            else &#39;VALID&#39;
        end authorization_code_valid,
        case 
            when t.app_type_file = &#39;IN&#39; /*and t.transaction_code in (5,6,7,25,26,27)) or (t.app_type_file = &#39;OUT&#39; and t.transaction_code in (15,16,17,35,36,37))*/ then &#39;issuing&#39;
            when t.app_type_file = &#39;OUT&#39; /*and t.transaction_code in (5,6,7,25,26,27)) or (t.app_type_file = &#39;IN&#39; and t.transaction_code in (15,16,17,35,36,37))*/ then &#39;acquiring&#39;
            else t.app_type_file 
        end business_mode,
        case
                when a.ardef_country = trim(t.merchant_country_code) then 
                    case
                        when t.app_type_file = &#39;IN&#39; then 
                            case 
                                when (string_to_array(left(t.account_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_6_digits,&#39;,&#39;) or string_to_array(left(t.account_number::text,8),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_8_digits,&#39;,&#39;)) and upper(t.collection_only_flag) = &#39;C&#39; then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end
                        when t.app_type_file = &#39;OUT&#39; then 
                            case
                                when string_to_array(left(t.account_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.acquiring_bins,&#39;,&#39;) and upper(t.collection_only_flag) = &#39;C&#39; then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end     
                    end
                when a.ardef_country &lt;&gt; trim(t.merchant_country_code) and cra.visa_region_code = crt.visa_region_code then &#39;Intraregional&#39;
                when a.ardef_country &lt;&gt; trim(t.merchant_country_code) and cra.visa_region_code &lt;&gt; crt.visa_region_code then &#39;Interregional&#39;
        end jurisdiction, crt.country_code jurisdiction_country,r.region_code jurisdiction_region
        ,a.ardef_country
        ,t.merchant_country_code
        ,central_processing_date - t.purchase_date timeless
        ,a.account_funding_source funding_source, a.product_id
        ,row_number()over(partition by t.app_id,t.app_hash_file order by a.app_date_valid desc,a.high_key_for_range desc) n
        ,issuer_country
        ,technology_indicator
        ,fast_funds
        ,travel_indicator
        ,b2b_program_id
        ,nnss_indicator
        ,product_subtype
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_ardef_unique a
        on (t.account_number between low_key_for_range and high_key_for_range)
        left join operational.m_country crt
        on (crt.country_code = trim(t.merchant_country_code))
        left join operational.m_country cra
        on (cra.country_code = a.ardef_country)
        left join operational.m_region r
        on (r.region_code = crt.visa_region_code)
        left join control.t_customer c
        on (upper(c.code) = upper(&#39;{customer_code}&#39;))
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_calculated_field_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        query_tmp = f&#34;&#34;&#34;
        select 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,t.destination_amount
        ,t.source_amount
        ,t.destination_currency_code
        ,t.source_currency_code
        ,t.transaction_code
        ,t.merchant_category_code
        ,t.special_condition_indicator_merchant_transaction_indicator
        ,t.transaction_code_qualifier_0
        ,t.usage_code
        ,ex_local.exchange_value exchange_value_local
        ,ex_settl.exchange_value exchange_value_settlement
        ,cus.local_currency_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        left join control.t_customer cus on cus.code = t.app_customer_code
        left join operational.dh_exchange_rate ex_local on 
        (ex_local.app_processing_date = t.app_processing_date and  trim(ex_local.currency_to)=trim(cus.local_currency_code) and 
            ex_local.currency_from_code = case when t.destination_amount &gt; 0 then t.destination_currency_code
                    else t.source_currency_code 
                    end
        and ex_local.brand=&#39;VISA&#39;)
        left join operational.dh_exchange_rate ex_settl on 
        (ex_settl.app_processing_date = t.app_processing_date and  trim(ex_settl.currency_to)=trim(cus.settlement_currency_code) and 
            ex_settl.currency_from_code = case when t.destination_amount &gt; 0 then t.destination_currency_code
                    else t.source_currency_code 
                    end
        and ex_settl.brand=&#39;VISA&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sfc_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        case t.app_type_file
            when &#39;IN&#39; then
                case 
                    when transaction_code in (&#39;05&#39;,&#39;15&#39;,&#39;25&#39;,&#39;35&#39;) then 
                        case         
                            when special_condition_indicator_merchant_transaction_indicator in (&#39;7&#39;,&#39;8&#39;) then 3
                            when special_condition_indicator_merchant_transaction_indicator not in (&#39;7&#39;,&#39;8&#39;) then 1
                            else 255
                        end
                    when transaction_code in (&#39;07&#39;,&#39;17&#39;,&#39;27&#39;,&#39;37&#39;) then 
                        case 
                            when merchant_category_code in (6010) then 21 --MANUAL CASH
                            when merchant_category_code in (6011) then 22 -- ATM
                            else 255
                        end 
                    when transaction_code in (&#39;06&#39;,&#39;16&#39;,&#39;26&#39;,&#39;36&#39;) then 
                        case
                            when special_condition_indicator_merchant_transaction_indicator is not null and special_condition_indicator_merchant_transaction_indicator not in (&#39;8&#39;) and transaction_code_qualifier_0 = 0 then 19
                            when special_condition_indicator_merchant_transaction_indicator is null and transaction_code_qualifier_0 = 0 then 20
                            when special_condition_indicator_merchant_transaction_indicator in (&#39;8&#39;) and transaction_code_qualifier_0 = 0 then 20
                            when special_condition_indicator_merchant_transaction_indicator is not null and special_condition_indicator_merchant_transaction_indicator not in (&#39;8&#39;) and transaction_code_qualifier_0 = 2 then 25
                            when special_condition_indicator_merchant_transaction_indicator is null and transaction_code_qualifier_0 = 2 then 25
                            when special_condition_indicator_merchant_transaction_indicator in (&#39;8&#39;) and transaction_code_qualifier_0 = 2 then 25
                            else 255
                        end
                    else 255
                end
            when &#39;OUT&#39; then
                case 
                    when transaction_code in (&#39;05&#39;,&#39;15&#39;,&#39;25&#39;,&#39;35&#39;) then 
                        case         
                            when merchant_category_code not in (4829, 6051, 7995) then 1 -- purchase 1
                            when merchant_category_code in (4829, 6051, 7995) then 3 -- quasi cash
                            else 255
                        end
                    when transaction_code in (&#39;07&#39;,&#39;17&#39;,&#39;27&#39;,&#39;37&#39;) then 
                        case 
                            when merchant_category_code  in (6010) then 21 --MANUAL CASH
                            when merchant_category_code  in (6011) then 22 -- ATM
                            else 255
                        end 
                    when transaction_code in (&#39;06&#39;,&#39;16&#39;,&#39;26&#39;,&#39;36&#39;) then 
                        case        
                            when merchant_category_code not in (4829, 6051, 7995) and transaction_code_qualifier_0 = 0 then 19
                            when merchant_category_code in (4829, 6051, 7995) and transaction_code_qualifier_0 = 0 then 20  -- purchase 1
                            when merchant_category_code not in (4829, 6051, 7995) and transaction_code_qualifier_0 &lt;&gt; 0 then 25  -- purchase 1
                            else 255
                        end
                    else 255
                end
        end business_transaction_type
        ,case
            when transaction_code in(&#39;05&#39;,&#39;06&#39;,&#39;07&#39;) then 
                case
                    when usage_code = 1 then 11
                    when usage_code = 2 then 23
                    when usage_code = 9 then 6
                    else 255
                end
            when transaction_code in (&#39;15&#39;,&#39;16&#39;,&#39;17&#39;,&#39;35&#39;,&#39;36&#39;,&#39;37&#39;) then
                case
                    when usage_code = 1 then 1
                    when usage_code = 9 then 4
                    else 255
                end
            when transaction_code in (&#39;25&#39;,&#39;26&#39;,&#39;27&#39;) then
                case
                    when usage_code = 1 then 11 -- reversal must be 1
                    when usage_code = 9 then 6  --reversal must be 1
                    when usage_code = 2 then 25
                    else 255
                end 
            else 255
        end business_transaction_cycle
        ,case when transaction_code::integer &gt;= 20 and transaction_code::integer&lt;30 and usage_code in (1,9) then 1 else 0
        end reversal_indicator
        ,case 
            when dhvtc.jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                round(case 
                        when t.exchange_value_local is null then
                            case 
                                when t.destination_amount &gt; 0  and t.destination_currency_code = cast(cur.currency_numeric_code as varchar(4)) then t.destination_amount 
                                else 
                                    case 
                                        when t.source_currency_code = cast(cur.currency_numeric_code as varchar(4)) then source_amount 
                                        else null
                                    end
                            end
                        else
                            case 
                                when t.destination_amount &gt; 0 then t.destination_amount * t.exchange_value_local 
                                else source_amount * t.exchange_value_local 
                            end
                    end::numeric,2)
            when dhvtc.jurisdiction not in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                round(case
                        when t.exchange_value_settlement is null then
                            case 
                                when t.destination_amount &gt; 0  and t.destination_currency_code = cast(cur.currency_numeric_code as varchar(4)) then t.destination_amount 
                                else 
                                    case 
                                        when t.source_currency_code = cast(cur.currency_numeric_code as varchar(4)) then source_amount 
                                        else null
                                    end
                            end
                        else
                            case 
                                when t.destination_amount &gt; 0 then t.destination_amount * t.exchange_value_settlement 
                                else source_amount * t.exchange_value_settlement 
                            end
                    end::numeric,2)
        end settlement_report_amount
        ,t.local_currency_code settlement_report_currency_code
        from {table_tmp} t
        inner join temporal.{customer_code}_{type_file}_visa_calculated_field_pre dhvtc 
        on (dhvtc.app_id = t.app_id and dhvtc.app_hash_file = t.app_hash_file)
        left join operational.m_currency cur on cur.currency_alphabetic_code = t.local_currency_code
        where dhvtc.n = 1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sfc_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        tp.authorization_code_valid,tp.business_mode,lower(tp.jurisdiction) jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.timeless,tp.funding_source,tp.product_id
        ,tp.ardef_country
        ,tp1.reversal_indicator
        ,tp1.business_transaction_type
        ,tp1.business_transaction_cycle
        ,case lower(tp.jurisdiction) when &#39;intraregional&#39; then tp.jurisdiction_region::text
            when &#39;interregional&#39; then &#39;9&#39;
            else tp.jurisdiction_country::text
        end jurisdiction_assigned
        ,tp.issuer_country
        ,tp.technology_indicator
        ,tp.fast_funds
        ,tp.travel_indicator
        ,tp.b2b_program_id
        ,tp.nnss_indicator
        ,tp.product_subtype
        ,tp1.settlement_report_amount
        ,tp1.settlement_report_currency_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_calculated_field_pre tp
        on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sfc_field tp1
        on (t.app_id = tp1.app_id and t.app_hash_file = tp1.app_hash_file)
        where tp.n = 1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )
        print(f&#34;Debug is {self.debug}&#34;)
        if self.debug == &#39;False&#39;:
            
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def mastercard_load_calculated_field_dh(self, string_date: str = None, type_file: str = None, hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from mastercard
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        
        query_tmp = f&#34;&#34;&#34;
        with iar_pre_1 as (
            select 
            to_date(a.effective_timestamp,&#39;yyddd24H&#39;) effective_date, to_date(to_char(a.app_date_valid::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;) app_date_valid, 
            to_date(to_char(a.app_date_end::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;) app_date_end, 
            left(a.low_range::varchar,18)::numeric low_key_for_range,
            left(a.high_range::varchar,18)::numeric high_key_for_range,
            a.card_country_alpha iar_country, 
            a.card_program_priority::numeric card_program_priority,
            a.card_program_identifier
            ,b.gcms_product_id gcms_product_identifier
            ,b.product_category funding_source
            from operational.dh_mastercard_iar a 
            left join operational.m_mastercard_brand_product b
            on (b.licensed_product_id=a.licensed_product_id and b.active_inactive_code=&#39;A&#39;)
            where to_date(to_char(a.app_date_valid::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;)&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
            and a.active_inactive_code=&#39;A&#39;
        ), bin_pre_2 as (
            select a.* 
            ,row_number()over(partition by low_key_for_range order by app_date_valid desc,card_program_priority) rn
            from iar_pre_1 a
        )
        select 
        app_date_valid,low_key_for_range::numeric low_key_for_range,high_key_for_range::numeric high_key_for_range,iar_country,gcms_product_identifier,funding_source,card_program_identifier
        from bin_pre_2 a
        where rn=1
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_iar_unique&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        
        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date,
        a.&#34;settlement_indicator_1&#34; settlement_indicator,
        left(rpad(pan::varchar,18,&#39;0&#39;),18)::numeric num_card, 
        a.&#34;date_and_time_local_transaction&#34; purchase_date,
        right(a.&#34;card_acceptor_namelocation&#34;,3) card_purchase_country, 
        b.&#34;mastercard_region_code&#34; card_purchase_region
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
        left join operational.m_country b
        on b.&#34;country_code_alternative&#34; = right(a.&#34;card_acceptor_namelocation&#34;,3)
        where a.app_message_type in (&#39;1240&#39;,&#39;1442&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_index = self.ps.create_table_index(table_scheme_tmp,table_name_tmp,f&#39;{customer_code}_{type_file}_mccf_pre_idx&#39;,&#39;num_card&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_index,
        self.module
        )  


        query_tmp = f&#34;&#34;&#34;
        select 
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date,
        case 
            when a.app_type_file = &#39;IN&#39;  then &#39;issuing&#39;
            when a.app_type_file = &#39;OUT&#39; then &#39;acquiring&#39;
            else a.app_type_file 
        end business_mode
        ,case
            when a.card_purchase_country = b.iar_country then
                case 
                    when a.settlement_indicator = &#39;C&#39; then &#39;on-us&#39;
                    when a.settlement_indicator = &#39;M&#39; then &#39;off-us&#39;
                end
            when a.card_purchase_country &lt;&gt; b.iar_country and bc.mastercard_region_code = ac.mastercard_region_code then &#39;Intraregional&#39;
            when a.card_purchase_country &lt;&gt; b.iar_country and bc.mastercard_region_code &lt;&gt; ac.mastercard_region_code then &#39;Interregional&#39;
            end jurisdiction, bc.country_code jurisdiction_country,r.region_code::text jurisdiction_region
        ,row_number()over(partition by a.app_id,a.app_hash_file order by b.app_date_valid desc,b.high_key_for_range desc) n
        ,b.*
        from {table_tmp} a
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_iar_unique b
        on a.num_card &gt;= b.low_key_for_range and a.num_card &lt;= b.high_key_for_range
        left join operational.m_country ac
        on (ac.country_code_alternative = a.card_purchase_country)
        left join operational.m_country bc
        on (bc.country_code_alternative = b.iar_country)
        left join operational.m_region r
        on (r.region_code = bc.mastercard_region_code)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_pre_2&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp= f&#34;&#34;&#34;
        select 
        t.app_id,t.app_hash_file
        ,t.app_type_file
        ,t.amount_reconciliation
        ,t.amount_transaction
        ,t.currency_code_transaction
        ,t.currency_code_reconciliation
        ,t.app_message_type
        ,ex_local.exchange_value exchange_value_local
        ,ex_settl.exchange_value exchange_value_settlement
        ,cus.local_currency_code
        ,cus.settlement_currency_code
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
        left join control.t_customer cus on cus.code = t.app_customer_code
        left join operational.dh_exchange_rate ex_local on 
        (ex_local.app_processing_date = t.app_processing_date and  trim(ex_local.currency_to)=trim(cus.local_currency_code) and 
            ex_local.currency_from_code = case when t.app_type_file != &#39;IN&#39; then t.currency_code_transaction::text end
        and ex_local.brand=&#39;MasterCard&#39;)
        left join operational.dh_exchange_rate ex_settl on 
        (ex_settl.app_processing_date = t.app_processing_date and  trim(ex_settl.currency_to)=trim(cus.settlement_currency_code) and 
            ex_settl.currency_from_code = case when t.app_type_file != &#39;IN&#39; then t.currency_code_transaction::text end
        and ex_settl.brand=&#39;MasterCard&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_ex_rate&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        
        query_tmp= f&#34;&#34;&#34;
        select app_hash_file,file_id
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date}
        where app_message_type = &#39;1644&#39; and function_code = 697
        group by 1,2
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_fi&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select 
        de.app_id,de.app_hash_file
        ,case 
            when de.app_type_file = &#39;IN&#39; then f_currency_reconcilation.currency_alphabetic_code::text
            else
                case 
                    when jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then de.local_currency_code::text 
                    else de.settlement_currency_code::text
                end    
        end as settlement_report_currency_code,
        round(
        case 
            when de.app_type_file = &#39;IN&#39; then  amount_reconciliation 
            else 
                case
                    when jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                        case 
                            when f_currency.currency_alphabetic_code = local_currency_code then amount_transaction
                            when de.exchange_value_local is not null then  amount_transaction *  de.exchange_value_local
                        end
                    else
                        case
                            when f_currency.currency_alphabetic_code = de.settlement_currency_code then amount_transaction
                            when de.exchange_value_settlement is not null then  amount_transaction *  de.exchange_value_settlement
                        end
                end
        end::numeric,2) as settlement_report_amount
        ,fi.file_id mc_file_id
        from {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_ex_rate de 
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_fi fi on (fi.app_hash_file = de.app_hash_file)
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_pre_2 cf on cf.app_id = de.app_id and cf.app_hash_file = de.app_hash_file
        left join operational.m_currency f_currency on f_currency.currency_numeric_code = currency_code_transaction 
        left join operational.m_currency f_currency_reconcilation on f_currency_reconcilation.currency_numeric_code = currency_code_reconciliation
        where  (de.app_message_type = &#39;1240&#39; or de.app_message_type=&#39;1422&#39;)
        and cf.n=1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_amount&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        tp.business_mode,tp.jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.funding_source,
        tp.gcms_product_identifier,
        tp.card_program_identifier,
        case tp.jurisdiction when &#39;Intraregional&#39; then tp.jurisdiction_region
            when &#39;Interregional&#39; then &#39;9&#39;
            else tp.jurisdiction_country
        end jurisdiction_assigned,
        tp1.settlement_report_currency_code,tp1.settlement_report_amount,tp1.mc_file_id
        ,tp.iar_country
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_pre_2 tp
        on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
        left join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_amount tp1
        on (tp1.app_id = t.app_id and tp1.app_hash_file = t.app_hash_file)
        where tp.n=1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        message_insert = self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_insert,
        self.module
        )  
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )

        return &#39;finished&#39;
    
    def visa_load_sms_calculated_field_dh(self, string_date: str = None,type_file: str = None,hash_file: str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa sms
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_sms_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading sms calculated field dh&#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )   

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        
        query_tmp = f&#34;&#34;&#34;
        with ardef_pre_1 as (
            select distinct 
            app_date_valid,
            rpad(left(trim(low_key_for_range),9),19,&#39;0&#39;)::numeric low_key_for_range,
            rpad(left(trim(table_key),9),19,&#39;9&#39;)::numeric high_key_for_range,
            ardef_country, a.account_funding_source,a.product_id,a.delete_indicator
            ,country issuer_country
            ,technology_indicator
            ,fast_funds
            ,travel_indicator
            ,b2b_program_id
            ,nnss_indicator
            ,product_subtype
            from operational.dh_visa_ardef a
            where app_date_valid&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
            --group by 1,2,3,4,5,6,7
        ), ardef_pre_r as (
            select a.* --app_date_valid,low_key_for_range,high_key_for_range,ardef_country,account_funding_source,product_id,
            ,row_number()over(partition by low_key_for_range order by app_date_valid desc,delete_indicator,high_key_for_range desc) rn
            from ardef_pre_1 a
        )
        select * from ardef_pre_r where rn=1
        &#34;&#34;&#34;
        
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_ardef_unique&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,t.request_message_type
        ,case 
            when response_code = &#39;00&#39; and settlement_amount &lt;&gt; 0 then --Transaccion aceptada y procesada, excepto autorizacion, etc.
                case 
                    when left(processing_code,2) in (&#39;00&#39;,&#39;20&#39;,&#39;26&#39;,&#39;11&#39;) then --Purchase / Credit Voucher
                        case 
                            when request_message_type in (&#39;0420&#39;) then 1 
                            else 0
                        end 
                    when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;,&#39;10&#39;) then --Cash / Adjustment
                        case 
                            when request_message_type in (&#39;0420&#39;) then 1 
                            else 0
                        end
                end
        END as reversal_indicator,
        case 
            when response_code = &#39;00&#39; and settlement_amount &lt;&gt; 0 then --Transaccion aceptada y procesada, excepto autorizacion, etc.
                case 
                    when left(processing_code,2) in (&#39;00&#39;) then 1 --Purchase
                    when left(processing_code,2) in (&#39;20&#39;) then 19 --Credit Voucher
                    when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;) then 22 --Cash / Adjustment
                    --when left(processing_code,2) in (&#39;30&#39;) then 247 --Balance Inquiry
                    when left(processing_code,2) in (&#39;10&#39;) then 30 -- Account Funding
                    when left(processing_code,2) in (&#39;11&#39;) then 3 -- Quasi-cash
                    when left(processing_code,2) in (&#39;19&#39;) then 115 -- Fee Collection
                    when left(processing_code,2) in (&#39;26&#39;) then 25  -- Original Credit
                    when left(processing_code,2) in (&#39;29&#39;) then 200 -- Funds Disbursement
                    when left(processing_code,2) in (&#39;40&#39;) then 250 -- CardHolder Account Transfer
                    when left(processing_code,2) in (&#39;50&#39;) then 27  -- Payment / Bill Payment (US ONLY)    
                end
            when response_code = &#39;00&#39; and settlement_amount = 0 then
                case 
                    when left(processing_code,2) in (&#39;30&#39;) then 247 
                end
            when response_code &lt;&gt; &#39;00&#39; and settlement_amount = 0 then
                case 
                    when left(processing_code,2) in (&#39;00&#39;) then 236 --Purchase
                    when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;,&#39;30&#39;) then 249 --Cash / Adjustment
                end
        end as business_transaction_type
        ,case 
            when response_code IN (&#39;00&#39;) AND settlement_amount &lt;&gt; 0 then 
                case 
                    when request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;01&#39;) THEN 4 -- Cash Dispute
                    WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;01&#39;) THEN 6 -- Cash Dispute Response
                    WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;02&#39;) THEN 4 -- Debit Adjustment Dispute
                    WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;02&#39;) THEN 7 -- Debit Adjustment
                    WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;22&#39;) THEN 4 -- Credit Adjustment Dispute
                    WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;22&#39;) THEN 5 -- Credit Adjustment                                 
                    WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;00&#39;,&#39;20&#39;) THEN 4 -- Dispute / Response for Purchase and Credit Voucher
                    WHEN request_message_type IN (&#39;0200&#39;,&#39;0220&#39;,&#39;0400&#39;,&#39;0420&#39;)  THEN 11 -- Original 
                end
            WHEN response_code NOT IN (&#39;00&#39;) AND settlement_amount = 0 THEN 100  -- Transacciones sin ciclo 
        end as business_transaction_cycle
        ,case 
            when right(t.authorization_id_resp_code, 1) = &#39;x&#39; then &#39;invalid&#39;
            when right(t.authorization_id_resp_code, 5) in (&#39;     &#39;,&#39;00000&#39;,&#39;0000 &#39;,&#39;0000n&#39;,&#39;0000p&#39;,&#39;0000y&#39;) then &#39;invalid&#39;
            else &#39;valid&#39;
        end authorization_code_valid,
        case upper(t.issuer_acquirer_indicator)
            when &#39;A&#39; then &#39;acquiring&#39;
            when &#39;I&#39; then &#39;issuing&#39;
        end business_mode,
        case
                when a.ardef_country = trim(t.card_acceptor_country) then 
                    case upper(t.issuer_acquirer_indicator)
                        when &#39;A&#39; then
                            case
                                when string_to_array(left(t.card_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.acquiring_bins,&#39;,&#39;) then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end
                        when &#39;I&#39; then 
                            case 
                                when (string_to_array(left(t.card_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_6_digits,&#39;,&#39;) or string_to_array(left(t.card_number::text,8),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_8_digits,&#39;,&#39;)) then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end
                    end
                when a.ardef_country &lt;&gt; trim(t.card_acceptor_country) and cra.visa_region_code = crt.visa_region_code then &#39;Intraregional&#39;
                when a.ardef_country &lt;&gt; trim(t.card_acceptor_country) and cra.visa_region_code &lt;&gt; crt.visa_region_code then &#39;Interregional&#39;
        end jurisdiction, crt.country_code jurisdiction_country,r.region_code jurisdiction_region
        ,a.ardef_country
        ,t.card_acceptor_country
        ,vss_processing_date - t.local_transaction_date timeless
        ,a.account_funding_source funding_source, a.product_id
        ,row_number()over(partition by t.app_id,t.app_hash_file order by a.app_date_valid desc,a.high_key_for_range desc) n
        ,issuer_country
        ,technology_indicator
        ,fast_funds
        ,travel_indicator
        ,b2b_program_id
        ,nnss_indicator
        ,product_subtype
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sms_ardef_unique a
        on (t.card_number between low_key_for_range and high_key_for_range)
        left join operational.m_country crt
        on (crt.country_code = trim(t.card_acceptor_country))
        left join operational.m_country cra
        on (cra.country_code = a.ardef_country)
        left join operational.m_region r
        on (r.region_code = crt.visa_region_code)
        left join control.t_customer c
        on (upper(c.code) = upper(&#39;{customer_code}&#39;))
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create= self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        t.*
        ,case 
            when request_message_type in (&#39;0200&#39;, &#39;0220&#39;, &#39;0420&#39;) and (business_transaction_cycle not in (4,6) or business_transaction_cycle is null) 
                then case 
                        when reversal_indicator = 0
                            then case 
                                    when business_transaction_type in (1,3) then &#39;05&#39;
                                    when business_transaction_type in (19,25) then &#39;06&#39;
                                    when business_transaction_type in (22,30) then &#39;07&#39;
                                end
                        when reversal_indicator = 1
                            then case  
                                    when business_transaction_type in (1,3) then &#39;25&#39;
                                    when business_transaction_type in (19,25) then &#39;26&#39;
                                    when business_transaction_type in (22,30) then &#39;27&#39;
                                end
                    end
        end transaction_code_sms
        from {table_tmp} t
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field_pre_2&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create= self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA SMS file&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        tp.authorization_code_valid,tp.business_mode,lower(tp.jurisdiction) jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.timeless,tp.funding_source,tp.product_id
        ,tp.ardef_country
        ,tp.reversal_indicator
        ,tp.business_transaction_type
        ,tp.business_transaction_cycle
        ,tp.transaction_code_sms
        ,case lower(tp.jurisdiction) when &#39;intraregional&#39; then tp.jurisdiction_region::text
            when &#39;interregional&#39; then &#39;9&#39;
            else tp.jurisdiction_country::text
        end jurisdiction_assigned
        ,tp.issuer_country
        ,tp.technology_indicator
        ,tp.fast_funds
        ,tp.travel_indicator
        ,tp.b2b_program_id
        ,tp.nnss_indicator
        ,tp.product_subtype
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sms_calculated_field_pre_2 tp
        on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
        where tp.n = 1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def visa_load_vss_110_calculated_field_dh(self, string_date: str = None,type_file:str = None, hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 110
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)


        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 110 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )   

        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_110 rollup_group
        from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_110 &lt;&gt; reporting_for_sre_identifier_110
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
            from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_110 &lt;&gt; reporting_for_sre_identifier_110
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,110 report_type
        ,case 
            when a.rollup_to_sre_identifier_110 = a.reporting_for_sre_identifier_110 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_110_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  


        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def visa_load_vss_120_calculated_field_dh(self, string_date: str = None,type_file:str = None,hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 120
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 120 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )


        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_120 rollup_group
        from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_120 &lt;&gt; reporting_for_sre_identifier_120
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
            from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_120 &lt;&gt; reporting_for_sre_identifier_120
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,120 report_type
        ,case 
            when a.rollup_to_sre_identifier_120 = a.reporting_for_sre_identifier_120 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_120_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        
        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def visa_load_vss_130_calculated_field_dh(self, string_date: str = None,type_file:str = None,hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 130
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        number_file = &#39;1&#39;
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 130 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_130 rollup_group
        from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_130 &lt;&gt; reporting_for_sre_identifier_130
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
            from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_130 &lt;&gt; reporting_for_sre_identifier_130
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,130 report_type
        ,case 
            when a.rollup_to_sre_identifier_130 = a.reporting_for_sre_identifier_130 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_130_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    
    def visa_load_vss_140_calculated_field_dh(self, string_date: str = None,type_file:str=None,hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 140

        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        number_file = &#39;1&#39;
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)


        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 140 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )


        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_140 rollup_group
        from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_140 &lt;&gt; reporting_for_sre_identifier_140
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
            from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_140 &lt;&gt; reporting_for_sre_identifier_140
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,140 report_type
        ,case 
            when a.rollup_to_sre_identifier_140 = a.reporting_for_sre_identifier_140 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_140_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    
    def load_mastercard_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
        &#34;&#34;&#34;Mastercard exchange charge per adapter
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file
            number_file (str): number of file in sequence

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard_interchange&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        str_currency = &#39;&#39;
        str_condition_currency = &#39;&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading mastercard interchange&#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )   
        table_rules = self.ps.select(&#39;operational.m_interchange_rules_mc&#39;,&#39;where amount_transaction_currency is not null group by 1&#39;,&#39;amount_transaction_currency&#39;)
        if len(table_rules)&gt;0:
            for rules in table_rules:
                str_currency += f&#34;,coalesce((t.amount_transaction*case when cu.currency_alphabetic_code = &#39;{rules[&#39;amount_transaction_currency&#39;]}&#39; then 1 else ex_{rules[&#39;amount_transaction_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) amount_transaction_{rules[&#39;amount_transaction_currency&#39;]} &#34;
                str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;amount_transaction_currency&#39;]} on (ex_{rules[&#39;amount_transaction_currency&#39;]}.app_processing_date=to_date(to_char(t.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) and ex_{rules[&#39;amount_transaction_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;amount_transaction_currency&#39;]}.currency_to=&#39;{rules[&#39;amount_transaction_currency&#39;]}&#39; and ex_{rules[&#39;amount_transaction_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

        query_tmp = f&#34;&#34;&#34;
        SELECT 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,coalesce(tcf.jurisdiction_assigned::text,&#39;BLANK&#39;) jurisdiction
        ,coalesce(trim(t.business_activity_4)::text,&#39;BLANK&#39;) ird
        ,coalesce(trim(left(t.processing_code,2)),&#39;BLANK&#39;) processing_code
        ,coalesce(t.amount_transaction::text,&#39;BLANK&#39;) amount_transaction
        ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) amount_transaction_currency
        {str_currency}
        ,coalesce(t.card_acceptor_business_code_mcc::text,&#39;BLANK&#39;) card_acceptor_business_code
        ,coalesce(trim(tcf.gcms_product_identifier)::text,&#39;BLANK&#39;) gcms_product_identifier
        ,coalesce(trim(tcf.funding_source),&#39;BLANK&#39;) funding_source
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
        inner join operational.dh_mastercard_calculated_field_{customer_code}_{type_file}_{string_date} tcf
        on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
        left join operational.m_currency cu
        on (cu.currency_numeric_code = t.currency_code_transaction::int)
        {str_condition_currency}
        where t.app_hash_file=&#39;{hash_file}&#39;
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_interchange_eval&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        table_name_tmp = self.mastercard_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
        if table_name_tmp == &#39;-1&#39;:
            if self.debug == &#39;False&#39;:
                bulk_delete = ps_block.query_block()
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    customer_code,
                    &#34;MASTERCARD&#34;,
                    self.log_name,
                    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
                    &#34;INFO&#34;,
                    bulk_delete,
                    self.module
                )
            return &#39;finished&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        ps_block.drop_table(table_tmp)
        query_tmp = f&#34;&#34;&#34;
        with tmp_pre as
        (
        select to_date(to_char(a.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) date_and_time_local_transaction,a.currency_code_transaction::numeric currency_code_transaction
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
        group by 1,2
        )
        select *
        from operational.dh_exchange_rate er
        where (er.app_processing_date,er.currency_from_code::numeric) in (select date_and_time_local_transaction,currency_code_transaction from tmp_pre)
        and er.brand=&#39;MasterCard&#39;
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_ex_rate&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,a.amount_transaction
        ,a.currency_code_transaction currency_transaction
        ,c.rate_currency
        ,c.rate_variable::numeric
        ,c.rate_fixed::numeric
        ,c.rate_min::numeric
        ,c.rate_cap::numeric
        ,case
            when c.rate_variable is null then rate_fixed::numeric
            when not operational.isnumeric(c.rate_variable) then null
            else
                case
                    when (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0) &lt;= rate_min then rate_min::numeric
                    when (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0) &gt;= rate_cap then rate_cap::numeric
                    else (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0)
                end
        end calculated_value,
        e.intelica_id::numeric,
        e.region_country_code,
        e.ird
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
        inner join temporal.{customer_code}_{type_file}_{number_file}_mastercard_interchange_eval_assign e
        on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
        inner join operational.m_interchange_rules_mc c
        on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code and c.ird = e.ird 
        and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
        left join operational.m_currency cur on cur.currency_numeric_code = a.currency_code_transaction::numeric
        left join {table_tmp} er
        on (er.date=to_date(to_char(a.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) and er.currency_from_code::numeric=a.currency_code_transaction::numeric and er.currency_to=c.rate_currency and lower(er.brand)=&#39;mastercard&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_interchange&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        message_insert = self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_insert,
        self.module
        )  

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )

        return &#39;finished&#39;
    
    def load_visa_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
        &#34;&#34;&#34;Visa exchange charge per adapter
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file
            number_file (str): number of file in sequence

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_interchange&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        str_currency = &#39;&#39;
        str_condition_currency = &#39;&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading visa interchange &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        table_rules = self.ps.select(&#39;operational.m_interchange_rules_visa&#39;,&#39;where transaction_amount_currency is not null group by 1&#39;,&#39;transaction_amount_currency&#39;)
        if len(table_rules)&gt;0:
            for rules in table_rules:
                str_currency += f&#34;,coalesce((t.source_amount*case when cu.currency_alphabetic_code = &#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; then 1 else ex_{rules[&#39;transaction_amount_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) transaction_amount_{rules[&#39;transaction_amount_currency&#39;]} &#34;
                str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;transaction_amount_currency&#39;]} on (ex_{rules[&#39;transaction_amount_currency&#39;]}.app_processing_date=t.purchase_date and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_to=&#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; and ex_{rules[&#39;transaction_amount_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

        query_tmp = f&#34;&#34;&#34;
        SELECT 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,coalesce(upper(tcf.jurisdiction_assigned)::text,&#39;BLANK&#39;) jurisdiction
        ,coalesce(upper(tcf.business_mode)::text,&#39;BLANK&#39;) business_mode,
        coalesce(tcf.issuer_country::text,&#39;BLANK&#39;) issuer_country,
        coalesce(c.visa_region_code::text,&#39;BLANK&#39;) issuer_region
        ,coalesce(tcf.technology_indicator::text,&#39;BLANK&#39;)technology_indicator
        ,coalesce(tcf.product_id::text,&#39;BLANK&#39;)product_id
        ,coalesce(tcf.fast_funds::text,&#39;BLANK&#39;)fast_funds
        ,coalesce(tcf.travel_indicator::text,&#39;BLANK&#39;)travel_indicator
        ,coalesce(tcf.b2b_program_id::text,&#39;BLANK&#39;)b2b_program_id
        ,coalesce(tcf.funding_source::text,&#39;BLANK&#39;) account_funding_source
        ,coalesce(tcf.nnss_indicator::text,&#39;BLANK&#39;)nnss_indicator
        ,coalesce(tcf.product_subtype::text,&#39;BLANK&#39;)product_subtype
        ,coalesce(right(lpad(t.transaction_code::text,2,&#39;0&#39;),2),&#39;BLANK&#39;) transaction_code
        ,coalesce(t.transaction_code_qualifier_0::text,&#39;BLANK&#39;) transaction_code_qualifier
        ,coalesce(t.account_number::text,&#39;BLANK&#39;) payment_credential_combination
        ,coalesce(t.account_reference_number_acquiring_identifier::text,&#39;BLANK&#39;) acquiring_identifier
        ,coalesce(t.source_amount::text,&#39;BLANK&#39;) transaction_amount
        {str_currency}
        ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) transaction_amount_currency
        ,coalesce(t.merchant_country_code::text,&#39;BLANK&#39;) acquirer_country
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) acquirer_region
        ,coalesce(t.merchant_country_code::text,&#39;BLANK&#39;)merchant_country_code
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) merchant_country_region
        ,coalesce(t.merchant_category_code::text,&#39;BLANK&#39;)merchant_category_code
        ,coalesce(t.requested_payment_service::text,&#39;BLANK&#39;)requested_payment_service
        ,coalesce(t.usage_code::text,&#39;BLANK&#39;)usage_code
        ,coalesce(t.authorization_characteristics_indicator::text,&#39;BLANK&#39;)authorization_characteristics_indicator
        ,coalesce(tcf.authorization_code_valid::text,&#39;BLANK&#39;) authorization_code
        ,coalesce(t.pos_terminal_capacity::text,&#39;BLANK&#39;) pos_terminal_capability
        ,coalesce(t.cardholder_id_method::text,&#39;BLANK&#39;)cardholder_id_method
        ,coalesce(t.pos_entry_mode::text,&#39;BLANK&#39;)pos_entry_mode
        ,coalesce(tcf.timeless::text,&#39;BLANK&#39;) timeliness
        ,coalesce(t.reimbursement_attribute::text,&#39;BLANK&#39;)reimbursement_attribute
        ,coalesce(t.special_condition_indicator_merchant_transaction_indicator::text,&#39;BLANK&#39;) special_condition_indicator
        ,coalesce(t.fee_program_indicator::text,&#39;BLANK&#39;)fee_program_indicator
        ,&#39;BLANK&#39; processing_code
        ,coalesce(t.motoec_indicator::text,&#39;BLANK&#39;) moto_eci_indicator
        ,coalesce(t.acceptance_terminal_indicator::text,&#39;BLANK&#39;)acceptance_terminal_indicator
        ,coalesce(t.prepaid_card_indicator::text,&#39;BLANK&#39;)prepaid_card_indicator
        ,coalesce(t.pos_environment::text,&#39;BLANK&#39;) pos_environment_code
        ,coalesce(case
            when business_format_code_sp = &#39;SP&#39; then business_format_code_sp
            when business_format_code_sd = &#39;SD&#39; then business_format_code_sd
            when business_format_code_pd = &#39;PD&#39; then business_format_code_pd
            when business_format_code_ft = &#39;FT&#39; then business_format_code_ft
            when business_format_code_fl = &#39;FL&#39; then business_format_code_fl
            when business_format_code_df = &#39;DF&#39; then business_format_code_df
            when business_format_code_cr = &#39;CR&#39; then business_format_code_cr
        end::text,&#39;BLANK&#39;) business_format_code
        ,coalesce(t.business_application_id_cr::text,&#39;BLANK&#39;) business_application_id
        ,coalesce(t.type_of_purchase_fl::text,&#39;BLANK&#39;) type_purchase
        ,coalesce(case 
            when business_format_code_sd = &#39;SD&#39; then network_identification_code_sd
            when business_format_code_df = &#39;DF&#39; then network_identification_code_df
            when business_format_code_sp = &#39;SP&#39; then network_identification_code_sp
        end::text,&#39;BLANK&#39;) network_identification_code
        ,coalesce(case 
            when business_format_code_sd = &#39;SD&#39; then message_reason_code_sd
            when business_format_code_df = &#39;DF&#39; then message_reason_code_df
            when business_format_code_sp = &#39;SP&#39; then message_reason_code_sp
        end::text,&#39;BLANK&#39;) message_reason_code
        ,coalesce(case 
            when business_format_code_sd = &#39;SD&#39; then surcharge_amount_sd
            when business_format_code_sp = &#39;SP&#39; then surcharge_amount_sp
        end::text,&#39;BLANK&#39;) surcharge_amount
        ,coalesce(t.authorized_amount::text,&#39;BLANK&#39;)authorized_amount
        ,coalesce(t.authorization_response_code::text,&#39;BLANK&#39;)authorization_response_code
        ,coalesce(t.validation_code::text,&#39;BLANK&#39;)validation_code
        ,coalesce(t.merchant_verification_value::text,&#39;BLANK&#39;)merchant_verification_value
        ,coalesce(t.dcc_indicator::text,&#39;BLANK&#39;) dynamic_currency_conversion_indicator
        ,coalesce(substr(t.pan_token::text,2,1),&#39;BLANK&#39;) authorization_characteristics_indicator_5
        ,coalesce(t.cvv_result_code::text,&#39;BLANK&#39;) cvv2_result_code
        ,coalesce(t.national_tax_included::text,&#39;BLANK&#39;) national_tax_indicator
        ,coalesce(t.merchant_vat_registration_number::text,&#39;BLANK&#39;) merchant_vat
        ,coalesce(t.summary_commodity_code::text,&#39;BLANK&#39;) summary_commodity
        ,coalesce(t.message_identifier::text,&#39;BLANK&#39;)message_identifier
        ,&#39;BLANK&#39; processing_code_transaction_type
        ,&#39;BLANK&#39; point_of_service_condition_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        inner join operational.dh_visa_transaction_calculated_field_{customer_code}_{type_file}_{string_date} tcf
        on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
        left join operational.m_country c
        on (c.country_code = tcf.issuer_country)
        left join operational.m_country c2
        on (c2.country_code = t.merchant_country_code)
        left join operational.m_currency cu
        on (cu.currency_numeric_code = t.source_currency_code::int)
        {str_condition_currency}
        where t.app_hash_file=&#39;{hash_file}&#39;
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_interchange_eval&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        table_name_tmp = self.visa_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
        if table_name_tmp == &#39;-1&#39;:
            if self.debug == &#39;False&#39;:
                bulk_delete = ps_block.query_block()
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;INTERCHANGE OF VISA FILE&#34;,
                    &#34;INFO&#34;,
                    bulk_delete,
                    self.module
                )
            return &#39;finished&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        ps_block.drop_table(table_tmp)
        query_tmp = f&#34;&#34;&#34;
        with tmp_pre as
        (
        select a.purchase_date,a.source_currency_code::numeric source_currency_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} a
        group by 1,2
        )
        select *
        from operational.dh_exchange_rate er
        where (er.app_processing_date,er.currency_from_code::numeric) in (select purchase_date,source_currency_code from tmp_pre)
        and er.brand=&#39;VISA&#39;
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_ex_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,a.source_amount amount_transaction
        ,a.source_currency_code currency_transaction
        ,c.fee_currency
        ,c.fee_variable::numeric
        ,c.fee_fixed::numeric
        ,c.fee_min::numeric
        ,c.fee_cap::numeric
        ,case
            when c.fee_variable is null then fee_fixed::numeric
            when not operational.isnumeric(c.fee_variable) then null
            else
                case
                    when (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &lt;= fee_min then fee_min::numeric
                    when (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &gt;= fee_cap then fee_cap::numeric
                    else (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0)
                end
        end calculated_value,
        e.intelica_id::numeric
        ,e.region_country_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} a
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_{number_file}_visa_interchange_eval_assign e
        on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
        left join operational.m_interchange_rules_visa c
        on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code
        and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
        left join operational.m_currency cur on cur.currency_numeric_code = a.source_currency_code::numeric
        left join {table_tmp} er
        on (er.date=a.purchase_date and er.currency_from_code::numeric=a.source_currency_code::numeric and er.currency_to=c.fee_currency and lower(er.brand)=&#39;visa&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_interchange&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )   

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;INTERCHANGE OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    
    def load_visa_sms_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
        &#34;&#34;&#34;Visa exchange charge per adapter
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file
            number_file (str): number of file in sequence

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_sms_interchange&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        str_currency = &#39;&#39;
        str_condition_currency = &#39;&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading visa interchange &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        table_rules = self.ps.select(&#39;operational.m_interchange_rules_visa&#39;,&#39;where transaction_amount_currency is not null group by 1&#39;,&#39;transaction_amount_currency&#39;)
        if len(table_rules)&gt;0:
            for rules in table_rules:
                str_currency += f&#34;,coalesce((t.transaction_amount*case when cu.currency_alphabetic_code = &#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; then 1 else ex_{rules[&#39;transaction_amount_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) transaction_amount_{rules[&#39;transaction_amount_currency&#39;]} &#34;
                str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;transaction_amount_currency&#39;]} on (ex_{rules[&#39;transaction_amount_currency&#39;]}.app_processing_date=t.local_transaction_date and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_to=&#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; and ex_{rules[&#39;transaction_amount_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

        query_tmp = f&#34;&#34;&#34;
        SELECT 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,coalesce(upper(tcf.jurisdiction_assigned)::text,&#39;BLANK&#39;) jurisdiction
        ,coalesce(upper(tcf.business_mode)::text,&#39;BLANK&#39;) business_mode,
        coalesce(tcf.issuer_country::text,&#39;BLANK&#39;) issuer_country,
        coalesce(c.visa_region_code::text,&#39;BLANK&#39;) issuer_region
        ,coalesce(tcf.technology_indicator::text,&#39;BLANK&#39;)technology_indicator
        ,coalesce(tcf.product_id::text,&#39;BLANK&#39;)product_id
        ,coalesce(tcf.fast_funds::text,&#39;BLANK&#39;)fast_funds
        ,coalesce(tcf.travel_indicator::text,&#39;BLANK&#39;)travel_indicator
        ,coalesce(tcf.b2b_program_id::text,&#39;BLANK&#39;)b2b_program_id
        ,coalesce(tcf.funding_source::text,&#39;BLANK&#39;) account_funding_source
        ,coalesce(tcf.nnss_indicator::text,&#39;BLANK&#39;)nnss_indicator
        ,coalesce(tcf.product_subtype::text,&#39;BLANK&#39;)product_subtype
        ,coalesce(tcf.transaction_code_sms,&#39;BLANK&#39;) transaction_code
        --,coalesce(t.transaction_code_qualifier_0::text,&#39;BLANK&#39;) transaction_code_qualifier
        --,coalesce(t.account_number::text,&#39;BLANK&#39;) payment_credential_combination
        ,coalesce(t.transaction_amount::text,&#39;BLANK&#39;) transaction_amount
        {str_currency}
        ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) transaction_amount_currency
        ,coalesce(t.card_acceptor_country::text,&#39;BLANK&#39;) acquirer_country
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) acquirer_region
        ,coalesce(t.card_acceptor_country::text,&#39;BLANK&#39;)merchant_country_code
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) merchant_country_region
        ,coalesce(t.merchants_type::text,&#39;BLANK&#39;)merchant_category_code
        ,coalesce(t.requested_payment_service::text,&#39;BLANK&#39;) requested_payment_service
        ,coalesce(t.usage_code_sms::text,&#39;BLANK&#39;)usage_code
        ,coalesce(t.authorization_characteristics_indicator_sms::text,&#39;BLANK&#39;)authorization_characteristics_indicator
        ,coalesce(tcf.authorization_code_valid::text,&#39;BLANK&#39;) authorization_code
        ,coalesce(t.pos_terminal_entry_capability::text,&#39;BLANK&#39;) pos_terminal_capability
        ,coalesce(t.customer_identification_method::text,&#39;BLANK&#39;)cardholder_id_method
        ,coalesce(left(t.pos_entry_mode_sms::text,2),&#39;BLANK&#39;)pos_entry_mode
        ,coalesce(tcf.timeless::text,&#39;BLANK&#39;) timeliness
        ,coalesce(t.reimbursement_attribute_sms::text,&#39;BLANK&#39;)reimbursement_attribute
        ,coalesce(t.chargeback_special_condition_merchant_indicator::text,&#39;BLANK&#39;) special_condition_indicator
        ,coalesce(t.fee_program_indicator_sms::text,&#39;BLANK&#39;)fee_program_indicator
        --,&#39;BLANK&#39; processing_code
        ,coalesce(t.mailtelephone_or_electronic_commerce_indicator::text,&#39;BLANK&#39;) moto_eci_indicator
        ,coalesce(right(t.pos_terminal_type,1)::text,&#39;BLANK&#39;)acceptance_terminal_indicator
        --,coalesce(t.prepaid_card_indicator::text,&#39;BLANK&#39;)prepaid_card_indicator
        ,coalesce(t.recurring_payment_indicator_flag::text,&#39;BLANK&#39;) pos_environment_code
        /*,coalesce(case
            when business_format_code_sp = &#39;SP&#39; then business_format_code_sp
            when business_format_code_sd = &#39;SD&#39; then business_format_code_sd
            when business_format_code_pd = &#39;PD&#39; then business_format_code_pd
            when business_format_code_ft = &#39;FT&#39; then business_format_code_ft
            when business_format_code_fl = &#39;FL&#39; then business_format_code_fl
            when business_format_code_df = &#39;DF&#39; then business_format_code_df
            when business_format_code_cr = &#39;CR&#39; then business_format_code_cr
        end::text,&#39;BLANK&#39;) business_format_code*/
        ,coalesce(t.business_application_identifier::text,&#39;BLANK&#39;) business_application_id
        --,coalesce(t.type_of_purchase_fl::text,&#39;BLANK&#39;) type_purchase
        ,coalesce(t.network_id::text,&#39;BLANK&#39;) network_identification_code
        ,coalesce(t.message_reason_code_sms::text,&#39;BLANK&#39;) message_reason_code
        ,coalesce(t.surcharge_amount_sms::text,&#39;BLANK&#39;) surcharge_amount
        --,coalesce(t.authorized_amount::text,&#39;BLANK&#39;)authorized_amount
        ,coalesce(t.response_code::text,&#39;BLANK&#39;)authorization_response_code
        --,coalesce(t.validation_code::text,&#39;BLANK&#39;)validation_code
        --,coalesce(t.merchant_verification_value::text,&#39;BLANK&#39;)merchant_verification_value
        ,coalesce(t.dcc_indicator_sms::text,&#39;BLANK&#39;) dynamic_currency_conversion_indicator
        ,coalesce(t.cvv_result_code_sms::text,&#39;BLANK&#39;) cvv2_result_code
        --,coalesce(t.national_tax_included::text,&#39;BLANK&#39;) national_tax_indicator
        --,coalesce(t.merchant_vat_registration_number::text,&#39;BLANK&#39;) merchant_vat
        --,coalesce(t.summary_commodity_code::text,&#39;BLANK&#39;) summary_commodity
        --,coalesce(t.message_identifier::text,&#39;BLANK&#39;)message_identifier
        ,coalesce(left(t.processing_code::text,2),&#39;BLANK&#39;) processing_code_transaction_type
        ,coalesce(t.pos_condition_code::text,&#39;BLANK&#39;) point_of_service_condition_code
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
        inner join operational.dh_visa_transaction_sms_calculated_field_{customer_code}_{type_file}_{string_date} tcf
        on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
        left join operational.m_country c
        on (c.country_code = tcf.issuer_country)
        left join operational.m_country c2
        on (c2.country_code = t.card_acceptor_country)
        left join operational.m_currency cu
        on (cu.currency_numeric_code = t.transaction_currency_code::int)
        {str_condition_currency}
        where t.app_hash_file=&#39;{hash_file}&#39;
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_interchange_eval&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        table_name_tmp = self.visa_sms_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
        if table_name_tmp == &#39;-1&#39;:
            if self.debug == &#39;False&#39;:
                bulk_delete = ps_block.query_block()
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
                    &#34;INFO&#34;,
                    bulk_delete,
                    self.module
                )
            return &#39;finished&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        ps_block.drop_table(table_tmp)
        query_tmp = f&#34;&#34;&#34;
        with tmp_pre as
        (
        select a.local_transaction_date,a.transaction_currency_code::numeric transaction_currency_code
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} a
        group by 1,2
        )
        select *
        from operational.dh_exchange_rate er
        where (er.app_processing_date,er.currency_from_code::numeric) in (select local_transaction_date,transaction_currency_code from tmp_pre)
        and er.brand=&#39;VISA&#39;
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_ex_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,a.transaction_amount amount_transaction
        ,a.transaction_currency_code currency_transaction
        ,c.fee_currency
        ,c.fee_variable::numeric
        ,c.fee_fixed::numeric
        ,c.fee_min::numeric
        ,c.fee_cap::numeric
        ,case
            when c.fee_variable is null then fee_fixed::numeric
            when not operational.isnumeric(c.fee_variable) then null
            else
                case
                    when (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &lt;= fee_min then fee_min::numeric
                    when (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &gt;= fee_cap then fee_cap::numeric
                    else (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0)
                end
        end calculated_value,
        e.intelica_id::numeric
        ,e.region_country_code
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} a
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_{number_file}_visa_sms_interchange_eval_assign e
        on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
        left join operational.m_interchange_rules_visa c
        on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code
        and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
        left join operational.m_currency cur on cur.currency_numeric_code = a.transaction_currency_code::numeric
        left join {table_tmp} er
        on (er.date=a.local_transaction_date and er.currency_from_code::numeric=a.transaction_currency_code::numeric and er.currency_to=c.fee_currency and lower(er.brand)=&#39;visa&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_interchange&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;INTERCHANGE OF VISA SMS FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def fill_range(self,list_value:list)-&gt; list:
        &#34;&#34;&#34;Generating a fill list
        
        Args:
            list_value (list): list of values 

        Returns:
            list_string (list): list of processed values
        
        &#34;&#34;&#34;
        new_list = []
        list_string = []
        for value in list_value:
            if str(value).find(&#39;-&#39;)&gt;0:
                split_value=value.split(&#39;-&#39;)
                new_list.extend(range(int(split_value[0]),int(split_value[1])+1))
            else:
                new_list.append(int(value))
        list_string = map(str, new_list)
        return list_string
    
    def visa_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
        &#34;&#34;&#34;Direct Assignment Exchange Rules
        
        Args:
            table_schema_source (str): schema of table source
            table_name_source (str): table source name
            string_date (str): date filter

        Returns:
            table_name_result (str): Table name as result 
        
        &#34;&#34;&#34;
        table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
        dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
        table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
        table_work = pd.DataFrame(self.ps.select(table))
        if table_work.empty:
            query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from from {table}&#39;
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_create,
            self.module
            )  

            return table_name_result
        table_work[&#39;rule&#39;] = 0
        table_work[&#39;id&#39;] = table_work.index + 1
        table_work[&#39;product_id&#39;] = table_work[&#39;product_id&#39;].str.strip()
        table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_visa r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and region_country_code in (select jurisdiction from {table} group by 1) order by region_country_code,intelica_id::numeric&#34;))
        table_rules[&#39;key&#39;] = table_rules.index + 1
        count_row=0
        count_condition = 0
        for rule in table_rules[&#39;key&#39;].values:
            table_test = pd.DataFrame()
            table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0)],how=&#39;right&#39;)
            for condition in table_rules.columns.values:
                if condition not in (&#39;processing_code_transaction_type&#39;,&#39;point_of_service_condition_code&#39;,&#39;app_id&#39;,&#39;intelica_id_original&#39;,&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;transaction_amount_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_program&#39;,&#39;intelica_id&#39;,&#39;fpi&#39;,&#39;fee_descriptor&#39;,&#39;fee_description&#39;,&#39;cod_hierarchy&#39;,&#39;program_default&#39;,&#39;fee_currency&#39;,&#39;fee_variable&#39;,&#39;fee_fixed&#39;,&#39;fee_min&#39;,&#39;fee_cap&#39;,&#39;acquiring_identifier&#39;,&#39;message_identifier&#39;,&#39;merchant_verification_value&#39;,&#39;validation_code&#39;,&#39;v_i_p_full_financial_message_sets&#39;,&#39;sender_data&#39;,&#39;additional_sender_data&#39;,&#39;settlement_service&#39;,&#39;other_criteria_applies&#39;):
                    value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                    if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                        if len(table_test)&gt;0:
                            try:

                                if condition in (&#39;nnss_indicator&#39;,&#39;cardholder_id_method&#39;,&#39;moto_eci_indicator&#39;,&#39;acceptance_terminal_indicator&#39;,&#39;merchant_vat&#39;):
                                    value_condition = value_condition.lower().replace(&#39;space&#39;,&#39; &#39;).upper()
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition.replace(&#39;NOT:&#39;,&#39;&#39;)
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[~table_test[condition].astype(str).isin(split_condition)]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).isin(split_condition)]
                                    continue
                                if condition in (&#39;transaction_amount&#39;):
                                    table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                    value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;transaction_amount_currency&#39;][count_row]).lower()}&#34;
                                    table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                    table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{value_condition_currency} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;surcharge_amount&#39;,&#39;timeliness&#39;):
                                    table_test = table_test[table_test[condition] != &#39;BLANK&#39;]
                                    table_test[condition] = pd.to_numeric(table_test[condition])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{condition} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[condition].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;merchant_category_code&#39;):
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                        else:
                                            table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                        else:
                                            table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                    continue
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                                else:
                                    value_condition = value_condition.upper()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        value_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                                if table_test.empty:
                                    break
                            except ValueError as error:                   
                                log.logs().exist_file(
                                &#34;OPERATIONAL&#34;,
                                &#34;&#34;,
                                &#34;VISA&#34;,
                                self.log_name,
                                &#34;ADAPTER OF VISA FILE&#34;,
                                &#34;ERROR&#34;,
                                &#34;Error has occurred:&#34;+ str(error),
                                self.module
                                )  
            if len(table_test)&gt;0:
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;cod_hierarchy&#39;] = table_rules[&#39;cod_hierarchy&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
            count_row+=1
        if len(table_work)&gt;0:
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;INTERCHANGE OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            table_work = table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;cod_hierarchy&#39;,&#39;valid_from&#39;]].applymap(str)
            table_work[&#34;intelica_id&#34;] = table_work[&#34;intelica_id&#34;].replace(&#34;nan&#34;,None)
            table_work[&#34;region_country_code&#34;] = table_work[&#34;region_country_code&#34;].replace(&#34;nan&#34;,None)
            aasa =  table_work.loc[table_work[&#34;region_country_code&#34;] == None] 
            print(aasa)
            self.ps.insert_from_df(table_work,table_schema_source.lower(),table_name_result)
            return table_name_result
        return &#39;-1&#39;

    def visa_sms_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
        &#34;&#34;&#34;Direct Assignment Exchange Rules
        
        Args:
            table_schema_source (str): schema of table source
            table_name_source (str): table source name
            string_date (str): date filter

        Returns:
            table_name_result (str): Table name as result
        
        &#34;&#34;&#34;
        table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
        dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
        table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
        table_work = pd.DataFrame(self.ps.select(table))
        if table_work.empty:
            query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from from {table}&#39;
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA SMS FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA SMS FILE&#34;,
            &#34;INFO&#34;,
            message_create,
            self.module
            )  

            return table_name_result
        table_work[&#39;rule&#39;] = 0
        table_work[&#39;id&#39;] = table_work.index + 1
        table_work[&#39;product_id&#39;] = table_work[&#39;product_id&#39;].str.strip()
        table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_visa r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and region_country_code in (select jurisdiction from {table} group by 1) order by region_country_code,intelica_id::numeric&#34;))
        table_rules[&#39;key&#39;] = table_rules.index + 1
        count_row=0
        count_condition = 0
        for rule in table_rules[&#39;key&#39;].values:
            table_test = pd.DataFrame()
            table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0)],how=&#39;right&#39;)
            for condition in table_rules.columns.values:
                if condition not in (&#39;transaction_code_qualifier&#39;,&#39;payment_credential_combination&#39;,&#39;prepaid_card_indicator&#39;,&#39;business_format_code&#39;,&#39;type_purchase&#39;,&#39;authorized_amount&#39;,&#39;national_tax_indicator&#39;,&#39;merchant_vat&#39;,&#39;summary_commodity&#39;,&#39;message_identifier&#39;,&#39;app_id&#39;,&#39;intelica_id_original&#39;,&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;transaction_amount_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_program&#39;,&#39;intelica_id&#39;,&#39;fpi&#39;,&#39;fee_descriptor&#39;,&#39;fee_description&#39;,&#39;cod_hierarchy&#39;,&#39;program_default&#39;,&#39;fee_currency&#39;,&#39;fee_variable&#39;,&#39;fee_fixed&#39;,&#39;fee_min&#39;,&#39;fee_cap&#39;,&#39;acquiring_identifier&#39;,&#39;message_identifier&#39;,&#39;merchant_verification_value&#39;,&#39;validation_code&#39;,&#39;v_i_p_full_financial_message_sets&#39;,&#39;sender_data&#39;,&#39;additional_sender_data&#39;,&#39;settlement_service&#39;,&#39;other_criteria_applies&#39;):
                    value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                    if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                        if len(table_test)&gt;0:
                            try:

                                if condition in (&#39;nnss_indicator&#39;,&#39;cardholder_id_method&#39;,&#39;moto_eci_indicator&#39;,&#39;acceptance_terminal_indicator&#39;,&#39;merchant_vat&#39;):
                                    value_condition = value_condition.lower().replace(&#39;space&#39;,&#39; &#39;).upper()
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition.replace(&#39;NOT:&#39;,&#39;&#39;)
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[~table_test[condition].astype(str).isin(split_condition)]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).isin(split_condition)]
                                    continue
                                if condition in (&#39;transaction_amount&#39;):
                                    table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                    value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;transaction_amount_currency&#39;][count_row]).lower()}&#34;
                                    table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                    table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{value_condition_currency} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;surcharge_amount&#39;,&#39;timeliness&#39;):
                                    table_test = table_test[table_test[condition] != &#39;BLANK&#39;]
                                    table_test[condition] = pd.to_numeric(table_test[condition])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{condition} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[condition].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;merchant_category_code&#39;):
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                        else:
                                            table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                        else:
                                            table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                    continue
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                                else:
                                    value_condition = value_condition.upper()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        value_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                                if table_test.empty:
                                    break
                            except ValueError as error:                   
                                log.logs().exist_file(
                                &#34;OPERATIONAL&#34;,
                                &#34;&#34;,
                                &#34;VISA&#34;,
                                self.log_name,
                                &#34;ADAPTER OF VISA FILE&#34;,
                                &#34;ERROR&#34;,
                                &#34;Error has occurred:&#34;+ str(error),
                                self.module
                                )  
            if len(table_test)&gt;0:
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;cod_hierarchy&#39;] = table_rules[&#39;cod_hierarchy&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
            count_row+=1
        if len(table_work)&gt;0:
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;INTERCHANGE OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            table_work = table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;cod_hierarchy&#39;,&#39;valid_from&#39;]].applymap(str)
            table_work[&#34;intelica_id&#34;] = table_work[&#34;intelica_id&#34;].replace(&#34;nan&#34;,None)
            table_work[&#34;region_country_code&#34;] = table_work[&#34;region_country_code&#34;].replace(&#34;nan&#34;,None)
            self.ps.insert_from_df(table_work,table_schema_source.lower(),table_name_result)
            return table_name_result
        return &#39;-1&#39;

    def mastercard_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
        &#34;&#34;&#34;Direct Assignment Exchange Rules
        
        Args:
            table_schema_source (str): schema of table source
            table_name_source (str): table source name
            string_date (str): date filter

        Returns:
            table_name_result (str): Table name as result
        
        &#34;&#34;&#34;
        table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
        dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
        table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
        table_work = pd.DataFrame(self.ps.select(table))
        if table_work.empty:
            query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from, null ird from {table}&#39;
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_create,
            self.module
            )  

            return table_name_result
        table_work[&#39;rule&#39;] = 0
        table_work[&#39;id&#39;] = table_work.index + 1
        table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_mc r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and (region_country_code,ird) in (select jurisdiction,ird from {table} group by 1,2) order by region_country_code,intelica_id::numeric&#34;))
        table_rules[&#39;key&#39;] = table_rules.index + 1
        count_row=0
        count_condition = 0
        for rule in table_rules[&#39;key&#39;].values:
            table_test = pd.DataFrame()
            table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0) &amp; (table_work[&#39;ird&#39;] == table_rules[&#39;ird&#39;][count_row])],how=&#39;right&#39;)
            for condition in table_rules.columns.values:
                if condition not in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;amount_transaction_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_category&#39;,&#39;fee_tier&#39;,&#39;intelica_id&#39;,&#39;ird&#39;,&#39;rate_currency&#39;,&#39;rate_variable&#39;,&#39;rate_fixed&#39;,&#39;rate_min&#39;,&#39;rate_cap&#39;,&#39;masterpass_incentive_indicator&#39;,&#39;tti&#39;,&#39;additional_data&#39;,&#39;mastercard_assigned_id&#39;):
                    value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                    if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                        if len(table_test)&gt;0:
                            try:
                                if condition in (&#39;amount_transaction&#39;):
                                    table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                    value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;amount_transaction_currency&#39;][count_row]).lower()}&#34;
                                    table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                    table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        list_value_condition = value_condition.split(&#39;,&#39;)
                                        for value_str in list_value_condition:
                                            query_condition = f&#34;{value_condition_currency} {value_str.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                            table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;card_acceptor_business_code&#39;):
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                        else:
                                            table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                        else:
                                            table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                    continue
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                                else:
                                    value_condition = value_condition.upper()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        value_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                                if table_test.empty:
                                    break
                            except ValueError as error:                   
                                log.logs().exist_file(
                                &#34;OPERATIONAL&#34;,
                                &#34;&#34;,
                                &#34;MASTERCARD&#34;,
                                self.log_name,
                                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                                &#34;ERROR&#34;,
                                &#34;Error has occurred:&#34;+ str(error),
                                self.module
                                )  
            if len(table_test)&gt;0:
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;ird&#39;] = table_rules[&#39;ird&#39;][count_row]
            count_row+=1
        if len(table_work)&gt;0:
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            self.ps.insert_from_df(table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;valid_from&#39;,&#39;ird&#39;]].applymap(str),table_schema_source.lower(),table_name_result)
            return table_name_result
        return &#39;-1&#39; </code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters"><code class="flex name class">
<span>class <span class="ident">get_adapters</span></span>
<span>(</span><span>customer_code: str, log_name: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Class for adapter's method</p>
<h2 id="params">Params</h2>
<p>customer_code (str): customer code
log_name (str): name of logs</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class get_adapters:
    &#34;&#34;&#34;Class for adapter&#39;s method

    Params:
        customer_code (str): customer code
        log_name (str): name of logs
    
    &#34;&#34;&#34;
    def __init__(self, customer_code: str, log_name: str):
        load_dotenv()
        self.ps = con.connect_to_postgreSQL()
        self.s3 = con.connect_to_s3()
        self.structured = os.getenv(&#34;STRUCTURED_BUCKET&#34;)
        self.log = os.getenv(&#34;LOG_BUCKET&#34;)
        self.customer_code = customer_code
        self.log_name = log_name
        self.module = &#39;ADAPTER&#39;
        path_to_file = &#34;FILES/ADAPTERS/&#34;
        self.debug = os.getenv(&#34;DEBUG&#34;)
        pathlib.Path(path_to_file).mkdir(parents=True, exist_ok=True)

    def visa_read_sms(self, df: pd.DataFrame , list_columns : list, column_tcr : str, base_count : int, log_name: str = None, client:str = None) -&gt; pd.DataFrame:
        &#34;&#34;&#34;SMS type reading function

        Args:
            df (dataframe) : dataframe with data
            list_columns (list): list of columns
            column_tcr (str): column with tcr data
            base_count (int): counter

        Returns:
            pd.DataFrame: Dataframe with data
        
        &#34;&#34;&#34;
        list_sms = []
        dict_sms = {}
        count = base_count
        module = &#39;ADAPTER&#39;

        for index, value in enumerate(df[column_tcr].values):
            if value[40:42] == &#39;00&#39;:
                if index &gt; 0:
                    list_sms.append(dict_sms)
                dict_sms = {}
                count += 1
                dict_sms.update({list_columns[0] : count})
                for base in range(1,len(list_columns)):
                    dict_sms.update({list_columns[base] : df[list_columns[base]].values[index]})
            dict_sms.update({value[36:42] : value})
        list_sms.append(dict_sms)
        return pd.DataFrame(list_sms)

    def visa_read_condition(self, condition: str, delimiter: str, log_name: str = None, client:str = None) -&gt; list:
        &#34;&#34;&#34;convert to a readable condition list

        Args:
            condition (str): string of conditions
            delimiter (str): conditions delimiter (&amp; or |)

        Returns:
            list_return (list): readable condition list
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;

        list_condition = []
        list_return = []
        list_condition = condition.split(delimiter)
        for string in list_condition:
            if string[0:1] == &#39;P&#39;:
                value_name = string[0:1]
                substring = string[1:string.find(&#39; &#39;)].split(&#39;-&#39;)
                string_start_position = int(substring[0])
                string_end_position = int(substring[1])
                if string.find(&#39;==&#39;)&gt;-1:
                    value_start_position = string.find(&#39;==&#39;)
                if string.find(&#39;!=&#39;)&gt;-1:
                    value_start_position = string.find(&#39;!=&#39;)
                string_value = string[value_start_position+3:].replace(&#34;&#39;&#34;,&#39;&#39;)
                string_tcr = None
                string_operator = string[value_start_position:value_start_position + 2]
            elif string[0:3] == &#39;TCR&#39;:
                value_name = string[0:3]
                list_string = string.split(&#39;:&#39;)
                string_tcr = list_string[0].replace(&#39;TCR &#39;,&#39;&#39;)
                substring = list_string[1][2:list_string[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                string_value = list_string[1][list_string[1].find(&#39;==&#39;)+3:].replace(&#34;&#39;&#34;,&#39;&#39;)
                string_start_position = int(substring[0])
                string_end_position = int(substring[1])
                string_operator = &#39;==&#39;
            list_return.append({&#39;value_name&#39; : value_name,&#39;value_start_position&#39; : string_start_position, &#39;value_end_position&#39; : string_end_position, &#39;value&#39; : string_value, &#39;value_tcr&#39; : string_tcr, &#39;value_operator&#39; : string_operator})
        return list_return

    def visa_apply_condition(self, df : pd.DataFrame, column_apply_condition: str, list_condition : list ,operator : str , skip_character : int, skip_columns : int, log_name: str = None, client:str = None) -&gt; pd.DataFrame:
        &#34;&#34;&#34;Visa conditions applicator

        Args:
            df (dataframe): dataframe with data
            column_apply_condition (str): column conditions
            list_condition (list): list of conditions
            operator (str): operator for condition
            skip_character (int): characters to skip in reading
            skip_columns (int): columns to skip

        Returns:
            pd.Dataframe: Dataframe with data    
        
        &#34;&#34;&#34;
        if operator == &#39;&amp;&#39;:
            for value in list_condition:
                if value[0:1] == &#39;P&#39;:
                    substring_condition = value[1:value.find(&#39; &#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = value[value.find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df = df[df[column_apply_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value]
                if value[0:3] == &#39;TCR&#39;:
                    list_string_condition = value.split(&#39;:&#39;)
                    tcr_condition = list_string_condition[0].replace(&#39;TCR &#39;,&#39;&#39;)
                    if tcr_condition == &#39;0&#39;:
                        column_condition = str(skip_columns)
                    substring_condition = list_string_condition[1][2:list_string_condition[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = list_string_condition[1][list_string_condition[1].find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df = df[df[column_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value]
            return df
        elif operator ==&#39;|&#39;:
            df_tmp = pd.DataFrame()
            df_tmp = df_tmp.join(df.head(0),how=&#39;right&#39;)
            for value in list_condition:
                df_condition_tmp = pd.DataFrame()
                if value[0:1] == &#39;P&#39;:
                    substring_condition = value[1:value.find(&#39; &#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = value[value.find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df_condition_tmp = df_condition_tmp.join(df[df[column_apply_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value],how=&#39;right&#39;)
                if value[0:3] == &#39;TCR&#39;:
                    list_string_condition = value.split(&#39;:&#39;)
                    tcr_condition = list_string_condition[0].replace(&#39;TCR &#39;,&#39;&#39;)
                    if tcr_condition == &#39;0&#39;:
                        column_condition = str(skip_columns)
                    substring_condition = list_string_condition[1][2:list_string_condition[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                    condition_start_position = int(substring_condition[0]) + skip_character
                    condition_end_position = int(substring_condition[1]) + skip_character + 1
                    string_condition_value = list_string_condition[1][list_string_condition[1].find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                    df_condition_tmp = df_condition_tmp.join(df[df[column_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value],how=&#39;right&#39;)
                if not df_condition_tmp.empty:
                    df_tmp = pd.concat([df_tmp,df_condition_tmp],ignore_index=True).drop_duplicates()
            if not df_tmp.empty:
                return df_tmp
            else:
                return df
        
    def visa_upload_adapter(self, filename_parquet: str, file_type: str = &#39;in&#39;,hash_file:str = None, number_file:str = None, string_date:str = None)-&gt; str:
        &#34;&#34;&#34;Load visa adapter based on type as csv object
        
        Args:
            filename_parquet (str): local parquet file to read
            file_type (str): type of file 
            hash_file (str): hash code of file
            number_file (str): number of file in queue
            string_date (str): date of file

        Returns:
            str: Message

        &#34;&#34;&#34;
        try:
            module = &#39;ADAPTER&#39;
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                &#34;loading adapter file :&#34; + hash_file,
                self.module
            )

            bucket = self.structured
            table_name_adapter = &#39;control.t_visa_adapter&#39;
            table_name_stg_base = &#39;operational.stg_adapter_visa_transaction&#39;
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
            records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
            df = pd.read_parquet(filename_parquet,engine=&#39;pyarrow&#39;)
            filename = &#39;adapter_visa.csv&#39;
            customer = self.customer_code
            skip_columns = 5
            skip_character = -1
            start_position_tcr = 3
            end_position_tcr = 4
            len_tcr = 2
            list_record = []
            list_record_tmp = []
            dict_record = []
            list_base = [&#39;0&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;]
            len_df = len(df.index)
            if file_type == &#39;in&#39;:
                skip_character += 2
                start_position_tcr += 2
                end_position_tcr += 2
                len_tcr += 2
            for record in records_adapter:
                record_tc = record[&#39;type_record&#39;]
                if record_tc not in list_record:
                    list_record.append(record_tc)
                    dict_record.append({&#39;tc&#39;:record[&#39;tc&#39;].replace(&#39; &#39;,&#39;&#39;) , &#39;type_record&#39; : record[&#39;type_record&#39;], &#39;condition_type_record&#39; : record[&#39;condition_type_record&#39;]})
            for value in dict_record:
                list_record_tmp+=value[&#39;tc&#39;].split(&#39;,&#39;)
            for row in dict_record:
                table_name = table_name_stg_base

                if row[&#39;type_record&#39;]!=&#39;transaction&#39;:
                    table_name += &#39;_&#39;+row[&#39;type_record&#39;]
                count_data_tc = 0
                filename_record = f&#34;FILES/ADAPTERS/{customer}_{file_type}_{number_file}_{row[&#39;type_record&#39;]}_{filename}&#34;
                dfnew = pd.DataFrame()
                list_row = row[&#39;tc&#39;].split(&#39;,&#39;)
                select_df = self.visa_apply_condition(df[df[str(skip_columns)].str.startswith(tuple(list_row), na=False)].reset_index(drop=True),str(skip_columns),str(row[&#39;condition_type_record&#39;]).split(&#39;&amp;&#39;),&#39;&amp;&#39;,skip_character,skip_columns)
                dfnew = dfnew.join(select_df[list_base].head(0),how=&#39;right&#39;)
                if row[&#39;type_record&#39;] == &#39;sms&#39;:
                    df_sms = self.visa_read_sms(select_df,list_base,str(skip_columns), len_df)
                for record in records_adapter:
                    str_tc = record[&#39;tc&#39;].replace(&#39; &#39;,&#39;&#39;)
                    str_type_record = record[&#39;type_record&#39;]
                    if str_tc==row[&#39;tc&#39;] and str_type_record == row[&#39;type_record&#39;]:
                        str_tcr = record[&#39;tcr&#39;].replace(&#39; &#39;,&#39;&#39;)
                        string_condition = str(record[&#39;additional_condition&#39;])
                        if record[&#39;position&#39;]&gt;2 or file_type == &#39;out&#39;:
                            start_position_column = record[&#39;position&#39;] + skip_character
                            end_position_column = record[&#39;position&#39;] + record[&#39;length&#39;] + skip_character
                        else:
                            start_position_column = record[&#39;position&#39;] - skip_character
                            end_position_column = record[&#39;position&#39;] + record[&#39;length&#39;] - skip_character
                        name_column = str(record[&#39;column_name&#39;]).replace(&#39;,&#39;,&#39;&#39;).replace(&#39;\n&#39;,&#39;&#39;)
                        for column in select_df:
                            if select_df[column].count()&gt;0:
                                str_row_max_len = select_df[column].str.len().max()
                                if str_row_max_len&gt;len_tcr and int(column)&gt;=skip_columns:
                                    df_column = pd.DataFrame()
                                    df_condition = pd.DataFrame()
                                    count_data_column = 0
                                    count_df_condition = 0
                                    str_temp = list(filter(lambda col: col!= None,select_df[column].str[start_position_tcr:end_position_tcr].drop_duplicates().to_list()))
                                    if record[&#39;type_record&#39;] == &#39;header&#39;:
                                        df_column = df_column.join(select_df[list_base],how=&#39;right&#39;)
                                        df_column[name_column] = select_df[str(skip_columns)].str[start_position_column:end_position_column]
                                        dfnew = pd.merge(dfnew,df_column,how=&#39;outer&#39;)
                                        count_data_tc+=1
                                        break
                                    if str_temp[0] == str_tcr:
                                        select_df_tmp = pd.DataFrame()
                                        list_condition = []
                                        
                                        if string_condition.find(&#39;&amp;&#39;) != -1:
                                            list_condition = string_condition.split(&#39;&amp;&#39;)
                                            select_df_tmp = select_df_tmp.join(self.visa_apply_condition(select_df,column,list_condition[1].split(&#39;|&#39;),&#39;&amp;&#39;,skip_character,skip_columns),how=&#39;right&#39;)
                                        else:
                                            select_df_tmp = select_df_tmp.join(select_df,how=&#39;right&#39;)
                                        string_condition_sub = string_condition.split(&#39;&amp;&#39;)
                                        if (string_condition_sub[0].find(&#39;|&#39;) != -1 or len(string_condition_sub[0])&gt;0):
                                            list_condition = string_condition_sub[0].split(&#39;|&#39;)
                                            if row[&#39;type_record&#39;] == &#39;sms&#39;:
                                                list_sms = self.visa_read_condition(string_condition_sub[0],&#39;|&#39;)
                                                df_condition = df_condition.join(df_sms,how=&#39;right&#39;)
                                                column = list_sms[0][&#39;value&#39;]
                                                if len(list_sms)&gt;1 and column in df_condition.columns.values:
                                                    if list_sms[1][&#39;value_operator&#39;] == &#39;!=&#39;:
                                                        df_condition.loc[df_condition[column].str[list_sms[1][&#39;value_start_position&#39;] - skip_character:list_sms[1][&#39;value_end_position&#39;]] != list_sms[1][&#39;value&#39;],column] = df_condition[column]
                                                    if list_sms[1][&#39;value_operator&#39;] == &#39;==&#39;:
                                                        df_condition.loc[df_condition[column].str[list_sms[1][&#39;value_start_position&#39;] - skip_character:list_sms[1][&#39;value_end_position&#39;]] == list_sms[1][&#39;value&#39;],column] = df_condition[column]
                                                    count_df_condition = df_condition[column].count()
                                            else:
                                                df_condition = df_condition.join(self.visa_apply_condition(select_df_tmp,column,list_condition,&#39;|&#39;,skip_character,skip_columns),how=&#39;right&#39;)
                                                count_df_condition = df_condition[column].count()
                                            df_column = df_column.join(df_condition[list_base],how=&#39;right&#39;)

                                            if count_df_condition&gt;0:
                                                df_column[name_column] = df_condition[column].str[start_position_column:end_position_column]
                                                count_data_column += 1
                                            else:
                                                df_column[name_column] = nan
                                        else:
                                            df_column = df_column.join(select_df_tmp[list_base],how=&#39;right&#39;)

                                            df_column[name_column] = select_df_tmp[column].str[start_position_column:end_position_column]
                                            count_data_column += 1
                                        if count_data_column&gt;0:
                                            dfnew = pd.merge(dfnew,df_column,how=&#39;outer&#39;)
                                            df_column = df_column[df_column[name_column].notna()]
                                            count_data_tc+=1
                                        break
                if count_data_tc &gt; 0:
                    dfnew = dfnew.rename(columns = {&#39;0&#39;:&#39;app_id&#39;,&#39;1&#39;:&#39;app_customer_code&#39;,&#39;2&#39;:&#39;app_type_file&#39;,&#39;3&#39;:&#39;app_hash_file&#39;,&#39;4&#39;:&#39;app_processing_date&#39;})
                    str_columns = &#39;&#34;&#39; + &#39;&#34;,&#34;&#39;.join(map(str,list(dfnew.columns.values))) + &#39;&#34;&#39;
                    dfnew.to_csv(filename_record,index=False,encoding=&#39;utf-8&#39;)
                    self.s3.upload_object(bucket,filename_record,f&#34;adapters/{filename_record}&#34;,)
                    result = self.ps.insert_from_csv(table_name,&#34;&#34;&#34;(format csv, header true, quote &#39;&#34;&#39; )&#34;&#34;&#34;,bucket,f&#34;adapters/{filename_record}&#34;,str_columns,False)
                    result_message = f&#34;{row[&#39;type_record&#39;]} : {len(dfnew)} {result}&#34;
                else:
                    result_message = f&#34;{row[&#39;type_record&#39;]} : data not found&#34;
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    self.customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;ADAPTER OF VISA FILE&#34;,
                    &#34;INFO&#34;,
                    result_message,
                    self.module
                )
            return &#39;finished&#39;
        except Exception as e:   
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                &#34;error loading adapter file :&#34; + hash_file
                + &#34; | exception reading file: &#34;
                + str(e),
                self.module
            )
              
    def mastercard_extract_pds(self, str_value : str, find_str : int,log_name: str = None, client:str = None) -&gt; str:
        &#34;&#34;&#34;Method to extract pds of Dataelements

        Args:
            str_value (str): value of data element
            find_str (str): pds number

        Returns:
            str: pds value
        &#34;&#34;&#34;

        
        if str_value[0:4].isnumeric():
            len_str = len(str_value)
            len_value = int(str_value[4:7])
            str_pds = int(str_value[0:4])
            len_max_value = len_value + 7
            
            if str_pds == find_str:
                return str_value[7:len_max_value]
            elif len_max_value &lt; len_str:
                return self.mastercard_extract_pds(str_value[len_max_value:],find_str)
            else:
                return &#39;&#39;
        else:
            return &#39;&#39;

    def mastercard_find_pds(self, df_pds : pd.DataFrame, list_column_pds: list,column_name_de: str,log_name: str = None, client:str = None)-&gt; pd.DataFrame:
        &#34;&#34;&#34;Method to find pds of Dataelements

        Args:
           df_pds(dataframe) : Dataframe with data
           list_column_pds (list): list of pds names
           column_name_de (str): column name of data element

        Returns:
            pd.DataFrame: dataframe with DE data
        &#34;&#34;&#34;
        list_pds = []
        for value in df_pds[column_name_de].values:
            dict_pds = {}
            dict_pds.update({&#39;de&#39; : column_name_de[2:]})
            for pds_value in list_column_pds:
                if value!=None:
                    dict_pds.update({pds_value : self.mastercard_extract_pds(value,int(pds_value))})
                else:
                    dict_pds.update({pds_value : &#39;&#39;})
            list_pds.append(dict_pds)
        return pd.DataFrame(list_pds)
    
    def mastercard_upload_adapter(self, filename_parquet: str, file_type: str = &#39;in&#39;,hash_file:str=None,number_file:str = None, string_date:str=None) -&gt; str:
        &#34;&#34;&#34;Load Mastercard adapter based on type as csv object
        
        Args:
            filename_parquet (str): local parquet file to read
            file_type (str): type of file 
            hash_file (str): hash code of file
            number_file (str): number of file in queue
            string_date (str): date of file

        Returns:
            str: Message

        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            &#34;loading mastercard adapter type file : &#34; + file_type,
            self.module
        )

        bucket = self.structured
        table_name_adapter = &#39;control.t_mastercard_adapter&#39;
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df = pd.read_parquet(filename_parquet,engine=&#39;pyarrow&#39;)
        df[&#39;app_id&#39;] = df.index + 1
        df[&#39;app_type_file&#39;] = file_type.upper()
        filename = &#39;adapter_mastercard.csv&#39;
        customer = self.customer_code
        table_name_base = &#39;operational.stg_adapter_mastercard&#39;
        list_columns_de = []
        list_columns_pds = []
        list_columns_base = [&#39;app_id&#39;,&#39;app_type_file&#39;,&#39;app_client&#39;,&#39;app_hash&#39;,&#39;MESSAGE_TYPE&#39;,&#39;app_file_date&#39;]
        list_columns_base_pds = [&#39;app_id&#39;,&#39;app_type_file&#39;,&#39;app_client&#39;,&#39;app_hash&#39;,&#39;app_file_date&#39;]
        dict_adapter_de = []
        list_adapter = []
        start_position_column = 0
        start_position_column_subfield = 0
        pds_start_position_column_subfield = 0
        pds_code = 2
        df_adapter = pd.DataFrame(records_adapter)
        df_adapter_de = pd.DataFrame()
        df_adapter[&#39;length&#39;] = df_adapter[&#39;field_max_length&#39;]
        df_adapter.loc[df_adapter[&#39;field_max_length&#39;] == 0, &#39;length&#39;] = df_adapter[&#39;field_min_length&#39;]

        df_adapter.loc[df_adapter[&#39;type_record&#39;] != pds_code, &#39;list_column_de&#39;] = &#39;DE&#39; + df_adapter[&#39;de&#39;].astype(str)
        list_columns_de.extend(list_columns_base)
        list_columns_de.extend(df_adapter[df_adapter[&#39;list_column_de&#39;].notna()][&#39;list_column_de&#39;].drop_duplicates().values)
        df = df.filter(items=list_columns_de)
        df_adapter_pds = df_adapter[df_adapter[&#39;pds&#39;] == pds_code].reset_index(drop=True)
        table_name_pds = table_name_base + &#39;_&#39; + df_adapter_pds[&#39;type_record&#39;][0]
        for type_record in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            df_new = pd.DataFrame()
            df_adapter_record = pd.DataFrame()
            select_df = pd.DataFrame()
            df_load = pd.DataFrame()
            filename_record = f&#34;FILES/ADAPTERS/{customer}_{file_type}_{number_file}_{type_record}_{filename}&#34;
            start_position_column_subfield = 0
            len_column_subfield = 0
            count = 0
            table_name = table_name_base + &#39;_&#39; + type_record
            df_adapter_record = df_adapter_record.join(df_adapter[(df_adapter[&#39;type_record&#39;]==type_record) &amp; (df_adapter[&#39;pds&#39;]&lt;pds_code)].sort_values(by=[&#39;de&#39;,&#39;subfield&#39;],ascending=True).reset_index(drop=True),how=&#39;right&#39;)
            list_row = df_adapter_record[&#39;message_type_identifier&#39;].drop_duplicates().values[0].split(&#39;,&#39;)
            select_df = select_df.join(df[df[&#39;MESSAGE_TYPE&#39;].str.startswith(tuple(list_row), na=False)].reset_index(drop=True),how=&#39;right&#39;)
            df_new = df_new.join(select_df[list_columns_base],how=&#39;right&#39;)
            for index,column_name in enumerate(df_adapter_record[&#39;column_name&#39;].values):
                if select_df.empty:
                    continue

                len_column = 0
                if df_adapter_record[&#39;subfield&#39;][index] == 0: 
                    len_column = df_adapter_record[&#39;field_max_length&#39;][index] if int(df_adapter_record[&#39;field_max_length&#39;][index]) &gt; 0 else df_adapter_record[&#39;field_min_length&#39;][index]
                    start_position_column_subfield = 0
                    start_position = 0
                else:
                    if df_adapter_record[&#39;subfield&#39;][index] == 1:
                        start_position_column_subfield = 0
                    len_column_subfield = df_adapter_record[&#39;subfield_max_length&#39;][index] if int(df_adapter_record[&#39;subfield_max_length&#39;][index]) &gt; 0 else df_adapter_record[&#39;subfield_min_length&#39;][index]
                    start_position = start_position_column_subfield
                    len_column = start_position + len_column_subfield
                    start_position_column_subfield += len_column_subfield

                df_load = pd.concat([df_load,select_df[df_adapter_record[&#39;list_column_de&#39;][index]].str[start_position:len_column]],axis=1)
                df_load = df_load.rename(columns = {df_adapter_record[&#39;list_column_de&#39;][index] : column_name})
                if df_adapter_record[&#39;pds&#39;][index] == 1:
                    pds_start_position_column_subfield = 0
                    pds_len_column_subfield = 0
                    df_adapter_pds = df_adapter_pds.sort_values(by=[&#39;de&#39;,&#39;subfield&#39;],ascending=True).reset_index(drop=True)
                    list_columns_pds = df_adapter_pds[&#39;de&#39;].drop_duplicates().values
                    df_load_sub = pd.DataFrame()
                    df_load_sub = pd.concat([df_load_sub,self.mastercard_find_pds(select_df,list_columns_pds,df_adapter_record[&#39;list_column_de&#39;][index])],axis=1)
                    for pds_index, pds_column_name in enumerate(df_adapter_pds[&#39;column_name&#39;].values):
                        df_column_pds = pd.DataFrame()
                        if not df_load_sub[df_load_sub[df_adapter_pds[&#39;de&#39;][pds_index]] !=&#39;&#39;].empty:
                            pds_len_column = 0
                            if df_adapter_pds[&#39;subfield&#39;][pds_index] == 0: 
                                pds_len_column = df_adapter_pds[&#39;field_max_length&#39;][pds_index] if int(df_adapter_pds[&#39;field_max_length&#39;][pds_index]) &gt; 0 else df_adapter_pds[&#39;field_min_length&#39;][pds_index]
                                pds_start_position_column_subfield = 0
                                pds_start_position = 0
                            else:
                                if df_adapter_pds[&#39;subfield&#39;][pds_index] == 1:
                                    pds_start_position_column_subfield = 0
                                pds_len_column_subfield = df_adapter_pds[&#39;subfield_max_length&#39;][pds_index] if int(df_adapter_pds[&#39;subfield_max_length&#39;][pds_index]) &gt; 0 else df_adapter_pds[&#39;subfield_min_length&#39;][pds_index]
                                pds_start_position = pds_start_position_column_subfield
                                pds_len_column = pds_start_position + pds_len_column_subfield
                                pds_start_position_column_subfield += pds_len_column_subfield
                            df_load = pd.concat([df_load,df_load_sub[df_adapter_pds[&#39;de&#39;][pds_index]].str[pds_start_position:pds_len_column]],axis=1)
                            df_load = df_load.rename(columns = {df_adapter_pds[&#39;de&#39;][pds_index] : pds_column_name})
                count+=1
            if count&gt;0:
                df_new = pd.concat([df_new,df_load],axis=1)
                df_new = df_new.rename(columns = {&#39;app_client&#39;:&#39;app_customer_code&#39;,&#39;app_hash&#39;:&#39;app_hash_file&#39;,&#39;MESSAGE_TYPE&#39;:&#39;app_message_type&#39;,&#39;app_file_date&#39; : &#39;app_processing_date&#39;})
                str_columns = &#39;&#34;&#39; + &#39;&#34;,&#34;&#39;.join(map(str,list(df_new.columns.values))) + &#39;&#34;&#39;
                df_new.to_csv(filename_record,index=False, encoding=&#39;utf-8&#39;)
                self.s3.upload_object(bucket,filename_record,f&#34;adapters/{filename_record}&#34;,)
                
                result = self.ps.insert_from_csv(table_name,&#34;&#34;&#34;(format csv, header true, quote &#39;&#34;&#39; )&#34;&#34;&#34;,bucket,f&#34;adapters/{filename_record}&#34;,str_columns,False)
                result_message = f&#34;{type_record} : {len(df_new)} {result}&#34;
            if count==0:
                result_message = f&#34;{type_record} : data not found&#34;
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
            )
        return &#39;finished&#39;
    
    def visa_clear_stg(self):
        &#34;&#34;&#34;Clean Visa staging tables for execution, returns message&#34;&#34;&#34;

        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        table_name_adapter = &#39;control.t_visa_adapter&#39;
        table_name_stg_base = &#39;operational.stg_adapter_visa_transaction&#39;
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df_records = pd.DataFrame(records_adapter)
        for value in df_records[&#39;type_record&#39;].drop_duplicates().reset_index(drop=True).values:
            table_name = table_name_stg_base
            if value!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value
            log.logs().exist_file(
                        &#34;OPERATIONAL&#34;,
                        self.customer_code,
                        &#34;VISA&#34;,
                        self.log_name,
                        &#34;ADAPTER OF VISA FILE&#34;,
                        &#34;INFO&#34;,
                        self.ps.truncate_table(table_name),
                        self.module
                    )
        return &#39;finished&#39;
    
    def mastercard_clear_stg(self):
        &#34;&#34;&#34;Clean Mastercard staging tables for execution, returns message&#34;&#34;&#34;
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        table_name_adapter = &#39;control.t_mastercard_adapter&#39;
        table_name_stg_base = &#39;operational.stg_adapter_mastercard&#39;
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df_records = pd.DataFrame(records_adapter)
        for value in df_records[&#39;type_record&#39;].drop_duplicates().reset_index(drop=True).values:
            table_name = table_name_stg_base
            table_name += &#39;_&#39;+value
            log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    self.customer_code,
                    &#34;MASTERCARD&#34;,
                    self.log_name,
                    &#34;ADAPTER OF MASTERCARD FILE&#34;,
                    &#34;INFO&#34;,
                    self.ps.truncate_table(table_name),
                    self.module
                )
        return &#39;finished&#39;</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_clear_stg"><code class="name flex">
<span>def <span class="ident">mastercard_clear_stg</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Clean Mastercard staging tables for execution, returns message</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_clear_stg(self):
    &#34;&#34;&#34;Clean Mastercard staging tables for execution, returns message&#34;&#34;&#34;
    string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    table_name_adapter = &#39;control.t_mastercard_adapter&#39;
    table_name_stg_base = &#39;operational.stg_adapter_mastercard&#39;
    records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
    df_records = pd.DataFrame(records_adapter)
    for value in df_records[&#39;type_record&#39;].drop_duplicates().reset_index(drop=True).values:
        table_name = table_name_stg_base
        table_name += &#39;_&#39;+value
        log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                self.ps.truncate_table(table_name),
                self.module
            )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_extract_pds"><code class="name flex">
<span>def <span class="ident">mastercard_extract_pds</span></span>(<span>self, str_value: str, find_str: int, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Method to extract pds of Dataelements</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>str_value</code></strong> :&ensp;<code>str</code></dt>
<dd>value of data element</dd>
<dt><strong><code>find_str</code></strong> :&ensp;<code>str</code></dt>
<dd>pds number</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>pds value</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_extract_pds(self, str_value : str, find_str : int,log_name: str = None, client:str = None) -&gt; str:
    &#34;&#34;&#34;Method to extract pds of Dataelements

    Args:
        str_value (str): value of data element
        find_str (str): pds number

    Returns:
        str: pds value
    &#34;&#34;&#34;

    
    if str_value[0:4].isnumeric():
        len_str = len(str_value)
        len_value = int(str_value[4:7])
        str_pds = int(str_value[0:4])
        len_max_value = len_value + 7
        
        if str_pds == find_str:
            return str_value[7:len_max_value]
        elif len_max_value &lt; len_str:
            return self.mastercard_extract_pds(str_value[len_max_value:],find_str)
        else:
            return &#39;&#39;
    else:
        return &#39;&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_find_pds"><code class="name flex">
<span>def <span class="ident">mastercard_find_pds</span></span>(<span>self, df_pds: pandas.core.frame.DataFrame, list_column_pds: list, column_name_de: str, log_name: str = None, client: str = None) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Method to find pds of Dataelements</p>
<h2 id="args">Args</h2>
<dl>
<dt>df_pds(dataframe) : Dataframe with data</dt>
<dt><strong><code>list_column_pds</code></strong> :&ensp;<code>list</code></dt>
<dd>list of pds names</dd>
<dt><strong><code>column_name_de</code></strong> :&ensp;<code>str</code></dt>
<dd>column name of data element</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>pd.DataFrame</code></dt>
<dd>dataframe with DE data</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_find_pds(self, df_pds : pd.DataFrame, list_column_pds: list,column_name_de: str,log_name: str = None, client:str = None)-&gt; pd.DataFrame:
    &#34;&#34;&#34;Method to find pds of Dataelements

    Args:
       df_pds(dataframe) : Dataframe with data
       list_column_pds (list): list of pds names
       column_name_de (str): column name of data element

    Returns:
        pd.DataFrame: dataframe with DE data
    &#34;&#34;&#34;
    list_pds = []
    for value in df_pds[column_name_de].values:
        dict_pds = {}
        dict_pds.update({&#39;de&#39; : column_name_de[2:]})
        for pds_value in list_column_pds:
            if value!=None:
                dict_pds.update({pds_value : self.mastercard_extract_pds(value,int(pds_value))})
            else:
                dict_pds.update({pds_value : &#39;&#39;})
        list_pds.append(dict_pds)
    return pd.DataFrame(list_pds)</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_upload_adapter"><code class="name flex">
<span>def <span class="ident">mastercard_upload_adapter</span></span>(<span>self, filename_parquet: str, file_type: str = 'in', hash_file: str = None, number_file: str = None, string_date: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Load Mastercard adapter based on type as csv object</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>filename_parquet</code></strong> :&ensp;<code>str</code></dt>
<dd>local parquet file to read</dd>
<dt><strong><code>file_type</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file </dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
<dt><strong><code>number_file</code></strong> :&ensp;<code>str</code></dt>
<dd>number of file in queue</dd>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_upload_adapter(self, filename_parquet: str, file_type: str = &#39;in&#39;,hash_file:str=None,number_file:str = None, string_date:str=None) -&gt; str:
    &#34;&#34;&#34;Load Mastercard adapter based on type as csv object
    
    Args:
        filename_parquet (str): local parquet file to read
        file_type (str): type of file 
        hash_file (str): hash code of file
        number_file (str): number of file in queue
        string_date (str): date of file

    Returns:
        str: Message

    &#34;&#34;&#34;
    module = &#39;ADAPTER&#39;
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading mastercard adapter type file : &#34; + file_type,
        self.module
    )

    bucket = self.structured
    table_name_adapter = &#39;control.t_mastercard_adapter&#39;
    string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
    df = pd.read_parquet(filename_parquet,engine=&#39;pyarrow&#39;)
    df[&#39;app_id&#39;] = df.index + 1
    df[&#39;app_type_file&#39;] = file_type.upper()
    filename = &#39;adapter_mastercard.csv&#39;
    customer = self.customer_code
    table_name_base = &#39;operational.stg_adapter_mastercard&#39;
    list_columns_de = []
    list_columns_pds = []
    list_columns_base = [&#39;app_id&#39;,&#39;app_type_file&#39;,&#39;app_client&#39;,&#39;app_hash&#39;,&#39;MESSAGE_TYPE&#39;,&#39;app_file_date&#39;]
    list_columns_base_pds = [&#39;app_id&#39;,&#39;app_type_file&#39;,&#39;app_client&#39;,&#39;app_hash&#39;,&#39;app_file_date&#39;]
    dict_adapter_de = []
    list_adapter = []
    start_position_column = 0
    start_position_column_subfield = 0
    pds_start_position_column_subfield = 0
    pds_code = 2
    df_adapter = pd.DataFrame(records_adapter)
    df_adapter_de = pd.DataFrame()
    df_adapter[&#39;length&#39;] = df_adapter[&#39;field_max_length&#39;]
    df_adapter.loc[df_adapter[&#39;field_max_length&#39;] == 0, &#39;length&#39;] = df_adapter[&#39;field_min_length&#39;]

    df_adapter.loc[df_adapter[&#39;type_record&#39;] != pds_code, &#39;list_column_de&#39;] = &#39;DE&#39; + df_adapter[&#39;de&#39;].astype(str)
    list_columns_de.extend(list_columns_base)
    list_columns_de.extend(df_adapter[df_adapter[&#39;list_column_de&#39;].notna()][&#39;list_column_de&#39;].drop_duplicates().values)
    df = df.filter(items=list_columns_de)
    df_adapter_pds = df_adapter[df_adapter[&#39;pds&#39;] == pds_code].reset_index(drop=True)
    table_name_pds = table_name_base + &#39;_&#39; + df_adapter_pds[&#39;type_record&#39;][0]
    for type_record in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
        df_new = pd.DataFrame()
        df_adapter_record = pd.DataFrame()
        select_df = pd.DataFrame()
        df_load = pd.DataFrame()
        filename_record = f&#34;FILES/ADAPTERS/{customer}_{file_type}_{number_file}_{type_record}_{filename}&#34;
        start_position_column_subfield = 0
        len_column_subfield = 0
        count = 0
        table_name = table_name_base + &#39;_&#39; + type_record
        df_adapter_record = df_adapter_record.join(df_adapter[(df_adapter[&#39;type_record&#39;]==type_record) &amp; (df_adapter[&#39;pds&#39;]&lt;pds_code)].sort_values(by=[&#39;de&#39;,&#39;subfield&#39;],ascending=True).reset_index(drop=True),how=&#39;right&#39;)
        list_row = df_adapter_record[&#39;message_type_identifier&#39;].drop_duplicates().values[0].split(&#39;,&#39;)
        select_df = select_df.join(df[df[&#39;MESSAGE_TYPE&#39;].str.startswith(tuple(list_row), na=False)].reset_index(drop=True),how=&#39;right&#39;)
        df_new = df_new.join(select_df[list_columns_base],how=&#39;right&#39;)
        for index,column_name in enumerate(df_adapter_record[&#39;column_name&#39;].values):
            if select_df.empty:
                continue

            len_column = 0
            if df_adapter_record[&#39;subfield&#39;][index] == 0: 
                len_column = df_adapter_record[&#39;field_max_length&#39;][index] if int(df_adapter_record[&#39;field_max_length&#39;][index]) &gt; 0 else df_adapter_record[&#39;field_min_length&#39;][index]
                start_position_column_subfield = 0
                start_position = 0
            else:
                if df_adapter_record[&#39;subfield&#39;][index] == 1:
                    start_position_column_subfield = 0
                len_column_subfield = df_adapter_record[&#39;subfield_max_length&#39;][index] if int(df_adapter_record[&#39;subfield_max_length&#39;][index]) &gt; 0 else df_adapter_record[&#39;subfield_min_length&#39;][index]
                start_position = start_position_column_subfield
                len_column = start_position + len_column_subfield
                start_position_column_subfield += len_column_subfield

            df_load = pd.concat([df_load,select_df[df_adapter_record[&#39;list_column_de&#39;][index]].str[start_position:len_column]],axis=1)
            df_load = df_load.rename(columns = {df_adapter_record[&#39;list_column_de&#39;][index] : column_name})
            if df_adapter_record[&#39;pds&#39;][index] == 1:
                pds_start_position_column_subfield = 0
                pds_len_column_subfield = 0
                df_adapter_pds = df_adapter_pds.sort_values(by=[&#39;de&#39;,&#39;subfield&#39;],ascending=True).reset_index(drop=True)
                list_columns_pds = df_adapter_pds[&#39;de&#39;].drop_duplicates().values
                df_load_sub = pd.DataFrame()
                df_load_sub = pd.concat([df_load_sub,self.mastercard_find_pds(select_df,list_columns_pds,df_adapter_record[&#39;list_column_de&#39;][index])],axis=1)
                for pds_index, pds_column_name in enumerate(df_adapter_pds[&#39;column_name&#39;].values):
                    df_column_pds = pd.DataFrame()
                    if not df_load_sub[df_load_sub[df_adapter_pds[&#39;de&#39;][pds_index]] !=&#39;&#39;].empty:
                        pds_len_column = 0
                        if df_adapter_pds[&#39;subfield&#39;][pds_index] == 0: 
                            pds_len_column = df_adapter_pds[&#39;field_max_length&#39;][pds_index] if int(df_adapter_pds[&#39;field_max_length&#39;][pds_index]) &gt; 0 else df_adapter_pds[&#39;field_min_length&#39;][pds_index]
                            pds_start_position_column_subfield = 0
                            pds_start_position = 0
                        else:
                            if df_adapter_pds[&#39;subfield&#39;][pds_index] == 1:
                                pds_start_position_column_subfield = 0
                            pds_len_column_subfield = df_adapter_pds[&#39;subfield_max_length&#39;][pds_index] if int(df_adapter_pds[&#39;subfield_max_length&#39;][pds_index]) &gt; 0 else df_adapter_pds[&#39;subfield_min_length&#39;][pds_index]
                            pds_start_position = pds_start_position_column_subfield
                            pds_len_column = pds_start_position + pds_len_column_subfield
                            pds_start_position_column_subfield += pds_len_column_subfield
                        df_load = pd.concat([df_load,df_load_sub[df_adapter_pds[&#39;de&#39;][pds_index]].str[pds_start_position:pds_len_column]],axis=1)
                        df_load = df_load.rename(columns = {df_adapter_pds[&#39;de&#39;][pds_index] : pds_column_name})
            count+=1
        if count&gt;0:
            df_new = pd.concat([df_new,df_load],axis=1)
            df_new = df_new.rename(columns = {&#39;app_client&#39;:&#39;app_customer_code&#39;,&#39;app_hash&#39;:&#39;app_hash_file&#39;,&#39;MESSAGE_TYPE&#39;:&#39;app_message_type&#39;,&#39;app_file_date&#39; : &#39;app_processing_date&#39;})
            str_columns = &#39;&#34;&#39; + &#39;&#34;,&#34;&#39;.join(map(str,list(df_new.columns.values))) + &#39;&#34;&#39;
            df_new.to_csv(filename_record,index=False, encoding=&#39;utf-8&#39;)
            self.s3.upload_object(bucket,filename_record,f&#34;adapters/{filename_record}&#34;,)
            
            result = self.ps.insert_from_csv(table_name,&#34;&#34;&#34;(format csv, header true, quote &#39;&#34;&#39; )&#34;&#34;&#34;,bucket,f&#34;adapters/{filename_record}&#34;,str_columns,False)
            result_message = f&#34;{type_record} : {len(df_new)} {result}&#34;
        if count==0:
            result_message = f&#34;{type_record} : data not found&#34;
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_apply_condition"><code class="name flex">
<span>def <span class="ident">visa_apply_condition</span></span>(<span>self, df: pandas.core.frame.DataFrame, column_apply_condition: str, list_condition: list, operator: str, skip_character: int, skip_columns: int, log_name: str = None, client: str = None) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Visa conditions applicator</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>df</code></strong> :&ensp;<code>dataframe</code></dt>
<dd>dataframe with data</dd>
<dt><strong><code>column_apply_condition</code></strong> :&ensp;<code>str</code></dt>
<dd>column conditions</dd>
<dt><strong><code>list_condition</code></strong> :&ensp;<code>list</code></dt>
<dd>list of conditions</dd>
<dt><strong><code>operator</code></strong> :&ensp;<code>str</code></dt>
<dd>operator for condition</dd>
<dt><strong><code>skip_character</code></strong> :&ensp;<code>int</code></dt>
<dd>characters to skip in reading</dd>
<dt><strong><code>skip_columns</code></strong> :&ensp;<code>int</code></dt>
<dd>columns to skip</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>pd.Dataframe</code></dt>
<dd>Dataframe with data</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_apply_condition(self, df : pd.DataFrame, column_apply_condition: str, list_condition : list ,operator : str , skip_character : int, skip_columns : int, log_name: str = None, client:str = None) -&gt; pd.DataFrame:
    &#34;&#34;&#34;Visa conditions applicator

    Args:
        df (dataframe): dataframe with data
        column_apply_condition (str): column conditions
        list_condition (list): list of conditions
        operator (str): operator for condition
        skip_character (int): characters to skip in reading
        skip_columns (int): columns to skip

    Returns:
        pd.Dataframe: Dataframe with data    
    
    &#34;&#34;&#34;
    if operator == &#39;&amp;&#39;:
        for value in list_condition:
            if value[0:1] == &#39;P&#39;:
                substring_condition = value[1:value.find(&#39; &#39;)].split(&#39;-&#39;)
                condition_start_position = int(substring_condition[0]) + skip_character
                condition_end_position = int(substring_condition[1]) + skip_character + 1
                string_condition_value = value[value.find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                df = df[df[column_apply_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value]
            if value[0:3] == &#39;TCR&#39;:
                list_string_condition = value.split(&#39;:&#39;)
                tcr_condition = list_string_condition[0].replace(&#39;TCR &#39;,&#39;&#39;)
                if tcr_condition == &#39;0&#39;:
                    column_condition = str(skip_columns)
                substring_condition = list_string_condition[1][2:list_string_condition[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                condition_start_position = int(substring_condition[0]) + skip_character
                condition_end_position = int(substring_condition[1]) + skip_character + 1
                string_condition_value = list_string_condition[1][list_string_condition[1].find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                df = df[df[column_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value]
        return df
    elif operator ==&#39;|&#39;:
        df_tmp = pd.DataFrame()
        df_tmp = df_tmp.join(df.head(0),how=&#39;right&#39;)
        for value in list_condition:
            df_condition_tmp = pd.DataFrame()
            if value[0:1] == &#39;P&#39;:
                substring_condition = value[1:value.find(&#39; &#39;)].split(&#39;-&#39;)
                condition_start_position = int(substring_condition[0]) + skip_character
                condition_end_position = int(substring_condition[1]) + skip_character + 1
                string_condition_value = value[value.find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                df_condition_tmp = df_condition_tmp.join(df[df[column_apply_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value],how=&#39;right&#39;)
            if value[0:3] == &#39;TCR&#39;:
                list_string_condition = value.split(&#39;:&#39;)
                tcr_condition = list_string_condition[0].replace(&#39;TCR &#39;,&#39;&#39;)
                if tcr_condition == &#39;0&#39;:
                    column_condition = str(skip_columns)
                substring_condition = list_string_condition[1][2:list_string_condition[1].find(&#39; =&#39;)].split(&#39;-&#39;)
                condition_start_position = int(substring_condition[0]) + skip_character
                condition_end_position = int(substring_condition[1]) + skip_character + 1
                string_condition_value = list_string_condition[1][list_string_condition[1].find(&#39;==&#39;)+3:].replace(&#39;  &#39;,&#39;_&#39;).replace(&#34;&#39;&#34;,&#39;&#39;)
                df_condition_tmp = df_condition_tmp.join(df[df[column_condition].str[condition_start_position:condition_end_position].replace(&#39;  &#39;,&#39;_&#39;) == string_condition_value],how=&#39;right&#39;)
            if not df_condition_tmp.empty:
                df_tmp = pd.concat([df_tmp,df_condition_tmp],ignore_index=True).drop_duplicates()
        if not df_tmp.empty:
            return df_tmp
        else:
            return df</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_clear_stg"><code class="name flex">
<span>def <span class="ident">visa_clear_stg</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Clean Visa staging tables for execution, returns message</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_clear_stg(self):
    &#34;&#34;&#34;Clean Visa staging tables for execution, returns message&#34;&#34;&#34;

    string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    table_name_adapter = &#39;control.t_visa_adapter&#39;
    table_name_stg_base = &#39;operational.stg_adapter_visa_transaction&#39;
    records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
    df_records = pd.DataFrame(records_adapter)
    for value in df_records[&#39;type_record&#39;].drop_duplicates().reset_index(drop=True).values:
        table_name = table_name_stg_base
        if value!=&#39;transaction&#39;:
            table_name += &#39;_&#39;+value
        log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    self.customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;ADAPTER OF VISA FILE&#34;,
                    &#34;INFO&#34;,
                    self.ps.truncate_table(table_name),
                    self.module
                )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_read_condition"><code class="name flex">
<span>def <span class="ident">visa_read_condition</span></span>(<span>self, condition: str, delimiter: str, log_name: str = None, client: str = None) ‑> list</span>
</code></dt>
<dd>
<div class="desc"><p>convert to a readable condition list</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>condition</code></strong> :&ensp;<code>str</code></dt>
<dd>string of conditions</dd>
<dt><strong><code>delimiter</code></strong> :&ensp;<code>str</code></dt>
<dd>conditions delimiter (&amp; or |)</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>list_return (list): readable condition list</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_read_condition(self, condition: str, delimiter: str, log_name: str = None, client:str = None) -&gt; list:
    &#34;&#34;&#34;convert to a readable condition list

    Args:
        condition (str): string of conditions
        delimiter (str): conditions delimiter (&amp; or |)

    Returns:
        list_return (list): readable condition list
    &#34;&#34;&#34;
    module = &#39;ADAPTER&#39;

    list_condition = []
    list_return = []
    list_condition = condition.split(delimiter)
    for string in list_condition:
        if string[0:1] == &#39;P&#39;:
            value_name = string[0:1]
            substring = string[1:string.find(&#39; &#39;)].split(&#39;-&#39;)
            string_start_position = int(substring[0])
            string_end_position = int(substring[1])
            if string.find(&#39;==&#39;)&gt;-1:
                value_start_position = string.find(&#39;==&#39;)
            if string.find(&#39;!=&#39;)&gt;-1:
                value_start_position = string.find(&#39;!=&#39;)
            string_value = string[value_start_position+3:].replace(&#34;&#39;&#34;,&#39;&#39;)
            string_tcr = None
            string_operator = string[value_start_position:value_start_position + 2]
        elif string[0:3] == &#39;TCR&#39;:
            value_name = string[0:3]
            list_string = string.split(&#39;:&#39;)
            string_tcr = list_string[0].replace(&#39;TCR &#39;,&#39;&#39;)
            substring = list_string[1][2:list_string[1].find(&#39; =&#39;)].split(&#39;-&#39;)
            string_value = list_string[1][list_string[1].find(&#39;==&#39;)+3:].replace(&#34;&#39;&#34;,&#39;&#39;)
            string_start_position = int(substring[0])
            string_end_position = int(substring[1])
            string_operator = &#39;==&#39;
        list_return.append({&#39;value_name&#39; : value_name,&#39;value_start_position&#39; : string_start_position, &#39;value_end_position&#39; : string_end_position, &#39;value&#39; : string_value, &#39;value_tcr&#39; : string_tcr, &#39;value_operator&#39; : string_operator})
    return list_return</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_read_sms"><code class="name flex">
<span>def <span class="ident">visa_read_sms</span></span>(<span>self, df: pandas.core.frame.DataFrame, list_columns: list, column_tcr: str, base_count: int, log_name: str = None, client: str = None) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>SMS type reading function</p>
<h2 id="args">Args</h2>
<dl>
<dt>df (dataframe) : dataframe with data</dt>
<dt><strong><code>list_columns</code></strong> :&ensp;<code>list</code></dt>
<dd>list of columns</dd>
<dt><strong><code>column_tcr</code></strong> :&ensp;<code>str</code></dt>
<dd>column with tcr data</dd>
<dt><strong><code>base_count</code></strong> :&ensp;<code>int</code></dt>
<dd>counter</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>pd.DataFrame</code></dt>
<dd>Dataframe with data</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_read_sms(self, df: pd.DataFrame , list_columns : list, column_tcr : str, base_count : int, log_name: str = None, client:str = None) -&gt; pd.DataFrame:
    &#34;&#34;&#34;SMS type reading function

    Args:
        df (dataframe) : dataframe with data
        list_columns (list): list of columns
        column_tcr (str): column with tcr data
        base_count (int): counter

    Returns:
        pd.DataFrame: Dataframe with data
    
    &#34;&#34;&#34;
    list_sms = []
    dict_sms = {}
    count = base_count
    module = &#39;ADAPTER&#39;

    for index, value in enumerate(df[column_tcr].values):
        if value[40:42] == &#39;00&#39;:
            if index &gt; 0:
                list_sms.append(dict_sms)
            dict_sms = {}
            count += 1
            dict_sms.update({list_columns[0] : count})
            for base in range(1,len(list_columns)):
                dict_sms.update({list_columns[base] : df[list_columns[base]].values[index]})
        dict_sms.update({value[36:42] : value})
    list_sms.append(dict_sms)
    return pd.DataFrame(list_sms)</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_upload_adapter"><code class="name flex">
<span>def <span class="ident">visa_upload_adapter</span></span>(<span>self, filename_parquet: str, file_type: str = 'in', hash_file: str = None, number_file: str = None, string_date: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Load visa adapter based on type as csv object</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>filename_parquet</code></strong> :&ensp;<code>str</code></dt>
<dd>local parquet file to read</dd>
<dt><strong><code>file_type</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file </dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
<dt><strong><code>number_file</code></strong> :&ensp;<code>str</code></dt>
<dd>number of file in queue</dd>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_upload_adapter(self, filename_parquet: str, file_type: str = &#39;in&#39;,hash_file:str = None, number_file:str = None, string_date:str = None)-&gt; str:
    &#34;&#34;&#34;Load visa adapter based on type as csv object
    
    Args:
        filename_parquet (str): local parquet file to read
        file_type (str): type of file 
        hash_file (str): hash code of file
        number_file (str): number of file in queue
        string_date (str): date of file

    Returns:
        str: Message

    &#34;&#34;&#34;
    try:
        module = &#39;ADAPTER&#39;
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            &#34;loading adapter file :&#34; + hash_file,
            self.module
        )

        bucket = self.structured
        table_name_adapter = &#39;control.t_visa_adapter&#39;
        table_name_stg_base = &#39;operational.stg_adapter_visa_transaction&#39;
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        records_adapter = self.ps.select(table_name_adapter,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;)
        df = pd.read_parquet(filename_parquet,engine=&#39;pyarrow&#39;)
        filename = &#39;adapter_visa.csv&#39;
        customer = self.customer_code
        skip_columns = 5
        skip_character = -1
        start_position_tcr = 3
        end_position_tcr = 4
        len_tcr = 2
        list_record = []
        list_record_tmp = []
        dict_record = []
        list_base = [&#39;0&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;]
        len_df = len(df.index)
        if file_type == &#39;in&#39;:
            skip_character += 2
            start_position_tcr += 2
            end_position_tcr += 2
            len_tcr += 2
        for record in records_adapter:
            record_tc = record[&#39;type_record&#39;]
            if record_tc not in list_record:
                list_record.append(record_tc)
                dict_record.append({&#39;tc&#39;:record[&#39;tc&#39;].replace(&#39; &#39;,&#39;&#39;) , &#39;type_record&#39; : record[&#39;type_record&#39;], &#39;condition_type_record&#39; : record[&#39;condition_type_record&#39;]})
        for value in dict_record:
            list_record_tmp+=value[&#39;tc&#39;].split(&#39;,&#39;)
        for row in dict_record:
            table_name = table_name_stg_base

            if row[&#39;type_record&#39;]!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+row[&#39;type_record&#39;]
            count_data_tc = 0
            filename_record = f&#34;FILES/ADAPTERS/{customer}_{file_type}_{number_file}_{row[&#39;type_record&#39;]}_{filename}&#34;
            dfnew = pd.DataFrame()
            list_row = row[&#39;tc&#39;].split(&#39;,&#39;)
            select_df = self.visa_apply_condition(df[df[str(skip_columns)].str.startswith(tuple(list_row), na=False)].reset_index(drop=True),str(skip_columns),str(row[&#39;condition_type_record&#39;]).split(&#39;&amp;&#39;),&#39;&amp;&#39;,skip_character,skip_columns)
            dfnew = dfnew.join(select_df[list_base].head(0),how=&#39;right&#39;)
            if row[&#39;type_record&#39;] == &#39;sms&#39;:
                df_sms = self.visa_read_sms(select_df,list_base,str(skip_columns), len_df)
            for record in records_adapter:
                str_tc = record[&#39;tc&#39;].replace(&#39; &#39;,&#39;&#39;)
                str_type_record = record[&#39;type_record&#39;]
                if str_tc==row[&#39;tc&#39;] and str_type_record == row[&#39;type_record&#39;]:
                    str_tcr = record[&#39;tcr&#39;].replace(&#39; &#39;,&#39;&#39;)
                    string_condition = str(record[&#39;additional_condition&#39;])
                    if record[&#39;position&#39;]&gt;2 or file_type == &#39;out&#39;:
                        start_position_column = record[&#39;position&#39;] + skip_character
                        end_position_column = record[&#39;position&#39;] + record[&#39;length&#39;] + skip_character
                    else:
                        start_position_column = record[&#39;position&#39;] - skip_character
                        end_position_column = record[&#39;position&#39;] + record[&#39;length&#39;] - skip_character
                    name_column = str(record[&#39;column_name&#39;]).replace(&#39;,&#39;,&#39;&#39;).replace(&#39;\n&#39;,&#39;&#39;)
                    for column in select_df:
                        if select_df[column].count()&gt;0:
                            str_row_max_len = select_df[column].str.len().max()
                            if str_row_max_len&gt;len_tcr and int(column)&gt;=skip_columns:
                                df_column = pd.DataFrame()
                                df_condition = pd.DataFrame()
                                count_data_column = 0
                                count_df_condition = 0
                                str_temp = list(filter(lambda col: col!= None,select_df[column].str[start_position_tcr:end_position_tcr].drop_duplicates().to_list()))
                                if record[&#39;type_record&#39;] == &#39;header&#39;:
                                    df_column = df_column.join(select_df[list_base],how=&#39;right&#39;)
                                    df_column[name_column] = select_df[str(skip_columns)].str[start_position_column:end_position_column]
                                    dfnew = pd.merge(dfnew,df_column,how=&#39;outer&#39;)
                                    count_data_tc+=1
                                    break
                                if str_temp[0] == str_tcr:
                                    select_df_tmp = pd.DataFrame()
                                    list_condition = []
                                    
                                    if string_condition.find(&#39;&amp;&#39;) != -1:
                                        list_condition = string_condition.split(&#39;&amp;&#39;)
                                        select_df_tmp = select_df_tmp.join(self.visa_apply_condition(select_df,column,list_condition[1].split(&#39;|&#39;),&#39;&amp;&#39;,skip_character,skip_columns),how=&#39;right&#39;)
                                    else:
                                        select_df_tmp = select_df_tmp.join(select_df,how=&#39;right&#39;)
                                    string_condition_sub = string_condition.split(&#39;&amp;&#39;)
                                    if (string_condition_sub[0].find(&#39;|&#39;) != -1 or len(string_condition_sub[0])&gt;0):
                                        list_condition = string_condition_sub[0].split(&#39;|&#39;)
                                        if row[&#39;type_record&#39;] == &#39;sms&#39;:
                                            list_sms = self.visa_read_condition(string_condition_sub[0],&#39;|&#39;)
                                            df_condition = df_condition.join(df_sms,how=&#39;right&#39;)
                                            column = list_sms[0][&#39;value&#39;]
                                            if len(list_sms)&gt;1 and column in df_condition.columns.values:
                                                if list_sms[1][&#39;value_operator&#39;] == &#39;!=&#39;:
                                                    df_condition.loc[df_condition[column].str[list_sms[1][&#39;value_start_position&#39;] - skip_character:list_sms[1][&#39;value_end_position&#39;]] != list_sms[1][&#39;value&#39;],column] = df_condition[column]
                                                if list_sms[1][&#39;value_operator&#39;] == &#39;==&#39;:
                                                    df_condition.loc[df_condition[column].str[list_sms[1][&#39;value_start_position&#39;] - skip_character:list_sms[1][&#39;value_end_position&#39;]] == list_sms[1][&#39;value&#39;],column] = df_condition[column]
                                                count_df_condition = df_condition[column].count()
                                        else:
                                            df_condition = df_condition.join(self.visa_apply_condition(select_df_tmp,column,list_condition,&#39;|&#39;,skip_character,skip_columns),how=&#39;right&#39;)
                                            count_df_condition = df_condition[column].count()
                                        df_column = df_column.join(df_condition[list_base],how=&#39;right&#39;)

                                        if count_df_condition&gt;0:
                                            df_column[name_column] = df_condition[column].str[start_position_column:end_position_column]
                                            count_data_column += 1
                                        else:
                                            df_column[name_column] = nan
                                    else:
                                        df_column = df_column.join(select_df_tmp[list_base],how=&#39;right&#39;)

                                        df_column[name_column] = select_df_tmp[column].str[start_position_column:end_position_column]
                                        count_data_column += 1
                                    if count_data_column&gt;0:
                                        dfnew = pd.merge(dfnew,df_column,how=&#39;outer&#39;)
                                        df_column = df_column[df_column[name_column].notna()]
                                        count_data_tc+=1
                                    break
            if count_data_tc &gt; 0:
                dfnew = dfnew.rename(columns = {&#39;0&#39;:&#39;app_id&#39;,&#39;1&#39;:&#39;app_customer_code&#39;,&#39;2&#39;:&#39;app_type_file&#39;,&#39;3&#39;:&#39;app_hash_file&#39;,&#39;4&#39;:&#39;app_processing_date&#39;})
                str_columns = &#39;&#34;&#39; + &#39;&#34;,&#34;&#39;.join(map(str,list(dfnew.columns.values))) + &#39;&#34;&#39;
                dfnew.to_csv(filename_record,index=False,encoding=&#39;utf-8&#39;)
                self.s3.upload_object(bucket,filename_record,f&#34;adapters/{filename_record}&#34;,)
                result = self.ps.insert_from_csv(table_name,&#34;&#34;&#34;(format csv, header true, quote &#39;&#34;&#39; )&#34;&#34;&#34;,bucket,f&#34;adapters/{filename_record}&#34;,str_columns,False)
                result_message = f&#34;{row[&#39;type_record&#39;]} : {len(dfnew)} {result}&#34;
            else:
                result_message = f&#34;{row[&#39;type_record&#39;]} : data not found&#34;
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
            )
        return &#39;finished&#39;
    except Exception as e:   
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            &#34;error loading adapter file :&#34; + hash_file
            + &#34; | exception reading file: &#34;
            + str(e),
            self.module
        )</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others"><code class="flex name class">
<span>class <span class="ident">get_others</span></span>
<span>(</span><span>customer_code: str, log_name: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Class for other methods relationated to adpaters</p>
<h2 id="params">Params</h2>
<p>customer_code (str): customer code
log_name (str): name of logs</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class get_others:
    &#34;&#34;&#34;Class for other methods relationated to adpaters
    
    Params:
        customer_code (str): customer code
        log_name (str): name of logs
    &#34;&#34;&#34;
    def __init__(self, customer_code: str, log_name: str):
   
        load_dotenv()
        self.ps = con.connect_to_postgreSQL()
        self.s3 = con.connect_to_s3()
        self.structured = os.getenv(&#34;STRUCTURED_BUCKET&#34;)
        self.log = os.getenv(&#34;LOG_BUCKET&#34;)
        self.customer_code = customer_code
        self.log_name = log_name
        self.module = &#39;ADAPTER&#39;
        self.region_country_global=&#39;9&#39;
        self.debug = os.getenv(&#34;DEBUG&#34;)
        print(os.getenv(&#34;DEBUG&#34;))

    
    def update_column_table_from_adapter(self, adapter_column_base:list, adapter_table_scheme:str, adapter_table_name: str, table_scheme: str, table_name: str, type_record: str, column_type: bool = False, column_format: bool = False, column_partition: str = None, partition_type: str = None, adapter_where: str = None, adapter_order: str = None,log_name: str = None, client:str = None)-&gt;str:
        &#34;&#34;&#34;Update columns from the adapter
        
        Args:
            adapter_column_base (list): List of columns for adapter
            adapter_table_scheme (str): adapter schema for table
            adapter_table_name (str): adapter table name
            table_scheme (str): temporal table schema
            table_name (str): temporal table name
            type_record (str): type of record
            column_type (bool): column type indicator
            column_format (bool): column format indicator
            column_partition (str): column for partition
            partition_type (str): type of partition
            adapter_where (str): condition for adapter query 
            adapter_order (str): column order by for adapter query

        Returns:
            result_message (str): Message
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_columns_name = &#39;column_name, length, column_type&#39;
        list_table_y = []
        list_table_x = []
        if adapter_where==None:
            adapter_where=&#39;&#39;
        if adapter_order==None:
            adapter_order=&#39;&#39;
        if column_format:
            adapter_columns_name = &#34; replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(column_name,&#39;]&#39;,&#39;&#39;),&#39;[&#39;,&#39;&#39;),&#39;.&#39;,&#39;&#39;),&#39;&#39;&#39;&#39;,&#39;&#39;),&#39;)&#39;,&#39;&#39;),&#39;(&#39;,&#39;&#39;),&#39;/&#39;,&#39;&#39;),&#39;-&#39;,&#39;_&#39;),&#39; &#39;,&#39;_&#39;),&#39;___&#39;,&#39;_&#39;),&#39;__&#39;,&#39;_&#39;) as column_name,length,column_type,column_decimal&#34;
        list_table_y.extend(adapter_column_base)
        list_table_x = self.ps.get_structure_table_from_db(table_scheme,table_name)
        list_table_y.extend(self.ps.select(adapter_table,f&#34;where type_record = &#39;{type_record}&#39; {adapter_where} {adapter_order}&#34;,adapter_columns_name))
        df_x = pd.DataFrame(list_table_x)
        df_y = pd.DataFrame(list_table_y)
        if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):
            self.ps.create_table(list_table_y,table_scheme+&#39;.&#39;+table_name,column_type,column_partition,partition_type)  

            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                &#34;table created : &#34;
                + table_scheme
                + &#34;.&#34;
                + table_name,
                self.module
            )

            return self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,type_record,column_format=column_format,adapter_where=adapter_where,adapter_order=adapter_order)
        if len(df_x) != len(df_y):
            list_table_difference = []
            for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                if not value in (df_x[&#39;column_name&#39;].values):
                    list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
            result_message = self.ps.add_column(list_table_difference,table_scheme,table_name)
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
            )
            if len(df_x)&lt;=len(df_y):
                return self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,type_record,column_format=column_format,adapter_where=adapter_where,adapter_order=adapter_order)
            result_message = f&#39;columns difference to table : {table_scheme}.{table_name}&#39;
        if len(df_x) == len(df_y):
            list_table_difference = []
            for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                if value in (df_x[&#39;column_name&#39;].values):
                    if str(df_x[df_x[&#39;column_name&#39;] == df_y[&#39;column_name&#39;][index]][&#39;data_type&#39;].values[0]).replace(&#39;character varyinresult_messageg&#39;,&#39;varchar&#39;) != df_y[&#39;column_type&#39;][index]:
                        list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
            result_message = f&#39;{len(list_table_difference)} columns difference to table : {table_scheme}.{table_name}&#39;
        return result_message

    def visa_config_table_adapter_dh(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the visa adapter table dh
        
        Args:
           string_start_date (str): starting date for range  
           string_end_date (str): ending date for range

        Returns:
            str: Message
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_visa_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_start_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_visa_transaction&#39;
            if value[&#39;type_record&#39;]!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value[&#39;type_record&#39;]
            result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],True,True,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by type_record,tcr,position,column_name&#39;)
            customer_code = self.customer_code
            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)
        
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )
                     
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )          
                            
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )                        
            
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )                   
            
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_idx&#39;,&#39;app_id,app_hash_file&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )
            
        message_index = self.ps.create_table_index(table_scheme,&#39;dh_visa_transaction&#39;,&#39;dh_visa_transaction_account_number_idx&#39;,&#39;account_number&#39;)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )          
        
        message_create_table_index = self.ps.create_table_index(table_scheme,&#39;dh_visa_transaction_sms&#39;,&#39;dh_visa_transaction_sms_card_number_idx&#39;,&#39;card_number&#39;)
        
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_create_table_index),
            self.module
            )        
    
        return &#39;finished&#39;
    def visa_config_table_adapter_stg(self, string_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the visa adapter table staging
        
        Args:
           string_date (str): date for range  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_visa_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;text&#39;}]
        table_scheme = &#39;operational&#39;
        table_name_base = &#39;stg_adapter_visa_transaction&#39;
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_name = table_name_base

            if value[&#39;type_record&#39;]!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value[&#39;type_record&#39;]             
            
            message_update = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],False,False,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by type_record,tcr,position,column_name&#39;)
                         
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_update),
            self.module
            )                      
            
            customer_code = self.customer_code

            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )      


        return &#39;finished&#39;
    def mastercard_config_table_adapter_stg(self, string_date : str = None,log_name: str = None, client:str = None)-&gt;str:
        &#34;&#34;&#34;Configuration of the mastercard adapter table staging
        
        Args:
           string_date (str): date for range  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_message_type&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;text&#39;}]
        table_scheme = &#39;operational&#39;
        table_name_base = &#39;stg_adapter_mastercard&#39;
        module = &#39;ADAPTER&#39;

        pds_code = &#39;2&#39;
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where pds &lt;{pds_code} and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_name = table_name_base + &#39;_&#39; + value[&#39;type_record&#39;]        
                 
            result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],False,False,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by pds,de&#39;)
               
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            )             
           
            customer_code = self.customer_code

            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )         

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )         

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )         

        return &#39;finished&#39;
    def mastercard_config_table_adapter_dh(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the mastercard adapter table dh
        
        Args:
            string_start_date (str): starting date for range  
            string_end_date (str): ending date for range 

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_message_type&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        module = &#39;ADAPTER&#39;
        &#34;&#34;&#34;log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        &#34;Operational table configuration: &#34;
        + adapter_table_scheme
        + &#34;.&#34;
        + adapter_table_name,
        self.module
        )   &#34;&#34;&#34;
          
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_start_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date) and type_record&lt;&gt;&#39;private_data_subelement&#39;&#34;,&#39;distinct type_record&#39;)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        for value in list_type_record:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_mastercard&#39;
            table_name += &#39;_&#39;+value[&#39;type_record&#39;]
            result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],True,True,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by pds,de&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            )         
            customer_code = self.customer_code

            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  


            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  




            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )  

            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_partition),
            self.module
            )
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_idx&#39;,&#39;app_id,app_hash_file&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )
            message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_index),
            self.module
            )

        message_index = self.ps.create_table_index(table_scheme,&#39;dh_mastercard_data_element&#39;,&#39;dh_mastercard_data_pan_idx&#39;,&#39;pan&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        ) 
        return &#39;finished&#39;

    def visa_load_transaction(self, string_date: str = None,type_file: str = None)-&gt;str:
        &#34;&#34;&#34;Load of visa transaction
        
        Args:
            string_date (str): date for range condition  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_visa_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        hash_file = &#39;45b9c08a79b0a9ffc3803433b6cf241b86acb2aa94c78f51fe7147ed18a1423b&#39;
        number_file = &#39;1&#39;
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading transactions type file : &#34;+ type_file,
        self.module
        )   
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
        for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_visa_transaction&#39;
            table_name_stg = &#39;stg_adapter_visa_transaction&#39;
            if value!=&#39;transaction&#39;:
                table_name += &#39;_&#39;+value
                table_name_stg += &#39;_&#39;+value
            df_structure_dh = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name,&#39;order by column_name&#39;))
            df_structure_stg = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name_stg,&#39;order by column_name&#39;))
            select_query = &#39;select &#39;
            left_query = &#39;&#39;
            str_column_dh = &#39;&#39;
            for column in df_structure_stg[&#39;column_name&#39;].values:
                if column in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;):
                    continue
                str_column_format = column.replace(&#39;]&#39;,&#39;&#39;).replace(&#39;[&#39;,&#39;&#39;).replace(&#39;.&#39;,&#39;&#39;).replace(&#34;&#39;&#34;,&#39;&#39;).replace(&#39;)&#39;,&#39;&#39;).replace(&#39;(&#39;,&#39;&#39;).replace(&#39;/&#39;,&#39;&#39;).replace(&#39;-&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;_&#39;).replace(&#39;___&#39;,&#39;_&#39;).replace(&#39;__&#39;,&#39;_&#39;) + &#39;,&#39;
                str_column_dh += str_column_format
                column = f&#39;&#34;{column}&#34;&#39;
                if column == &#39;&#34;app_id&#34;&#39;:
                    column =&#39;a.app_id::numeric&#39;
                elif column in (&#39;&#34;app_customer_code&#34;&#39;,&#39;&#34;app_type_file&#34;&#39;,&#39;&#34;app_hash_file&#34;&#39;,&#39;&#34;app_creation_user&#34;&#39;,&#39;&#34;app_creation_date&#34;&#39;):
                    column = &#39;a.&#39;+column.replace(&#39;&#34;&#39;,&#39;&#39;)
                elif column == &#39;&#34;app_processing_date&#34;&#39;:
                    column = f&#34;to_date(app_processing_date,&#39;yyyy-mm-dd&#39;)&#34;
                elif column == &#39;&#34;account number&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                elif column == &#39;&#34;account number extension&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                elif column == &#39;&#34;account reference number date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} is not null then 
                            case 
                                when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;purchase date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} &lt;&gt; &#39;0000&#39; then 
                            case 
                                when left({column},2)::integer&lt;=substr(app_processing_date,6,2)::integer then to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||{column},&#39;yyyymmdd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;destination amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
                elif column == &#39;&#34;source amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
                elif column == &#39;&#34;central processing date&#34;&#39;:
                    column = f&#34;to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)&#34;
                elif column == &#39;&#34;national reimbursement fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
                elif column == &#39;&#34;conversion date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} &lt;&gt; &#39;0000&#39; then 
                            case 
                                when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;merchant country code&#34;&#39;:
                    column = f&#34;trim({column})&#34;
                elif column == &#39;&#34;surcharge amount sp&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount sd&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount in cardholder billing currency sp&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount in cardholder billing currency sd&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount df&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;money transfer foreign exchange fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;authorized amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;total authorized amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;interchange fee amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;source currency to base currency exchange rate&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;base currency to destination currency exchange rate&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;optional issuer isa amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;local tax&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;national tax&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;other tax&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;settlement date&#34;&#39;:
                    column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;report date 140&#34;&#39;:
                    column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;report date 110&#34;&#39;:
                    column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;credit amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;debit amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange amount (settlement currency) 140&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange amount (settlement currency) 130&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;clearing amount (clearing currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange value credits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;visa charges credits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;reimbursement fee credits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;visa charges debits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;reimbursement fee debits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;interchange value debits (settlement currency)&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
                elif column == &#39;&#34;processing date header&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yyddd&#39;)&#34;
                elif column == &#39;&#34;processing date&#34;&#39;:
                    column = f&#34;case when {column} &lt;&gt;&#39;00000&#39; then to_date({column},&#39;yyddd&#39;) end&#34;
                elif column == &#39;&#34;destination amount trailer&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;source amount trailer&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;rate table date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} is not null then 
                            case 
                                when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;local transaction date&#34;&#39;:
                    column = f&#34;&#34;&#34;
                    case 
                        when {column} is not null then 
                            case 
                                when left({column},2)::integer&lt;=substr(app_processing_date,6,2)::integer then to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)
                                else to_date((left(app_processing_date,4)::integer - 1)::varchar||{column},&#39;yyyymmdd&#39;)
                            end
                    end
                    &#34;&#34;&#34;
                elif column == &#39;&#34;online settlement date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;plus settlement date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;mmddyy&#39;)&#34;
                elif column == &#39;&#34;reimbursement fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;transaction amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;filed 54 - original amount - clearing currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;transmission date&#34;&#39;:
                    column = f&#34;to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)&#34;
                elif column == &#39;&#34;settlement amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;transaction integrity fee&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;surcharge amount sms&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;terminal transaction date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;settlement date sms&#34;&#39;:
                    column = f&#34;to_date({column},&#39;mmddyy&#39;)&#34;
                elif column == &#39;&#34;cardholder billing amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;vss processing date&#34;&#39;:
                    column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;cryptogram amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;pre-currency conversion amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;cardholder bililng other amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;cryptogram cashback amount&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;optional issuer fee - settlement currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;optional issuer fee - cardholder billing currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;optional issuer isa amount in settlement currency&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                    column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
                elif column == &#39;&#34;card number&#34;&#39;:
                    column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::numeric&#34;
                else:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    if df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0] in [&#39;numeric&#39;,&#39;integer&#39;,&#39;bigint&#39;]:
                        column = f&#34;case when operational.isnumeric({column}) then {column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]} end&#34;
                    else:
                        column = f&#34;{column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                select_query += f&#39; {column},&#39;
            if value in [&#39;vss_110&#39;,&#39;vss_120&#39;,&#39;vss_130&#39;,&#39;vss_140&#39;]:
                vss_report_code = value[-3:]
                left_query = f&#39;left join operational.m_currency c on (c.currency_numeric_code = case when operational.isnumeric(a.&#34;settlement currency code {vss_report_code}&#34;) then a.&#34;settlement currency code {vss_report_code}&#34;::integer end)&#39;
            
            str_column_dh = str_column_dh[:-1]
            insert_query = f&#39;insert into {table_scheme}.{table_name} ({str_column_dh}) &#39;
            select_query = select_query[:-1] + f&#39; from {table_scheme}.{table_name_stg}_{customer_code}_{type_file} a &#39;
            query = insert_query + select_query + left_query
            partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
            result_message = self.ps.insert(query,[(table_name)])

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            ) 
            result_message = str(self.ps.table_count(table_scheme,f&#39;{table_name}_{customer_code}_{type_file}&#39;)) +&#39; &#39; + result_message + &#39; &#39; + table_name
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        return &#39;finished&#39;

    def mastercard_load_transaction(self, string_date: str = None,type_file:str=None, hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Load of mastercard transaction
        
        Args:
            string_date (str): date for range condition  

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading transactions type file : &#34;+ type_file,
        self.module
        ) 

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
        for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_mastercard&#39;
            table_name_stg = &#39;stg_adapter_mastercard&#39;
            table_name += &#39;_&#39;+value
            table_name_stg += &#39;_&#39;+value
            df_structure_dh = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name,&#39;order by column_name&#39;))
            df_structure_stg = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name_stg,&#39;order by column_name&#39;))

            select_query = &#39;select &#39;
            left_query = &#39;&#39;
            str_column_dh = &#39;&#39;
            for column in df_structure_stg[&#39;column_name&#39;].values:
                if column in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;):
                    continue
                str_column_format = column.replace(&#39;]&#39;,&#39;&#39;).replace(&#39;[&#39;,&#39;&#39;).replace(&#39;.&#39;,&#39;&#39;).replace(&#34;&#39;&#34;,&#39;&#39;).replace(&#39;)&#39;,&#39;&#39;).replace(&#39;(&#39;,&#39;&#39;).replace(&#39;/&#39;,&#39;&#39;).replace(&#39;-&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;_&#39;).replace(&#39;___&#39;,&#39;_&#39;).replace(&#39;__&#39;,&#39;_&#39;) + &#39;,&#39;
                str_column_dh += str_column_format
                column = f&#39;&#34;{column}&#34;&#39;
                if column == &#39;&#34;app_id&#34;&#39;:
                    column =&#39;a.app_id::numeric&#39;
                elif column in (&#39;&#34;app_customer_code&#34;&#39;,&#39;&#34;app_type_file&#34;&#39;,&#39;&#34;app_hash_file&#34;&#39;,&#39;&#34;app_message_type&#34;&#39;,&#39;&#34;app_creation_user&#34;&#39;,&#39;&#34;app_creation_date&#34;&#39;):
                    column = &#39;a.&#39;+column.replace(&#39;&#34;&#39;,&#39;&#39;)
                elif column == &#39;&#34;app_processing_date&#34;&#39;:
                    column = f&#34;to_date(app_processing_date,&#39;yymmdd&#39;)&#34;
                elif column == &#39;&#34;pan&#34;&#39;:
                    column = f&#34;case when operational.isnumeric(replace({column},&#39;*&#39;,&#39;0&#39;)) then replace({column},&#39;*&#39;,&#39;0&#39;)::bigint end&#34;
                elif column == &#39;&#34;amount transaction&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amount reconciliation&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amount cardholder billing&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;conversion rate reconciliation&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then substr({column},2)::numeric/(10^left({column},1)::numeric) end&#34;
                elif column == &#39;&#34;conversion rate cardholder billing&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then substr({column},2)::numeric/(10^left({column},1)::numeric) end&#34;
                elif column == &#39;&#34;amount net transaction in reconciliation currency 2&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amounts transaction fee 5&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amounts transaction fee 7&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;amount net fee in reconciliation currency 2&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
                elif column == &#39;&#34;date and time local transaction&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_timestamp({column},&#39;YYMMDDhh24miss&#39;) end&#34;
                elif column == &#39;&#34;date action&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;amount currency conversion assessment&#34;&#39;:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
                elif column == &#39;&#34;business activity 5&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;settlement data 6&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;settlement data 8&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                elif column == &#39;&#34;business date&#34;&#39;:
                    column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
                else:
                    column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                    if df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0] in [&#39;numeric&#39;,&#39;integer&#39;,&#39;bigint&#39;,&#39;timestamp&#39;,&#39;date&#39;]:
                        column = f&#34;case when operational.isnumeric({column}) then {column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]} end&#34;
                    else:
                        column = f&#34;{column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
                select_query += f&#39; {column},&#39;
            
            left_query = f&#34;&#34;&#34;
            left join operational.m_currency c on (c.currency_numeric_code = case when operational.isnumeric(a.&#34;currency code transaction&#34;) then a.&#34;currency code transaction&#34;::integer end) 
            left join operational.m_currency d on (d.currency_numeric_code = case when operational.isnumeric(a.&#34;currency code reconciliation&#34;) then a.&#34;currency code reconciliation&#34;::integer end) 
            &#34;&#34;&#34;
            str_column_dh = str_column_dh[:-1]
            insert_query = f&#39;insert into {table_scheme}.{table_name} ({str_column_dh}) &#39;
            select_query = select_query[:-1] + f&#39; from {table_scheme}.{table_name_stg}_{customer_code}_{type_file} a &#39;
            query = insert_query + select_query + left_query
            partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
            result_message = self.ps.insert(query,[(table_name)])

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(result_message),
            self.module
            )
            result_message = str(self.ps.table_count(table_scheme,f&#39;{table_name}_{customer_code}_{type_file}&#39;)) +&#39; &#39; + result_message + &#39; &#39; + table_name
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        return &#39;finished&#39;

    def mastercard_load_exclusion_transaction(self, string_date: str = None,type_file:str=None, hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Load of mastercard excluded transaction
        
        Args:
            string_date (str): date for range condition  
            type_file (str): Type of file
            type_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        module = &#39;ADAPTER&#39;
        adapter_table_scheme = &#39;control&#39;
        adapter_table_name = &#39;t_mastercard_adapter&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;mastercard file&#34;,
        &#34;INFO&#34;,
        f&#34;loading exclusion transactions type file : {type_file}&#34;,
        self.module
        ) 

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
        df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
        for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
            table_scheme = &#39;operational&#39;
            table_name = &#39;dh_mastercard_exclusion_messages&#39;

            select_query = f&#34;select app_id,app_customer_code,app_type_file,app_hash_file,app_processing_date,source_message_number_id,source_file_id from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date}  where app_message_type = &#39;1644&#39; and function_code =691&#34;
            
            table_tmp = f&#39;tmp_exclusion_transactions_{customer_code}&#39;
            partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
            self.ps.drop_table(table_tmp)
            self.ps.create_table_from_select(select_query,table_tmp)
            result_message = str(self.ps.insert_from_table(&#34;temporal&#34;, table_tmp, table_scheme, table_name))

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        return &#39;finished&#39;
    
    def config_additional_table(self, string_start_date : str = None, string_end_date : str = None, config_table_name : str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the additional tables
        Args:
            string_start_date (str): start date for range condition  
            string_end_date (str): ending date for range condition
            config_table_name (str): name of table to config

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;operational&#39;
        adapter_table_name = &#39;additional_tables_structure&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        list_except_table_type = [&#39;exchange_rate&#39;]
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_table = self.ps.select(adapter_table,&#39; order by table_name,column_order&#39;)
        df_table = pd.DataFrame(list_table)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        table_scheme = &#39;operational&#39;
        for table_name in df_table[&#39;table_name&#39;].drop_duplicates().values:
            columns = []
            table_type = df_table[df_table[&#39;table_name&#39;] == table_name].reset_index(drop=True)[&#39;table_type&#39;][0]
            table_frequency = df_table[df_table[&#39;table_name&#39;] == table_name].reset_index(drop=True)[&#39;table_load_frequency&#39;][0]
            customer_code = self.customer_code
            if config_table_name != None and config_table_name != table_name:
                continue
            columns.extend(column_base)
            for column_name in df_table[df_table[&#39;table_name&#39;] == table_name][&#39;column_name&#39;]:
                df_row = df_table[(df_table[&#39;table_name&#39;] == table_name) &amp; (df_table[&#39;column_name&#39;]== column_name)].reset_index(drop=True)
                columns.append({&#39;column_name&#39;:df_row[&#39;column_name&#39;][0],&#39;length&#39;:df_row[&#39;column_length&#39;][0],&#39;column_type&#39;:df_row[&#39;column_type&#39;][0],&#39;column_decimal&#39;:df_row[&#39;column_decimal&#39;][0]})
            if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):
                if table_type in list_except_table_type:
                    result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_processing_date&#39;,&#39;range&#39;)
                else:
                    result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_customer_code&#39;,&#39;list&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA AND MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
                )
            df_x = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name))
            df_y = pd.DataFrame(columns)
            if len(df_x) != len(df_y):
                list_table_difference = []
                for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                    if not value in (df_x[&#39;column_name&#39;].values):
                        list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
                result_message = self.ps.add_column(list_table_difference,table_scheme,table_name)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                self.customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA AND MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
                )

            if table_type == &#39;transaction&#39;:
                partition_name = table_name+&#39;_&#39;+customer_code
                message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )

                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
     
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date,table_frequency)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )


                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date,table_frequency)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )


            elif table_type in list_except_table_type:
                partition_name = table_name
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name,table_scheme,partition_name,string_start_date,string_end_date,table_frequency)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                table_type,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
                message_create_table_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
            else:
                partition_name = table_name+&#39;_&#39;+customer_code
                message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )
                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_&#39;+table_type,f&#34;&#39;{table_type}&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )      
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_&#39;+table_type,table_scheme,partition_name+&#39;_&#39;+table_type,string_start_date,string_end_date,table_frequency)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )      
        
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            str(message_create_table_index),
            self.module
            )   
        return &#39;finished&#39;

    def config_additional_table_others(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
        &#34;&#34;&#34;Configuration of the other additional tables
        
        Args:
            string_start_date (str): start date for range condition  
            string_end_date (str): ending date for range condition

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        adapter_table_scheme = &#39;operational&#39;
        adapter_table_name = &#39;additional_tables_structure&#39;
        adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
        column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
        if string_start_date == None:
            string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        if string_end_date == None:
            string_end_date = string_start_date
        customer_table = &#39;control.t_customer&#39;
        list_table = self.ps.select(adapter_table,&#39; order by table_name,column_order&#39;)
        df_table = pd.DataFrame(list_table)
        list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
        table_scheme = &#39;operational&#39;
        for table_name in df_table[&#39;table_name&#39;].drop_duplicates().values:
            columns = []
            columns.extend(column_base)
            for column_name in df_table[df_table[&#39;table_name&#39;] == table_name][&#39;column_name&#39;]:
                df_row = df_table[(df_table[&#39;table_name&#39;] == table_name) &amp; (df_table[&#39;column_name&#39;]== column_name)].reset_index(drop=True)
                columns.append({&#39;column_name&#39;:df_row[&#39;column_name&#39;][0],&#39;length&#39;:str(int(df_row[&#39;column_length&#39;][0])),&#39;column_type&#39;:df_row[&#39;column_type&#39;][0],&#39;column_decimal&#39;:str(int(df_row[&#39;column_decimal&#39;][0]))})
            if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):

                result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_customer_code&#39;,&#39;list&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                result_message,
                self.module
                )    

            df_x = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name))
            df_y = pd.DataFrame(columns)
            if len(df_x) != len(df_y):
                list_table_difference = []
                for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                    if not value in (df_x[&#39;column_name&#39;].values):
                        list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
                message_column = self.ps.add_column(list_table_difference,table_scheme,table_name)

                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_column,
                self.module
                )    


            for customer in list_customer:
                customer_code = customer[&#39;code&#39;]
                partition_name = table_name+&#39;_&#39;+customer_code
                message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )    

                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )    
                message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )  
                message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
                
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )      
       
                message_partition  = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)
        
                log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA AND MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                message_partition,
                self.module
                )  
        
        
        return &#39;finished&#39;

    def visa_load_calculated_field_dh(self, string_date: str = None, type_file: str = None, hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message

        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)

        log.logs().exist_file(&#34;OPERATIONAL&#34;,self.customer_code,&#34;VISA&#34;,self.log_name,&#34;ADAPTER OF VISA FILE&#34;,&#34;INFO&#34;,f&#34;calculating field {table_scheme}.{table_name}&#34;,self.module)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        
        query_tmp = f&#34;&#34;&#34;
        with ardef_pre_1 as (
            select distinct 
            app_date_valid,
            rpad(left(trim(low_key_for_range),9),16,&#39;0&#39;)::BIGINT low_key_for_range,
            rpad(left(trim(table_key),9),16,&#39;9&#39;)::BIGINT high_key_for_range,
            ardef_country, a.account_funding_source,a.product_id,a.delete_indicator
            ,country issuer_country
            ,technology_indicator
            ,fast_funds
            ,travel_indicator
            ,b2b_program_id
            ,nnss_indicator
            ,product_subtype
            from operational.dh_visa_ardef a
            where app_date_valid&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
            --group by 1,2,3,4,5,6,7
        ), ardef_pre_r as (
            select a.* --app_date_valid,low_key_for_range,high_key_for_range,ardef_country,account_funding_source,product_id,
            ,row_number()over(partition by low_key_for_range order by app_date_valid desc,delete_indicator,high_key_for_range desc) rn
            from ardef_pre_1 a
        )
        select * from ardef_pre_r where rn=1
        &#34;&#34;&#34;
        
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_ardef_unique&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)

        create_message = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        create_message,
        self.module
        )  
        

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        case 
            when right(t.authorization_code, 1) = &#39;x&#39; then &#39;INVALID&#39;
            when right(t.authorization_code, 5) in (&#39;     &#39;,&#39;00000&#39;,&#39;0000 &#39;,&#39;0000n&#39;,&#39;0000p&#39;,&#39;0000y&#39;) then &#39;INVALID&#39;
            else &#39;VALID&#39;
        end authorization_code_valid,
        case 
            when t.app_type_file = &#39;IN&#39; /*and t.transaction_code in (5,6,7,25,26,27)) or (t.app_type_file = &#39;OUT&#39; and t.transaction_code in (15,16,17,35,36,37))*/ then &#39;issuing&#39;
            when t.app_type_file = &#39;OUT&#39; /*and t.transaction_code in (5,6,7,25,26,27)) or (t.app_type_file = &#39;IN&#39; and t.transaction_code in (15,16,17,35,36,37))*/ then &#39;acquiring&#39;
            else t.app_type_file 
        end business_mode,
        case
                when a.ardef_country = trim(t.merchant_country_code) then 
                    case
                        when t.app_type_file = &#39;IN&#39; then 
                            case 
                                when (string_to_array(left(t.account_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_6_digits,&#39;,&#39;) or string_to_array(left(t.account_number::text,8),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_8_digits,&#39;,&#39;)) and upper(t.collection_only_flag) = &#39;C&#39; then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end
                        when t.app_type_file = &#39;OUT&#39; then 
                            case
                                when string_to_array(left(t.account_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.acquiring_bins,&#39;,&#39;) and upper(t.collection_only_flag) = &#39;C&#39; then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end     
                    end
                when a.ardef_country &lt;&gt; trim(t.merchant_country_code) and cra.visa_region_code = crt.visa_region_code then &#39;Intraregional&#39;
                when a.ardef_country &lt;&gt; trim(t.merchant_country_code) and cra.visa_region_code &lt;&gt; crt.visa_region_code then &#39;Interregional&#39;
        end jurisdiction, crt.country_code jurisdiction_country,r.region_code jurisdiction_region
        ,a.ardef_country
        ,t.merchant_country_code
        ,central_processing_date - t.purchase_date timeless
        ,a.account_funding_source funding_source, a.product_id
        ,row_number()over(partition by t.app_id,t.app_hash_file order by a.app_date_valid desc,a.high_key_for_range desc) n
        ,issuer_country
        ,technology_indicator
        ,fast_funds
        ,travel_indicator
        ,b2b_program_id
        ,nnss_indicator
        ,product_subtype
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_ardef_unique a
        on (t.account_number between low_key_for_range and high_key_for_range)
        left join operational.m_country crt
        on (crt.country_code = trim(t.merchant_country_code))
        left join operational.m_country cra
        on (cra.country_code = a.ardef_country)
        left join operational.m_region r
        on (r.region_code = crt.visa_region_code)
        left join control.t_customer c
        on (upper(c.code) = upper(&#39;{customer_code}&#39;))
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_calculated_field_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        query_tmp = f&#34;&#34;&#34;
        select 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,t.destination_amount
        ,t.source_amount
        ,t.destination_currency_code
        ,t.source_currency_code
        ,t.transaction_code
        ,t.merchant_category_code
        ,t.special_condition_indicator_merchant_transaction_indicator
        ,t.transaction_code_qualifier_0
        ,t.usage_code
        ,ex_local.exchange_value exchange_value_local
        ,ex_settl.exchange_value exchange_value_settlement
        ,cus.local_currency_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        left join control.t_customer cus on cus.code = t.app_customer_code
        left join operational.dh_exchange_rate ex_local on 
        (ex_local.app_processing_date = t.app_processing_date and  trim(ex_local.currency_to)=trim(cus.local_currency_code) and 
            ex_local.currency_from_code = case when t.destination_amount &gt; 0 then t.destination_currency_code
                    else t.source_currency_code 
                    end
        and ex_local.brand=&#39;VISA&#39;)
        left join operational.dh_exchange_rate ex_settl on 
        (ex_settl.app_processing_date = t.app_processing_date and  trim(ex_settl.currency_to)=trim(cus.settlement_currency_code) and 
            ex_settl.currency_from_code = case when t.destination_amount &gt; 0 then t.destination_currency_code
                    else t.source_currency_code 
                    end
        and ex_settl.brand=&#39;VISA&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sfc_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        case t.app_type_file
            when &#39;IN&#39; then
                case 
                    when transaction_code in (&#39;05&#39;,&#39;15&#39;,&#39;25&#39;,&#39;35&#39;) then 
                        case         
                            when special_condition_indicator_merchant_transaction_indicator in (&#39;7&#39;,&#39;8&#39;) then 3
                            when special_condition_indicator_merchant_transaction_indicator not in (&#39;7&#39;,&#39;8&#39;) then 1
                            else 255
                        end
                    when transaction_code in (&#39;07&#39;,&#39;17&#39;,&#39;27&#39;,&#39;37&#39;) then 
                        case 
                            when merchant_category_code in (6010) then 21 --MANUAL CASH
                            when merchant_category_code in (6011) then 22 -- ATM
                            else 255
                        end 
                    when transaction_code in (&#39;06&#39;,&#39;16&#39;,&#39;26&#39;,&#39;36&#39;) then 
                        case
                            when special_condition_indicator_merchant_transaction_indicator is not null and special_condition_indicator_merchant_transaction_indicator not in (&#39;8&#39;) and transaction_code_qualifier_0 = 0 then 19
                            when special_condition_indicator_merchant_transaction_indicator is null and transaction_code_qualifier_0 = 0 then 20
                            when special_condition_indicator_merchant_transaction_indicator in (&#39;8&#39;) and transaction_code_qualifier_0 = 0 then 20
                            when special_condition_indicator_merchant_transaction_indicator is not null and special_condition_indicator_merchant_transaction_indicator not in (&#39;8&#39;) and transaction_code_qualifier_0 = 2 then 25
                            when special_condition_indicator_merchant_transaction_indicator is null and transaction_code_qualifier_0 = 2 then 25
                            when special_condition_indicator_merchant_transaction_indicator in (&#39;8&#39;) and transaction_code_qualifier_0 = 2 then 25
                            else 255
                        end
                    else 255
                end
            when &#39;OUT&#39; then
                case 
                    when transaction_code in (&#39;05&#39;,&#39;15&#39;,&#39;25&#39;,&#39;35&#39;) then 
                        case         
                            when merchant_category_code not in (4829, 6051, 7995) then 1 -- purchase 1
                            when merchant_category_code in (4829, 6051, 7995) then 3 -- quasi cash
                            else 255
                        end
                    when transaction_code in (&#39;07&#39;,&#39;17&#39;,&#39;27&#39;,&#39;37&#39;) then 
                        case 
                            when merchant_category_code  in (6010) then 21 --MANUAL CASH
                            when merchant_category_code  in (6011) then 22 -- ATM
                            else 255
                        end 
                    when transaction_code in (&#39;06&#39;,&#39;16&#39;,&#39;26&#39;,&#39;36&#39;) then 
                        case        
                            when merchant_category_code not in (4829, 6051, 7995) and transaction_code_qualifier_0 = 0 then 19
                            when merchant_category_code in (4829, 6051, 7995) and transaction_code_qualifier_0 = 0 then 20  -- purchase 1
                            when merchant_category_code not in (4829, 6051, 7995) and transaction_code_qualifier_0 &lt;&gt; 0 then 25  -- purchase 1
                            else 255
                        end
                    else 255
                end
        end business_transaction_type
        ,case
            when transaction_code in(&#39;05&#39;,&#39;06&#39;,&#39;07&#39;) then 
                case
                    when usage_code = 1 then 11
                    when usage_code = 2 then 23
                    when usage_code = 9 then 6
                    else 255
                end
            when transaction_code in (&#39;15&#39;,&#39;16&#39;,&#39;17&#39;,&#39;35&#39;,&#39;36&#39;,&#39;37&#39;) then
                case
                    when usage_code = 1 then 1
                    when usage_code = 9 then 4
                    else 255
                end
            when transaction_code in (&#39;25&#39;,&#39;26&#39;,&#39;27&#39;) then
                case
                    when usage_code = 1 then 11 -- reversal must be 1
                    when usage_code = 9 then 6  --reversal must be 1
                    when usage_code = 2 then 25
                    else 255
                end 
            else 255
        end business_transaction_cycle
        ,case when transaction_code::integer &gt;= 20 and transaction_code::integer&lt;30 and usage_code in (1,9) then 1 else 0
        end reversal_indicator
        ,case 
            when dhvtc.jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                round(case 
                        when t.exchange_value_local is null then
                            case 
                                when t.destination_amount &gt; 0  and t.destination_currency_code = cast(cur.currency_numeric_code as varchar(4)) then t.destination_amount 
                                else 
                                    case 
                                        when t.source_currency_code = cast(cur.currency_numeric_code as varchar(4)) then source_amount 
                                        else null
                                    end
                            end
                        else
                            case 
                                when t.destination_amount &gt; 0 then t.destination_amount * t.exchange_value_local 
                                else source_amount * t.exchange_value_local 
                            end
                    end::numeric,2)
            when dhvtc.jurisdiction not in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                round(case
                        when t.exchange_value_settlement is null then
                            case 
                                when t.destination_amount &gt; 0  and t.destination_currency_code = cast(cur.currency_numeric_code as varchar(4)) then t.destination_amount 
                                else 
                                    case 
                                        when t.source_currency_code = cast(cur.currency_numeric_code as varchar(4)) then source_amount 
                                        else null
                                    end
                            end
                        else
                            case 
                                when t.destination_amount &gt; 0 then t.destination_amount * t.exchange_value_settlement 
                                else source_amount * t.exchange_value_settlement 
                            end
                    end::numeric,2)
        end settlement_report_amount
        ,t.local_currency_code settlement_report_currency_code
        from {table_tmp} t
        inner join temporal.{customer_code}_{type_file}_visa_calculated_field_pre dhvtc 
        on (dhvtc.app_id = t.app_id and dhvtc.app_hash_file = t.app_hash_file)
        left join operational.m_currency cur on cur.currency_alphabetic_code = t.local_currency_code
        where dhvtc.n = 1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sfc_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        tp.authorization_code_valid,tp.business_mode,lower(tp.jurisdiction) jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.timeless,tp.funding_source,tp.product_id
        ,tp.ardef_country
        ,tp1.reversal_indicator
        ,tp1.business_transaction_type
        ,tp1.business_transaction_cycle
        ,case lower(tp.jurisdiction) when &#39;intraregional&#39; then tp.jurisdiction_region::text
            when &#39;interregional&#39; then &#39;9&#39;
            else tp.jurisdiction_country::text
        end jurisdiction_assigned
        ,tp.issuer_country
        ,tp.technology_indicator
        ,tp.fast_funds
        ,tp.travel_indicator
        ,tp.b2b_program_id
        ,tp.nnss_indicator
        ,tp.product_subtype
        ,tp1.settlement_report_amount
        ,tp1.settlement_report_currency_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_calculated_field_pre tp
        on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sfc_field tp1
        on (t.app_id = tp1.app_id and t.app_hash_file = tp1.app_hash_file)
        where tp.n = 1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
        )
        ps_block.drop_table(table_tmp)  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )
        print(f&#34;Debug is {self.debug}&#34;)
        if self.debug == &#39;False&#39;:
            
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def mastercard_load_calculated_field_dh(self, string_date: str = None, type_file: str = None, hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from mastercard
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        
        query_tmp = f&#34;&#34;&#34;
        with iar_pre_1 as (
            select 
            to_date(a.effective_timestamp,&#39;yyddd24H&#39;) effective_date, to_date(to_char(a.app_date_valid::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;) app_date_valid, 
            to_date(to_char(a.app_date_end::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;) app_date_end, 
            left(a.low_range::varchar,18)::numeric low_key_for_range,
            left(a.high_range::varchar,18)::numeric high_key_for_range,
            a.card_country_alpha iar_country, 
            a.card_program_priority::numeric card_program_priority,
            a.card_program_identifier
            ,b.gcms_product_id gcms_product_identifier
            ,b.product_category funding_source
            from operational.dh_mastercard_iar a 
            left join operational.m_mastercard_brand_product b
            on (b.licensed_product_id=a.licensed_product_id and b.active_inactive_code=&#39;A&#39;)
            where to_date(to_char(a.app_date_valid::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;)&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
            and a.active_inactive_code=&#39;A&#39;
        ), bin_pre_2 as (
            select a.* 
            ,row_number()over(partition by low_key_for_range order by app_date_valid desc,card_program_priority) rn
            from iar_pre_1 a
        )
        select 
        app_date_valid,low_key_for_range::numeric low_key_for_range,high_key_for_range::numeric high_key_for_range,iar_country,gcms_product_identifier,funding_source,card_program_identifier
        from bin_pre_2 a
        where rn=1
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_iar_unique&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        
        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date,
        a.&#34;settlement_indicator_1&#34; settlement_indicator,
        left(rpad(pan::varchar,18,&#39;0&#39;),18)::numeric num_card, 
        a.&#34;date_and_time_local_transaction&#34; purchase_date,
        right(a.&#34;card_acceptor_namelocation&#34;,3) card_purchase_country, 
        b.&#34;mastercard_region_code&#34; card_purchase_region
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
        left join operational.m_country b
        on b.&#34;country_code_alternative&#34; = right(a.&#34;card_acceptor_namelocation&#34;,3)
        where a.app_message_type in (&#39;1240&#39;,&#39;1442&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_index = self.ps.create_table_index(table_scheme_tmp,table_name_tmp,f&#39;{customer_code}_{type_file}_mccf_pre_idx&#39;,&#39;num_card&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_index,
        self.module
        )  


        query_tmp = f&#34;&#34;&#34;
        select 
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date,
        case 
            when a.app_type_file = &#39;IN&#39;  then &#39;issuing&#39;
            when a.app_type_file = &#39;OUT&#39; then &#39;acquiring&#39;
            else a.app_type_file 
        end business_mode
        ,case
            when a.card_purchase_country = b.iar_country then
                case 
                    when a.settlement_indicator = &#39;C&#39; then &#39;on-us&#39;
                    when a.settlement_indicator = &#39;M&#39; then &#39;off-us&#39;
                end
            when a.card_purchase_country &lt;&gt; b.iar_country and bc.mastercard_region_code = ac.mastercard_region_code then &#39;Intraregional&#39;
            when a.card_purchase_country &lt;&gt; b.iar_country and bc.mastercard_region_code &lt;&gt; ac.mastercard_region_code then &#39;Interregional&#39;
            end jurisdiction, bc.country_code jurisdiction_country,r.region_code::text jurisdiction_region
        ,row_number()over(partition by a.app_id,a.app_hash_file order by b.app_date_valid desc,b.high_key_for_range desc) n
        ,b.*
        from {table_tmp} a
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_iar_unique b
        on a.num_card &gt;= b.low_key_for_range and a.num_card &lt;= b.high_key_for_range
        left join operational.m_country ac
        on (ac.country_code_alternative = a.card_purchase_country)
        left join operational.m_country bc
        on (bc.country_code_alternative = b.iar_country)
        left join operational.m_region r
        on (r.region_code = bc.mastercard_region_code)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_pre_2&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp= f&#34;&#34;&#34;
        select 
        t.app_id,t.app_hash_file
        ,t.app_type_file
        ,t.amount_reconciliation
        ,t.amount_transaction
        ,t.currency_code_transaction
        ,t.currency_code_reconciliation
        ,t.app_message_type
        ,ex_local.exchange_value exchange_value_local
        ,ex_settl.exchange_value exchange_value_settlement
        ,cus.local_currency_code
        ,cus.settlement_currency_code
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
        left join control.t_customer cus on cus.code = t.app_customer_code
        left join operational.dh_exchange_rate ex_local on 
        (ex_local.app_processing_date = t.app_processing_date and  trim(ex_local.currency_to)=trim(cus.local_currency_code) and 
            ex_local.currency_from_code = case when t.app_type_file != &#39;IN&#39; then t.currency_code_transaction::text end
        and ex_local.brand=&#39;MasterCard&#39;)
        left join operational.dh_exchange_rate ex_settl on 
        (ex_settl.app_processing_date = t.app_processing_date and  trim(ex_settl.currency_to)=trim(cus.settlement_currency_code) and 
            ex_settl.currency_from_code = case when t.app_type_file != &#39;IN&#39; then t.currency_code_transaction::text end
        and ex_settl.brand=&#39;MasterCard&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_ex_rate&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        
        query_tmp= f&#34;&#34;&#34;
        select app_hash_file,file_id
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date}
        where app_message_type = &#39;1644&#39; and function_code = 697
        group by 1,2
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_fi&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select 
        de.app_id,de.app_hash_file
        ,case 
            when de.app_type_file = &#39;IN&#39; then f_currency_reconcilation.currency_alphabetic_code::text
            else
                case 
                    when jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then de.local_currency_code::text 
                    else de.settlement_currency_code::text
                end    
        end as settlement_report_currency_code,
        round(
        case 
            when de.app_type_file = &#39;IN&#39; then  amount_reconciliation 
            else 
                case
                    when jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                        case 
                            when f_currency.currency_alphabetic_code = local_currency_code then amount_transaction
                            when de.exchange_value_local is not null then  amount_transaction *  de.exchange_value_local
                        end
                    else
                        case
                            when f_currency.currency_alphabetic_code = de.settlement_currency_code then amount_transaction
                            when de.exchange_value_settlement is not null then  amount_transaction *  de.exchange_value_settlement
                        end
                end
        end::numeric,2) as settlement_report_amount
        ,fi.file_id mc_file_id
        from {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_ex_rate de 
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_fi fi on (fi.app_hash_file = de.app_hash_file)
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_pre_2 cf on cf.app_id = de.app_id and cf.app_hash_file = de.app_hash_file
        left join operational.m_currency f_currency on f_currency.currency_numeric_code = currency_code_transaction 
        left join operational.m_currency f_currency_reconcilation on f_currency_reconcilation.currency_numeric_code = currency_code_reconciliation
        where  (de.app_message_type = &#39;1240&#39; or de.app_message_type=&#39;1422&#39;)
        and cf.n=1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_amount&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        tp.business_mode,tp.jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.funding_source,
        tp.gcms_product_identifier,
        tp.card_program_identifier,
        case tp.jurisdiction when &#39;Intraregional&#39; then tp.jurisdiction_region
            when &#39;Interregional&#39; then &#39;9&#39;
            else tp.jurisdiction_country
        end jurisdiction_assigned,
        tp1.settlement_report_currency_code,tp1.settlement_report_amount,tp1.mc_file_id
        ,tp.iar_country
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_pre_2 tp
        on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
        left join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_amount tp1
        on (tp1.app_id = t.app_id and tp1.app_hash_file = t.app_hash_file)
        where tp.n=1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        message_insert = self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_insert,
        self.module
        )  
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )

        return &#39;finished&#39;
    
    def visa_load_sms_calculated_field_dh(self, string_date: str = None,type_file: str = None,hash_file: str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa sms
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_sms_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading sms calculated field dh&#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )   

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        
        query_tmp = f&#34;&#34;&#34;
        with ardef_pre_1 as (
            select distinct 
            app_date_valid,
            rpad(left(trim(low_key_for_range),9),19,&#39;0&#39;)::numeric low_key_for_range,
            rpad(left(trim(table_key),9),19,&#39;9&#39;)::numeric high_key_for_range,
            ardef_country, a.account_funding_source,a.product_id,a.delete_indicator
            ,country issuer_country
            ,technology_indicator
            ,fast_funds
            ,travel_indicator
            ,b2b_program_id
            ,nnss_indicator
            ,product_subtype
            from operational.dh_visa_ardef a
            where app_date_valid&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
            --group by 1,2,3,4,5,6,7
        ), ardef_pre_r as (
            select a.* --app_date_valid,low_key_for_range,high_key_for_range,ardef_country,account_funding_source,product_id,
            ,row_number()over(partition by low_key_for_range order by app_date_valid desc,delete_indicator,high_key_for_range desc) rn
            from ardef_pre_1 a
        )
        select * from ardef_pre_r where rn=1
        &#34;&#34;&#34;
        
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_ardef_unique&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,t.request_message_type
        ,case 
            when response_code = &#39;00&#39; and settlement_amount &lt;&gt; 0 then --Transaccion aceptada y procesada, excepto autorizacion, etc.
                case 
                    when left(processing_code,2) in (&#39;00&#39;,&#39;20&#39;,&#39;26&#39;,&#39;11&#39;) then --Purchase / Credit Voucher
                        case 
                            when request_message_type in (&#39;0420&#39;) then 1 
                            else 0
                        end 
                    when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;,&#39;10&#39;) then --Cash / Adjustment
                        case 
                            when request_message_type in (&#39;0420&#39;) then 1 
                            else 0
                        end
                end
        END as reversal_indicator,
        case 
            when response_code = &#39;00&#39; and settlement_amount &lt;&gt; 0 then --Transaccion aceptada y procesada, excepto autorizacion, etc.
                case 
                    when left(processing_code,2) in (&#39;00&#39;) then 1 --Purchase
                    when left(processing_code,2) in (&#39;20&#39;) then 19 --Credit Voucher
                    when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;) then 22 --Cash / Adjustment
                    --when left(processing_code,2) in (&#39;30&#39;) then 247 --Balance Inquiry
                    when left(processing_code,2) in (&#39;10&#39;) then 30 -- Account Funding
                    when left(processing_code,2) in (&#39;11&#39;) then 3 -- Quasi-cash
                    when left(processing_code,2) in (&#39;19&#39;) then 115 -- Fee Collection
                    when left(processing_code,2) in (&#39;26&#39;) then 25  -- Original Credit
                    when left(processing_code,2) in (&#39;29&#39;) then 200 -- Funds Disbursement
                    when left(processing_code,2) in (&#39;40&#39;) then 250 -- CardHolder Account Transfer
                    when left(processing_code,2) in (&#39;50&#39;) then 27  -- Payment / Bill Payment (US ONLY)    
                end
            when response_code = &#39;00&#39; and settlement_amount = 0 then
                case 
                    when left(processing_code,2) in (&#39;30&#39;) then 247 
                end
            when response_code &lt;&gt; &#39;00&#39; and settlement_amount = 0 then
                case 
                    when left(processing_code,2) in (&#39;00&#39;) then 236 --Purchase
                    when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;,&#39;30&#39;) then 249 --Cash / Adjustment
                end
        end as business_transaction_type
        ,case 
            when response_code IN (&#39;00&#39;) AND settlement_amount &lt;&gt; 0 then 
                case 
                    when request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;01&#39;) THEN 4 -- Cash Dispute
                    WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;01&#39;) THEN 6 -- Cash Dispute Response
                    WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;02&#39;) THEN 4 -- Debit Adjustment Dispute
                    WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;02&#39;) THEN 7 -- Debit Adjustment
                    WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;22&#39;) THEN 4 -- Credit Adjustment Dispute
                    WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;22&#39;) THEN 5 -- Credit Adjustment                                 
                    WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;00&#39;,&#39;20&#39;) THEN 4 -- Dispute / Response for Purchase and Credit Voucher
                    WHEN request_message_type IN (&#39;0200&#39;,&#39;0220&#39;,&#39;0400&#39;,&#39;0420&#39;)  THEN 11 -- Original 
                end
            WHEN response_code NOT IN (&#39;00&#39;) AND settlement_amount = 0 THEN 100  -- Transacciones sin ciclo 
        end as business_transaction_cycle
        ,case 
            when right(t.authorization_id_resp_code, 1) = &#39;x&#39; then &#39;invalid&#39;
            when right(t.authorization_id_resp_code, 5) in (&#39;     &#39;,&#39;00000&#39;,&#39;0000 &#39;,&#39;0000n&#39;,&#39;0000p&#39;,&#39;0000y&#39;) then &#39;invalid&#39;
            else &#39;valid&#39;
        end authorization_code_valid,
        case upper(t.issuer_acquirer_indicator)
            when &#39;A&#39; then &#39;acquiring&#39;
            when &#39;I&#39; then &#39;issuing&#39;
        end business_mode,
        case
                when a.ardef_country = trim(t.card_acceptor_country) then 
                    case upper(t.issuer_acquirer_indicator)
                        when &#39;A&#39; then
                            case
                                when string_to_array(left(t.card_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.acquiring_bins,&#39;,&#39;) then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end
                        when &#39;I&#39; then 
                            case 
                                when (string_to_array(left(t.card_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_6_digits,&#39;,&#39;) or string_to_array(left(t.card_number::text,8),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_8_digits,&#39;,&#39;)) then &#39;on-us&#39;
                                else &#39;off-us&#39;
                            end
                    end
                when a.ardef_country &lt;&gt; trim(t.card_acceptor_country) and cra.visa_region_code = crt.visa_region_code then &#39;Intraregional&#39;
                when a.ardef_country &lt;&gt; trim(t.card_acceptor_country) and cra.visa_region_code &lt;&gt; crt.visa_region_code then &#39;Interregional&#39;
        end jurisdiction, crt.country_code jurisdiction_country,r.region_code jurisdiction_region
        ,a.ardef_country
        ,t.card_acceptor_country
        ,vss_processing_date - t.local_transaction_date timeless
        ,a.account_funding_source funding_source, a.product_id
        ,row_number()over(partition by t.app_id,t.app_hash_file order by a.app_date_valid desc,a.high_key_for_range desc) n
        ,issuer_country
        ,technology_indicator
        ,fast_funds
        ,travel_indicator
        ,b2b_program_id
        ,nnss_indicator
        ,product_subtype
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sms_ardef_unique a
        on (t.card_number between low_key_for_range and high_key_for_range)
        left join operational.m_country crt
        on (crt.country_code = trim(t.card_acceptor_country))
        left join operational.m_country cra
        on (cra.country_code = a.ardef_country)
        left join operational.m_region r
        on (r.region_code = crt.visa_region_code)
        left join control.t_customer c
        on (upper(c.code) = upper(&#39;{customer_code}&#39;))
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create= self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        t.*
        ,case 
            when request_message_type in (&#39;0200&#39;, &#39;0220&#39;, &#39;0420&#39;) and (business_transaction_cycle not in (4,6) or business_transaction_cycle is null) 
                then case 
                        when reversal_indicator = 0
                            then case 
                                    when business_transaction_type in (1,3) then &#39;05&#39;
                                    when business_transaction_type in (19,25) then &#39;06&#39;
                                    when business_transaction_type in (22,30) then &#39;07&#39;
                                end
                        when reversal_indicator = 1
                            then case  
                                    when business_transaction_type in (1,3) then &#39;25&#39;
                                    when business_transaction_type in (19,25) then &#39;26&#39;
                                    when business_transaction_type in (22,30) then &#39;27&#39;
                                end
                    end
        end transaction_code_sms
        from {table_tmp} t
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field_pre_2&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create= self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA SMS file&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
        tp.authorization_code_valid,tp.business_mode,lower(tp.jurisdiction) jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.timeless,tp.funding_source,tp.product_id
        ,tp.ardef_country
        ,tp.reversal_indicator
        ,tp.business_transaction_type
        ,tp.business_transaction_cycle
        ,tp.transaction_code_sms
        ,case lower(tp.jurisdiction) when &#39;intraregional&#39; then tp.jurisdiction_region::text
            when &#39;interregional&#39; then &#39;9&#39;
            else tp.jurisdiction_country::text
        end jurisdiction_assigned
        ,tp.issuer_country
        ,tp.technology_indicator
        ,tp.fast_funds
        ,tp.travel_indicator
        ,tp.b2b_program_id
        ,tp.nnss_indicator
        ,tp.product_subtype
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sms_calculated_field_pre_2 tp
        on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
        where tp.n = 1
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def visa_load_vss_110_calculated_field_dh(self, string_date: str = None,type_file:str = None, hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 110
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)


        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 110 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )   

        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_110 rollup_group
        from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_110 &lt;&gt; reporting_for_sre_identifier_110
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
            from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_110 &lt;&gt; reporting_for_sre_identifier_110
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,110 report_type
        ,case 
            when a.rollup_to_sre_identifier_110 = a.reporting_for_sre_identifier_110 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_110_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  


        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def visa_load_vss_120_calculated_field_dh(self, string_date: str = None,type_file:str = None,hash_file:str = None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 120
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        number_file = &#39;1&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 120 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )


        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_120 rollup_group
        from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_120 &lt;&gt; reporting_for_sre_identifier_120
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
            from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_120 &lt;&gt; reporting_for_sre_identifier_120
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,120 report_type
        ,case 
            when a.rollup_to_sre_identifier_120 = a.reporting_for_sre_identifier_120 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_120_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        
        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def visa_load_vss_130_calculated_field_dh(self, string_date: str = None,type_file:str = None,hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 130
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        number_file = &#39;1&#39;
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 130 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_130 rollup_group
        from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_130 &lt;&gt; reporting_for_sre_identifier_130
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
            from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_130 &lt;&gt; reporting_for_sre_identifier_130
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,130 report_type
        ,case 
            when a.rollup_to_sre_identifier_130 = a.reporting_for_sre_identifier_130 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_130_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  
        
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    
    def visa_load_vss_140_calculated_field_dh(self, string_date: str = None,type_file:str=None,hash_file:str=None)-&gt;str:
        &#34;&#34;&#34;Loading calculated fields from visa vss 140

        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        number_file = &#39;1&#39;
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)


        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading vss 140 calculated field dh into &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )


        query_tmp = f&#34;&#34;&#34;
        with rollup_group as (
        select rollup_to_sre_identifier_140 rollup_group
        from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_140 &lt;&gt; reporting_for_sre_identifier_140
        group by 1
        ), rollup_1 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
            from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date}
            where rollup_to_sre_identifier_140 &lt;&gt; reporting_for_sre_identifier_140
        ), rollup_2 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
            from rollup_1
        ), rollup_3 as (
            select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
            from rollup_2
        )
        select  
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,140 report_type
        ,case 
            when a.rollup_to_sre_identifier_140 = a.reporting_for_sre_identifier_140 then 10
            when b.reporting_indicator is not null then b.reporting_indicator
            when c.reporting_indicator is not null then c.reporting_indicator
            when d.reporting_indicator is not null then d.reporting_indicator
            else 0
        end aggregation_level
        from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date} a
        left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
        left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
        left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_140_calculated_field&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        ) 

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;ADAPTER OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    
    def load_mastercard_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
        &#34;&#34;&#34;Mastercard exchange charge per adapter
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file
            number_file (str): number of file in sequence

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard_interchange&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        str_currency = &#39;&#39;
        str_condition_currency = &#39;&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading mastercard interchange&#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )   
        table_rules = self.ps.select(&#39;operational.m_interchange_rules_mc&#39;,&#39;where amount_transaction_currency is not null group by 1&#39;,&#39;amount_transaction_currency&#39;)
        if len(table_rules)&gt;0:
            for rules in table_rules:
                str_currency += f&#34;,coalesce((t.amount_transaction*case when cu.currency_alphabetic_code = &#39;{rules[&#39;amount_transaction_currency&#39;]}&#39; then 1 else ex_{rules[&#39;amount_transaction_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) amount_transaction_{rules[&#39;amount_transaction_currency&#39;]} &#34;
                str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;amount_transaction_currency&#39;]} on (ex_{rules[&#39;amount_transaction_currency&#39;]}.app_processing_date=to_date(to_char(t.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) and ex_{rules[&#39;amount_transaction_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;amount_transaction_currency&#39;]}.currency_to=&#39;{rules[&#39;amount_transaction_currency&#39;]}&#39; and ex_{rules[&#39;amount_transaction_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

        query_tmp = f&#34;&#34;&#34;
        SELECT 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,coalesce(tcf.jurisdiction_assigned::text,&#39;BLANK&#39;) jurisdiction
        ,coalesce(trim(t.business_activity_4)::text,&#39;BLANK&#39;) ird
        ,coalesce(trim(left(t.processing_code,2)),&#39;BLANK&#39;) processing_code
        ,coalesce(t.amount_transaction::text,&#39;BLANK&#39;) amount_transaction
        ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) amount_transaction_currency
        {str_currency}
        ,coalesce(t.card_acceptor_business_code_mcc::text,&#39;BLANK&#39;) card_acceptor_business_code
        ,coalesce(trim(tcf.gcms_product_identifier)::text,&#39;BLANK&#39;) gcms_product_identifier
        ,coalesce(trim(tcf.funding_source),&#39;BLANK&#39;) funding_source
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
        inner join operational.dh_mastercard_calculated_field_{customer_code}_{type_file}_{string_date} tcf
        on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
        left join operational.m_currency cu
        on (cu.currency_numeric_code = t.currency_code_transaction::int)
        {str_condition_currency}
        where t.app_hash_file=&#39;{hash_file}&#39;
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_interchange_eval&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        table_name_tmp = self.mastercard_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
        if table_name_tmp == &#39;-1&#39;:
            if self.debug == &#39;False&#39;:
                bulk_delete = ps_block.query_block()
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    customer_code,
                    &#34;MASTERCARD&#34;,
                    self.log_name,
                    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
                    &#34;INFO&#34;,
                    bulk_delete,
                    self.module
                )
            return &#39;finished&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        ps_block.drop_table(table_tmp)
        query_tmp = f&#34;&#34;&#34;
        with tmp_pre as
        (
        select to_date(to_char(a.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) date_and_time_local_transaction,a.currency_code_transaction::numeric currency_code_transaction
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
        group by 1,2
        )
        select *
        from operational.dh_exchange_rate er
        where (er.app_processing_date,er.currency_from_code::numeric) in (select date_and_time_local_transaction,currency_code_transaction from tmp_pre)
        and er.brand=&#39;MasterCard&#39;
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_ex_rate&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,a.amount_transaction
        ,a.currency_code_transaction currency_transaction
        ,c.rate_currency
        ,c.rate_variable::numeric
        ,c.rate_fixed::numeric
        ,c.rate_min::numeric
        ,c.rate_cap::numeric
        ,case
            when c.rate_variable is null then rate_fixed::numeric
            when not operational.isnumeric(c.rate_variable) then null
            else
                case
                    when (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0) &lt;= rate_min then rate_min::numeric
                    when (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0) &gt;= rate_cap then rate_cap::numeric
                    else (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0)
                end
        end calculated_value,
        e.intelica_id::numeric,
        e.region_country_code,
        e.ird
        from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
        inner join temporal.{customer_code}_{type_file}_{number_file}_mastercard_interchange_eval_assign e
        on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
        inner join operational.m_interchange_rules_mc c
        on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code and c.ird = e.ird 
        and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
        left join operational.m_currency cur on cur.currency_numeric_code = a.currency_code_transaction::numeric
        left join {table_tmp} er
        on (er.date=to_date(to_char(a.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) and er.currency_from_code::numeric=a.currency_code_transaction::numeric and er.currency_to=c.rate_currency and lower(er.brand)=&#39;mastercard&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_interchange&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        message_insert = self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_insert,
        self.module
        )  

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )

        return &#39;finished&#39;
    
    def load_visa_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
        &#34;&#34;&#34;Visa exchange charge per adapter
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file
            number_file (str): number of file in sequence

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_interchange&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        str_currency = &#39;&#39;
        str_condition_currency = &#39;&#39;
        module = &#39;ADAPTER&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading visa interchange &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

        table_rules = self.ps.select(&#39;operational.m_interchange_rules_visa&#39;,&#39;where transaction_amount_currency is not null group by 1&#39;,&#39;transaction_amount_currency&#39;)
        if len(table_rules)&gt;0:
            for rules in table_rules:
                str_currency += f&#34;,coalesce((t.source_amount*case when cu.currency_alphabetic_code = &#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; then 1 else ex_{rules[&#39;transaction_amount_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) transaction_amount_{rules[&#39;transaction_amount_currency&#39;]} &#34;
                str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;transaction_amount_currency&#39;]} on (ex_{rules[&#39;transaction_amount_currency&#39;]}.app_processing_date=t.purchase_date and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_to=&#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; and ex_{rules[&#39;transaction_amount_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

        query_tmp = f&#34;&#34;&#34;
        SELECT 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,coalesce(upper(tcf.jurisdiction_assigned)::text,&#39;BLANK&#39;) jurisdiction
        ,coalesce(upper(tcf.business_mode)::text,&#39;BLANK&#39;) business_mode,
        coalesce(tcf.issuer_country::text,&#39;BLANK&#39;) issuer_country,
        coalesce(c.visa_region_code::text,&#39;BLANK&#39;) issuer_region
        ,coalesce(tcf.technology_indicator::text,&#39;BLANK&#39;)technology_indicator
        ,coalesce(tcf.product_id::text,&#39;BLANK&#39;)product_id
        ,coalesce(tcf.fast_funds::text,&#39;BLANK&#39;)fast_funds
        ,coalesce(tcf.travel_indicator::text,&#39;BLANK&#39;)travel_indicator
        ,coalesce(tcf.b2b_program_id::text,&#39;BLANK&#39;)b2b_program_id
        ,coalesce(tcf.funding_source::text,&#39;BLANK&#39;) account_funding_source
        ,coalesce(tcf.nnss_indicator::text,&#39;BLANK&#39;)nnss_indicator
        ,coalesce(tcf.product_subtype::text,&#39;BLANK&#39;)product_subtype
        ,coalesce(right(lpad(t.transaction_code::text,2,&#39;0&#39;),2),&#39;BLANK&#39;) transaction_code
        ,coalesce(t.transaction_code_qualifier_0::text,&#39;BLANK&#39;) transaction_code_qualifier
        ,coalesce(t.account_number::text,&#39;BLANK&#39;) payment_credential_combination
        ,coalesce(t.account_reference_number_acquiring_identifier::text,&#39;BLANK&#39;) acquiring_identifier
        ,coalesce(t.source_amount::text,&#39;BLANK&#39;) transaction_amount
        {str_currency}
        ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) transaction_amount_currency
        ,coalesce(t.merchant_country_code::text,&#39;BLANK&#39;) acquirer_country
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) acquirer_region
        ,coalesce(t.merchant_country_code::text,&#39;BLANK&#39;)merchant_country_code
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) merchant_country_region
        ,coalesce(t.merchant_category_code::text,&#39;BLANK&#39;)merchant_category_code
        ,coalesce(t.requested_payment_service::text,&#39;BLANK&#39;)requested_payment_service
        ,coalesce(t.usage_code::text,&#39;BLANK&#39;)usage_code
        ,coalesce(t.authorization_characteristics_indicator::text,&#39;BLANK&#39;)authorization_characteristics_indicator
        ,coalesce(tcf.authorization_code_valid::text,&#39;BLANK&#39;) authorization_code
        ,coalesce(t.pos_terminal_capacity::text,&#39;BLANK&#39;) pos_terminal_capability
        ,coalesce(t.cardholder_id_method::text,&#39;BLANK&#39;)cardholder_id_method
        ,coalesce(t.pos_entry_mode::text,&#39;BLANK&#39;)pos_entry_mode
        ,coalesce(tcf.timeless::text,&#39;BLANK&#39;) timeliness
        ,coalesce(t.reimbursement_attribute::text,&#39;BLANK&#39;)reimbursement_attribute
        ,coalesce(t.special_condition_indicator_merchant_transaction_indicator::text,&#39;BLANK&#39;) special_condition_indicator
        ,coalesce(t.fee_program_indicator::text,&#39;BLANK&#39;)fee_program_indicator
        ,&#39;BLANK&#39; processing_code
        ,coalesce(t.motoec_indicator::text,&#39;BLANK&#39;) moto_eci_indicator
        ,coalesce(t.acceptance_terminal_indicator::text,&#39;BLANK&#39;)acceptance_terminal_indicator
        ,coalesce(t.prepaid_card_indicator::text,&#39;BLANK&#39;)prepaid_card_indicator
        ,coalesce(t.pos_environment::text,&#39;BLANK&#39;) pos_environment_code
        ,coalesce(case
            when business_format_code_sp = &#39;SP&#39; then business_format_code_sp
            when business_format_code_sd = &#39;SD&#39; then business_format_code_sd
            when business_format_code_pd = &#39;PD&#39; then business_format_code_pd
            when business_format_code_ft = &#39;FT&#39; then business_format_code_ft
            when business_format_code_fl = &#39;FL&#39; then business_format_code_fl
            when business_format_code_df = &#39;DF&#39; then business_format_code_df
            when business_format_code_cr = &#39;CR&#39; then business_format_code_cr
        end::text,&#39;BLANK&#39;) business_format_code
        ,coalesce(t.business_application_id_cr::text,&#39;BLANK&#39;) business_application_id
        ,coalesce(t.type_of_purchase_fl::text,&#39;BLANK&#39;) type_purchase
        ,coalesce(case 
            when business_format_code_sd = &#39;SD&#39; then network_identification_code_sd
            when business_format_code_df = &#39;DF&#39; then network_identification_code_df
            when business_format_code_sp = &#39;SP&#39; then network_identification_code_sp
        end::text,&#39;BLANK&#39;) network_identification_code
        ,coalesce(case 
            when business_format_code_sd = &#39;SD&#39; then message_reason_code_sd
            when business_format_code_df = &#39;DF&#39; then message_reason_code_df
            when business_format_code_sp = &#39;SP&#39; then message_reason_code_sp
        end::text,&#39;BLANK&#39;) message_reason_code
        ,coalesce(case 
            when business_format_code_sd = &#39;SD&#39; then surcharge_amount_sd
            when business_format_code_sp = &#39;SP&#39; then surcharge_amount_sp
        end::text,&#39;BLANK&#39;) surcharge_amount
        ,coalesce(t.authorized_amount::text,&#39;BLANK&#39;)authorized_amount
        ,coalesce(t.authorization_response_code::text,&#39;BLANK&#39;)authorization_response_code
        ,coalesce(t.validation_code::text,&#39;BLANK&#39;)validation_code
        ,coalesce(t.merchant_verification_value::text,&#39;BLANK&#39;)merchant_verification_value
        ,coalesce(t.dcc_indicator::text,&#39;BLANK&#39;) dynamic_currency_conversion_indicator
        ,coalesce(substr(t.pan_token::text,2,1),&#39;BLANK&#39;) authorization_characteristics_indicator_5
        ,coalesce(t.cvv_result_code::text,&#39;BLANK&#39;) cvv2_result_code
        ,coalesce(t.national_tax_included::text,&#39;BLANK&#39;) national_tax_indicator
        ,coalesce(t.merchant_vat_registration_number::text,&#39;BLANK&#39;) merchant_vat
        ,coalesce(t.summary_commodity_code::text,&#39;BLANK&#39;) summary_commodity
        ,coalesce(t.message_identifier::text,&#39;BLANK&#39;)message_identifier
        ,&#39;BLANK&#39; processing_code_transaction_type
        ,&#39;BLANK&#39; point_of_service_condition_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
        inner join operational.dh_visa_transaction_calculated_field_{customer_code}_{type_file}_{string_date} tcf
        on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
        left join operational.m_country c
        on (c.country_code = tcf.issuer_country)
        left join operational.m_country c2
        on (c2.country_code = t.merchant_country_code)
        left join operational.m_currency cu
        on (cu.currency_numeric_code = t.source_currency_code::int)
        {str_condition_currency}
        where t.app_hash_file=&#39;{hash_file}&#39;
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_interchange_eval&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        table_name_tmp = self.visa_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
        if table_name_tmp == &#39;-1&#39;:
            if self.debug == &#39;False&#39;:
                bulk_delete = ps_block.query_block()
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;INTERCHANGE OF VISA FILE&#34;,
                    &#34;INFO&#34;,
                    bulk_delete,
                    self.module
                )
            return &#39;finished&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        ps_block.drop_table(table_tmp)
        query_tmp = f&#34;&#34;&#34;
        with tmp_pre as
        (
        select a.purchase_date,a.source_currency_code::numeric source_currency_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} a
        group by 1,2
        )
        select *
        from operational.dh_exchange_rate er
        where (er.app_processing_date,er.currency_from_code::numeric) in (select purchase_date,source_currency_code from tmp_pre)
        and er.brand=&#39;VISA&#39;
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_ex_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,a.source_amount amount_transaction
        ,a.source_currency_code currency_transaction
        ,c.fee_currency
        ,c.fee_variable::numeric
        ,c.fee_fixed::numeric
        ,c.fee_min::numeric
        ,c.fee_cap::numeric
        ,case
            when c.fee_variable is null then fee_fixed::numeric
            when not operational.isnumeric(c.fee_variable) then null
            else
                case
                    when (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &lt;= fee_min then fee_min::numeric
                    when (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &gt;= fee_cap then fee_cap::numeric
                    else (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0)
                end
        end calculated_value,
        e.intelica_id::numeric
        ,e.region_country_code
        from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} a
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_{number_file}_visa_interchange_eval_assign e
        on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
        left join operational.m_interchange_rules_visa c
        on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code
        and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
        left join operational.m_currency cur on cur.currency_numeric_code = a.source_currency_code::numeric
        left join {table_tmp} er
        on (er.date=a.purchase_date and er.currency_from_code::numeric=a.source_currency_code::numeric and er.currency_to=c.fee_currency and lower(er.brand)=&#39;visa&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_interchange&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )   

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;INTERCHANGE OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    
    def load_visa_sms_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
        &#34;&#34;&#34;Visa exchange charge per adapter
        
        Args:
            string_date (str): date for range condition  
            type_file (str): type of file
            hash_file (str): hash code of file
            number_file (str): number of file in sequence

        Returns:
            str: Message
        
        &#34;&#34;&#34;
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_sms_interchange&#39;
        adapter_table = table_scheme+&#39;.&#39;+table_name
        customer_code = self.customer_code
        module = &#39;ADAPTER&#39;
        str_currency = &#39;&#39;
        str_condition_currency = &#39;&#39;
        ps_block = con.connect_to_postgreSQL(bool_query=True)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        &#34;loading visa interchange &#34;
        + table_scheme
        + &#34;.&#34;
        + table_name,
        self.module
        )

        if string_date == None:
            string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
        table_rules = self.ps.select(&#39;operational.m_interchange_rules_visa&#39;,&#39;where transaction_amount_currency is not null group by 1&#39;,&#39;transaction_amount_currency&#39;)
        if len(table_rules)&gt;0:
            for rules in table_rules:
                str_currency += f&#34;,coalesce((t.transaction_amount*case when cu.currency_alphabetic_code = &#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; then 1 else ex_{rules[&#39;transaction_amount_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) transaction_amount_{rules[&#39;transaction_amount_currency&#39;]} &#34;
                str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;transaction_amount_currency&#39;]} on (ex_{rules[&#39;transaction_amount_currency&#39;]}.app_processing_date=t.local_transaction_date and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_to=&#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; and ex_{rules[&#39;transaction_amount_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

        query_tmp = f&#34;&#34;&#34;
        SELECT 
        t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
        ,coalesce(upper(tcf.jurisdiction_assigned)::text,&#39;BLANK&#39;) jurisdiction
        ,coalesce(upper(tcf.business_mode)::text,&#39;BLANK&#39;) business_mode,
        coalesce(tcf.issuer_country::text,&#39;BLANK&#39;) issuer_country,
        coalesce(c.visa_region_code::text,&#39;BLANK&#39;) issuer_region
        ,coalesce(tcf.technology_indicator::text,&#39;BLANK&#39;)technology_indicator
        ,coalesce(tcf.product_id::text,&#39;BLANK&#39;)product_id
        ,coalesce(tcf.fast_funds::text,&#39;BLANK&#39;)fast_funds
        ,coalesce(tcf.travel_indicator::text,&#39;BLANK&#39;)travel_indicator
        ,coalesce(tcf.b2b_program_id::text,&#39;BLANK&#39;)b2b_program_id
        ,coalesce(tcf.funding_source::text,&#39;BLANK&#39;) account_funding_source
        ,coalesce(tcf.nnss_indicator::text,&#39;BLANK&#39;)nnss_indicator
        ,coalesce(tcf.product_subtype::text,&#39;BLANK&#39;)product_subtype
        ,coalesce(tcf.transaction_code_sms,&#39;BLANK&#39;) transaction_code
        --,coalesce(t.transaction_code_qualifier_0::text,&#39;BLANK&#39;) transaction_code_qualifier
        --,coalesce(t.account_number::text,&#39;BLANK&#39;) payment_credential_combination
        ,coalesce(t.transaction_amount::text,&#39;BLANK&#39;) transaction_amount
        {str_currency}
        ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) transaction_amount_currency
        ,coalesce(t.card_acceptor_country::text,&#39;BLANK&#39;) acquirer_country
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) acquirer_region
        ,coalesce(t.card_acceptor_country::text,&#39;BLANK&#39;)merchant_country_code
        ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) merchant_country_region
        ,coalesce(t.merchants_type::text,&#39;BLANK&#39;)merchant_category_code
        ,coalesce(t.requested_payment_service::text,&#39;BLANK&#39;) requested_payment_service
        ,coalesce(t.usage_code_sms::text,&#39;BLANK&#39;)usage_code
        ,coalesce(t.authorization_characteristics_indicator_sms::text,&#39;BLANK&#39;)authorization_characteristics_indicator
        ,coalesce(tcf.authorization_code_valid::text,&#39;BLANK&#39;) authorization_code
        ,coalesce(t.pos_terminal_entry_capability::text,&#39;BLANK&#39;) pos_terminal_capability
        ,coalesce(t.customer_identification_method::text,&#39;BLANK&#39;)cardholder_id_method
        ,coalesce(left(t.pos_entry_mode_sms::text,2),&#39;BLANK&#39;)pos_entry_mode
        ,coalesce(tcf.timeless::text,&#39;BLANK&#39;) timeliness
        ,coalesce(t.reimbursement_attribute_sms::text,&#39;BLANK&#39;)reimbursement_attribute
        ,coalesce(t.chargeback_special_condition_merchant_indicator::text,&#39;BLANK&#39;) special_condition_indicator
        ,coalesce(t.fee_program_indicator_sms::text,&#39;BLANK&#39;)fee_program_indicator
        --,&#39;BLANK&#39; processing_code
        ,coalesce(t.mailtelephone_or_electronic_commerce_indicator::text,&#39;BLANK&#39;) moto_eci_indicator
        ,coalesce(right(t.pos_terminal_type,1)::text,&#39;BLANK&#39;)acceptance_terminal_indicator
        --,coalesce(t.prepaid_card_indicator::text,&#39;BLANK&#39;)prepaid_card_indicator
        ,coalesce(t.recurring_payment_indicator_flag::text,&#39;BLANK&#39;) pos_environment_code
        /*,coalesce(case
            when business_format_code_sp = &#39;SP&#39; then business_format_code_sp
            when business_format_code_sd = &#39;SD&#39; then business_format_code_sd
            when business_format_code_pd = &#39;PD&#39; then business_format_code_pd
            when business_format_code_ft = &#39;FT&#39; then business_format_code_ft
            when business_format_code_fl = &#39;FL&#39; then business_format_code_fl
            when business_format_code_df = &#39;DF&#39; then business_format_code_df
            when business_format_code_cr = &#39;CR&#39; then business_format_code_cr
        end::text,&#39;BLANK&#39;) business_format_code*/
        ,coalesce(t.business_application_identifier::text,&#39;BLANK&#39;) business_application_id
        --,coalesce(t.type_of_purchase_fl::text,&#39;BLANK&#39;) type_purchase
        ,coalesce(t.network_id::text,&#39;BLANK&#39;) network_identification_code
        ,coalesce(t.message_reason_code_sms::text,&#39;BLANK&#39;) message_reason_code
        ,coalesce(t.surcharge_amount_sms::text,&#39;BLANK&#39;) surcharge_amount
        --,coalesce(t.authorized_amount::text,&#39;BLANK&#39;)authorized_amount
        ,coalesce(t.response_code::text,&#39;BLANK&#39;)authorization_response_code
        --,coalesce(t.validation_code::text,&#39;BLANK&#39;)validation_code
        --,coalesce(t.merchant_verification_value::text,&#39;BLANK&#39;)merchant_verification_value
        ,coalesce(t.dcc_indicator_sms::text,&#39;BLANK&#39;) dynamic_currency_conversion_indicator
        ,coalesce(t.cvv_result_code_sms::text,&#39;BLANK&#39;) cvv2_result_code
        --,coalesce(t.national_tax_included::text,&#39;BLANK&#39;) national_tax_indicator
        --,coalesce(t.merchant_vat_registration_number::text,&#39;BLANK&#39;) merchant_vat
        --,coalesce(t.summary_commodity_code::text,&#39;BLANK&#39;) summary_commodity
        --,coalesce(t.message_identifier::text,&#39;BLANK&#39;)message_identifier
        ,coalesce(left(t.processing_code::text,2),&#39;BLANK&#39;) processing_code_transaction_type
        ,coalesce(t.pos_condition_code::text,&#39;BLANK&#39;) point_of_service_condition_code
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
        inner join operational.dh_visa_transaction_sms_calculated_field_{customer_code}_{type_file}_{string_date} tcf
        on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
        left join operational.m_country c
        on (c.country_code = tcf.issuer_country)
        left join operational.m_country c2
        on (c2.country_code = t.card_acceptor_country)
        left join operational.m_currency cu
        on (cu.currency_numeric_code = t.transaction_currency_code::int)
        {str_condition_currency}
        where t.app_hash_file=&#39;{hash_file}&#39;
        &#34;&#34;&#34;
        table_scheme_tmp = &#39;temporal&#39;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_interchange_eval&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        table_name_tmp = self.visa_sms_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
        if table_name_tmp == &#39;-1&#39;:
            if self.debug == &#39;False&#39;:
                bulk_delete = ps_block.query_block()
                log.logs().exist_file(
                    &#34;OPERATIONAL&#34;,
                    customer_code,
                    &#34;VISA&#34;,
                    self.log_name,
                    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
                    &#34;INFO&#34;,
                    bulk_delete,
                    self.module
                )
            return &#39;finished&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        ps_block.drop_table(table_tmp)
        query_tmp = f&#34;&#34;&#34;
        with tmp_pre as
        (
        select a.local_transaction_date,a.transaction_currency_code::numeric transaction_currency_code
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} a
        group by 1,2
        )
        select *
        from operational.dh_exchange_rate er
        where (er.app_processing_date,er.currency_from_code::numeric) in (select local_transaction_date,transaction_currency_code from tmp_pre)
        and er.brand=&#39;VISA&#39;
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_ex_pre&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )

        query_tmp = f&#34;&#34;&#34;
        select
        a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
        ,a.transaction_amount amount_transaction
        ,a.transaction_currency_code currency_transaction
        ,c.fee_currency
        ,c.fee_variable::numeric
        ,c.fee_fixed::numeric
        ,c.fee_min::numeric
        ,c.fee_cap::numeric
        ,case
            when c.fee_variable is null then fee_fixed::numeric
            when not operational.isnumeric(c.fee_variable) then null
            else
                case
                    when (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &lt;= fee_min then fee_min::numeric
                    when (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &gt;= fee_cap then fee_cap::numeric
                    else (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0)
                end
        end calculated_value,
        e.intelica_id::numeric
        ,e.region_country_code
        from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} a
        inner join {table_scheme_tmp}.{customer_code}_{type_file}_{number_file}_visa_sms_interchange_eval_assign e
        on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
        left join operational.m_interchange_rules_visa c
        on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code
        and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
        left join operational.m_currency cur on cur.currency_numeric_code = a.transaction_currency_code::numeric
        left join {table_tmp} er
        on (er.date=a.local_transaction_date and er.currency_from_code::numeric=a.transaction_currency_code::numeric and er.currency_to=c.fee_currency and lower(er.brand)=&#39;visa&#39;)
        &#34;&#34;&#34;
        table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_interchange&#39;
        table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
        
        message_drop = self.ps.drop_table(table_tmp)
        ps_block.drop_table(table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  

        message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        ) 

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
        self.module
        )

        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;INTERCHANGE OF VISA SMS FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;

    def fill_range(self,list_value:list)-&gt; list:
        &#34;&#34;&#34;Generating a fill list
        
        Args:
            list_value (list): list of values 

        Returns:
            list_string (list): list of processed values
        
        &#34;&#34;&#34;
        new_list = []
        list_string = []
        for value in list_value:
            if str(value).find(&#39;-&#39;)&gt;0:
                split_value=value.split(&#39;-&#39;)
                new_list.extend(range(int(split_value[0]),int(split_value[1])+1))
            else:
                new_list.append(int(value))
        list_string = map(str, new_list)
        return list_string
    
    def visa_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
        &#34;&#34;&#34;Direct Assignment Exchange Rules
        
        Args:
            table_schema_source (str): schema of table source
            table_name_source (str): table source name
            string_date (str): date filter

        Returns:
            table_name_result (str): Table name as result 
        
        &#34;&#34;&#34;
        table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
        dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
        table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
        table_work = pd.DataFrame(self.ps.select(table))
        if table_work.empty:
            query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from from {table}&#39;
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_create,
            self.module
            )  

            return table_name_result
        table_work[&#39;rule&#39;] = 0
        table_work[&#39;id&#39;] = table_work.index + 1
        table_work[&#39;product_id&#39;] = table_work[&#39;product_id&#39;].str.strip()
        table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_visa r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and region_country_code in (select jurisdiction from {table} group by 1) order by region_country_code,intelica_id::numeric&#34;))
        table_rules[&#39;key&#39;] = table_rules.index + 1
        count_row=0
        count_condition = 0
        for rule in table_rules[&#39;key&#39;].values:
            table_test = pd.DataFrame()
            table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0)],how=&#39;right&#39;)
            for condition in table_rules.columns.values:
                if condition not in (&#39;processing_code_transaction_type&#39;,&#39;point_of_service_condition_code&#39;,&#39;app_id&#39;,&#39;intelica_id_original&#39;,&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;transaction_amount_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_program&#39;,&#39;intelica_id&#39;,&#39;fpi&#39;,&#39;fee_descriptor&#39;,&#39;fee_description&#39;,&#39;cod_hierarchy&#39;,&#39;program_default&#39;,&#39;fee_currency&#39;,&#39;fee_variable&#39;,&#39;fee_fixed&#39;,&#39;fee_min&#39;,&#39;fee_cap&#39;,&#39;acquiring_identifier&#39;,&#39;message_identifier&#39;,&#39;merchant_verification_value&#39;,&#39;validation_code&#39;,&#39;v_i_p_full_financial_message_sets&#39;,&#39;sender_data&#39;,&#39;additional_sender_data&#39;,&#39;settlement_service&#39;,&#39;other_criteria_applies&#39;):
                    value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                    if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                        if len(table_test)&gt;0:
                            try:

                                if condition in (&#39;nnss_indicator&#39;,&#39;cardholder_id_method&#39;,&#39;moto_eci_indicator&#39;,&#39;acceptance_terminal_indicator&#39;,&#39;merchant_vat&#39;):
                                    value_condition = value_condition.lower().replace(&#39;space&#39;,&#39; &#39;).upper()
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition.replace(&#39;NOT:&#39;,&#39;&#39;)
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[~table_test[condition].astype(str).isin(split_condition)]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).isin(split_condition)]
                                    continue
                                if condition in (&#39;transaction_amount&#39;):
                                    table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                    value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;transaction_amount_currency&#39;][count_row]).lower()}&#34;
                                    table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                    table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{value_condition_currency} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;surcharge_amount&#39;,&#39;timeliness&#39;):
                                    table_test = table_test[table_test[condition] != &#39;BLANK&#39;]
                                    table_test[condition] = pd.to_numeric(table_test[condition])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{condition} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[condition].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;merchant_category_code&#39;):
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                        else:
                                            table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                        else:
                                            table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                    continue
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                                else:
                                    value_condition = value_condition.upper()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        value_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                                if table_test.empty:
                                    break
                            except ValueError as error:                   
                                log.logs().exist_file(
                                &#34;OPERATIONAL&#34;,
                                &#34;&#34;,
                                &#34;VISA&#34;,
                                self.log_name,
                                &#34;ADAPTER OF VISA FILE&#34;,
                                &#34;ERROR&#34;,
                                &#34;Error has occurred:&#34;+ str(error),
                                self.module
                                )  
            if len(table_test)&gt;0:
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;cod_hierarchy&#39;] = table_rules[&#39;cod_hierarchy&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
            count_row+=1
        if len(table_work)&gt;0:
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;INTERCHANGE OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            table_work = table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;cod_hierarchy&#39;,&#39;valid_from&#39;]].applymap(str)
            table_work[&#34;intelica_id&#34;] = table_work[&#34;intelica_id&#34;].replace(&#34;nan&#34;,None)
            table_work[&#34;region_country_code&#34;] = table_work[&#34;region_country_code&#34;].replace(&#34;nan&#34;,None)
            aasa =  table_work.loc[table_work[&#34;region_country_code&#34;] == None] 
            print(aasa)
            self.ps.insert_from_df(table_work,table_schema_source.lower(),table_name_result)
            return table_name_result
        return &#39;-1&#39;

    def visa_sms_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
        &#34;&#34;&#34;Direct Assignment Exchange Rules
        
        Args:
            table_schema_source (str): schema of table source
            table_name_source (str): table source name
            string_date (str): date filter

        Returns:
            table_name_result (str): Table name as result
        
        &#34;&#34;&#34;
        table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
        dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
        table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
        table_work = pd.DataFrame(self.ps.select(table))
        if table_work.empty:
            query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from from {table}&#39;
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA SMS FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA SMS FILE&#34;,
            &#34;INFO&#34;,
            message_create,
            self.module
            )  

            return table_name_result
        table_work[&#39;rule&#39;] = 0
        table_work[&#39;id&#39;] = table_work.index + 1
        table_work[&#39;product_id&#39;] = table_work[&#39;product_id&#39;].str.strip()
        table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_visa r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and region_country_code in (select jurisdiction from {table} group by 1) order by region_country_code,intelica_id::numeric&#34;))
        table_rules[&#39;key&#39;] = table_rules.index + 1
        count_row=0
        count_condition = 0
        for rule in table_rules[&#39;key&#39;].values:
            table_test = pd.DataFrame()
            table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0)],how=&#39;right&#39;)
            for condition in table_rules.columns.values:
                if condition not in (&#39;transaction_code_qualifier&#39;,&#39;payment_credential_combination&#39;,&#39;prepaid_card_indicator&#39;,&#39;business_format_code&#39;,&#39;type_purchase&#39;,&#39;authorized_amount&#39;,&#39;national_tax_indicator&#39;,&#39;merchant_vat&#39;,&#39;summary_commodity&#39;,&#39;message_identifier&#39;,&#39;app_id&#39;,&#39;intelica_id_original&#39;,&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;transaction_amount_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_program&#39;,&#39;intelica_id&#39;,&#39;fpi&#39;,&#39;fee_descriptor&#39;,&#39;fee_description&#39;,&#39;cod_hierarchy&#39;,&#39;program_default&#39;,&#39;fee_currency&#39;,&#39;fee_variable&#39;,&#39;fee_fixed&#39;,&#39;fee_min&#39;,&#39;fee_cap&#39;,&#39;acquiring_identifier&#39;,&#39;message_identifier&#39;,&#39;merchant_verification_value&#39;,&#39;validation_code&#39;,&#39;v_i_p_full_financial_message_sets&#39;,&#39;sender_data&#39;,&#39;additional_sender_data&#39;,&#39;settlement_service&#39;,&#39;other_criteria_applies&#39;):
                    value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                    if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                        if len(table_test)&gt;0:
                            try:

                                if condition in (&#39;nnss_indicator&#39;,&#39;cardholder_id_method&#39;,&#39;moto_eci_indicator&#39;,&#39;acceptance_terminal_indicator&#39;,&#39;merchant_vat&#39;):
                                    value_condition = value_condition.lower().replace(&#39;space&#39;,&#39; &#39;).upper()
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition.replace(&#39;NOT:&#39;,&#39;&#39;)
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[~table_test[condition].astype(str).isin(split_condition)]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).isin(split_condition)]
                                    continue
                                if condition in (&#39;transaction_amount&#39;):
                                    table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                    value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;transaction_amount_currency&#39;][count_row]).lower()}&#34;
                                    table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                    table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{value_condition_currency} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;surcharge_amount&#39;,&#39;timeliness&#39;):
                                    table_test = table_test[table_test[condition] != &#39;BLANK&#39;]
                                    table_test[condition] = pd.to_numeric(table_test[condition])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        query_condition = f&#34;{condition} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[condition].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;merchant_category_code&#39;):
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                        else:
                                            table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                        else:
                                            table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                    continue
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                                else:
                                    value_condition = value_condition.upper()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        value_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                                if table_test.empty:
                                    break
                            except ValueError as error:                   
                                log.logs().exist_file(
                                &#34;OPERATIONAL&#34;,
                                &#34;&#34;,
                                &#34;VISA&#34;,
                                self.log_name,
                                &#34;ADAPTER OF VISA FILE&#34;,
                                &#34;ERROR&#34;,
                                &#34;Error has occurred:&#34;+ str(error),
                                self.module
                                )  
            if len(table_test)&gt;0:
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;cod_hierarchy&#39;] = table_rules[&#39;cod_hierarchy&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
            count_row+=1
        if len(table_work)&gt;0:
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;VISA&#34;,
            self.log_name,
            &#34;INTERCHANGE OF VISA FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            table_work = table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;cod_hierarchy&#39;,&#39;valid_from&#39;]].applymap(str)
            table_work[&#34;intelica_id&#34;] = table_work[&#34;intelica_id&#34;].replace(&#34;nan&#34;,None)
            table_work[&#34;region_country_code&#34;] = table_work[&#34;region_country_code&#34;].replace(&#34;nan&#34;,None)
            self.ps.insert_from_df(table_work,table_schema_source.lower(),table_name_result)
            return table_name_result
        return &#39;-1&#39;

    def mastercard_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
        &#34;&#34;&#34;Direct Assignment Exchange Rules
        
        Args:
            table_schema_source (str): schema of table source
            table_name_source (str): table source name
            string_date (str): date filter

        Returns:
            table_name_result (str): Table name as result
        
        &#34;&#34;&#34;
        table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
        dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
        table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
        table_work = pd.DataFrame(self.ps.select(table))
        if table_work.empty:
            query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from, null ird from {table}&#39;
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_create,
            self.module
            )  

            return table_name_result
        table_work[&#39;rule&#39;] = 0
        table_work[&#39;id&#39;] = table_work.index + 1
        table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_mc r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and (region_country_code,ird) in (select jurisdiction,ird from {table} group by 1,2) order by region_country_code,intelica_id::numeric&#34;))
        table_rules[&#39;key&#39;] = table_rules.index + 1
        count_row=0
        count_condition = 0
        for rule in table_rules[&#39;key&#39;].values:
            table_test = pd.DataFrame()
            table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0) &amp; (table_work[&#39;ird&#39;] == table_rules[&#39;ird&#39;][count_row])],how=&#39;right&#39;)
            for condition in table_rules.columns.values:
                if condition not in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;amount_transaction_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_category&#39;,&#39;fee_tier&#39;,&#39;intelica_id&#39;,&#39;ird&#39;,&#39;rate_currency&#39;,&#39;rate_variable&#39;,&#39;rate_fixed&#39;,&#39;rate_min&#39;,&#39;rate_cap&#39;,&#39;masterpass_incentive_indicator&#39;,&#39;tti&#39;,&#39;additional_data&#39;,&#39;mastercard_assigned_id&#39;):
                    value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                    if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                        if len(table_test)&gt;0:
                            try:
                                if condition in (&#39;amount_transaction&#39;):
                                    table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                    value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;amount_transaction_currency&#39;][count_row]).lower()}&#34;
                                    table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                    table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                    if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                        list_value_condition = value_condition.split(&#39;,&#39;)
                                        for value_str in list_value_condition:
                                            query_condition = f&#34;{value_condition_currency} {value_str.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                            table_test.query(query_condition,inplace=True)
                                    elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                        split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                        table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                    else:
                                        table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                    continue
                                if condition in (&#39;card_acceptor_business_code&#39;):
                                    if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                        value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                        else:
                                            table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                    else:
                                        split_condition = value_condition.split(&#39;,&#39;)
                                        if len(split_condition)&lt;2:
                                            table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                        else:
                                            table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                    continue
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                                else:
                                    value_condition = value_condition.upper()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        if value_condition.find(&#39;.&#39;)&gt;=0:
                                            if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                                value_condition = str(int(float(value_condition)))
                                        table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        value_condition = value_condition.split(&#39;,&#39;)
                                        table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                                if table_test.empty:
                                    break
                            except ValueError as error:                   
                                log.logs().exist_file(
                                &#34;OPERATIONAL&#34;,
                                &#34;&#34;,
                                &#34;MASTERCARD&#34;,
                                self.log_name,
                                &#34;ADAPTER OF MASTERCARD FILE&#34;,
                                &#34;ERROR&#34;,
                                &#34;Error has occurred:&#34;+ str(error),
                                self.module
                                )  
            if len(table_test)&gt;0:
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
                table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;ird&#39;] = table_rules[&#39;ird&#39;][count_row]
            count_row+=1
        if len(table_work)&gt;0:
            message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            &#34;&#34;,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_drop,
            self.module
            )  
            self.ps.insert_from_df(table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;valid_from&#39;,&#39;ird&#39;]].applymap(str),table_schema_source.lower(),table_name_result)
            return table_name_result
        return &#39;-1&#39; </code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.config_additional_table"><code class="name flex">
<span>def <span class="ident">config_additional_table</span></span>(<span>self, string_start_date: str = None, string_end_date: str = None, config_table_name: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Configuration of the additional tables</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_start_date</code></strong> :&ensp;<code>str</code></dt>
<dd>start date for range condition
</dd>
<dt><strong><code>string_end_date</code></strong> :&ensp;<code>str</code></dt>
<dd>ending date for range condition</dd>
<dt><strong><code>config_table_name</code></strong> :&ensp;<code>str</code></dt>
<dd>name of table to config</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def config_additional_table(self, string_start_date : str = None, string_end_date : str = None, config_table_name : str = None) -&gt;str:
    &#34;&#34;&#34;Configuration of the additional tables
    Args:
        string_start_date (str): start date for range condition  
        string_end_date (str): ending date for range condition
        config_table_name (str): name of table to config

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;operational&#39;
    adapter_table_name = &#39;additional_tables_structure&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
    list_except_table_type = [&#39;exchange_rate&#39;]
    if string_start_date == None:
        string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    if string_end_date == None:
        string_end_date = string_start_date
    customer_table = &#39;control.t_customer&#39;
    list_table = self.ps.select(adapter_table,&#39; order by table_name,column_order&#39;)
    df_table = pd.DataFrame(list_table)
    list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
    table_scheme = &#39;operational&#39;
    for table_name in df_table[&#39;table_name&#39;].drop_duplicates().values:
        columns = []
        table_type = df_table[df_table[&#39;table_name&#39;] == table_name].reset_index(drop=True)[&#39;table_type&#39;][0]
        table_frequency = df_table[df_table[&#39;table_name&#39;] == table_name].reset_index(drop=True)[&#39;table_load_frequency&#39;][0]
        customer_code = self.customer_code
        if config_table_name != None and config_table_name != table_name:
            continue
        columns.extend(column_base)
        for column_name in df_table[df_table[&#39;table_name&#39;] == table_name][&#39;column_name&#39;]:
            df_row = df_table[(df_table[&#39;table_name&#39;] == table_name) &amp; (df_table[&#39;column_name&#39;]== column_name)].reset_index(drop=True)
            columns.append({&#39;column_name&#39;:df_row[&#39;column_name&#39;][0],&#39;length&#39;:df_row[&#39;column_length&#39;][0],&#39;column_type&#39;:df_row[&#39;column_type&#39;][0],&#39;column_decimal&#39;:df_row[&#39;column_decimal&#39;][0]})
        if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):
            if table_type in list_except_table_type:
                result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_processing_date&#39;,&#39;range&#39;)
            else:
                result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_customer_code&#39;,&#39;list&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA AND MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )
        df_x = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name))
        df_y = pd.DataFrame(columns)
        if len(df_x) != len(df_y):
            list_table_difference = []
            for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                if not value in (df_x[&#39;column_name&#39;].values):
                    list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
            result_message = self.ps.add_column(list_table_difference,table_scheme,table_name)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA AND MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )

        if table_type == &#39;transaction&#39;:
            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )
 
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date,table_frequency)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )


            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date,table_frequency)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )


        elif table_type in list_except_table_type:
            partition_name = table_name
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name,table_scheme,partition_name,string_start_date,string_end_date,table_frequency)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            table_type,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )
            message_create_table_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
        else:
            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_&#39;+table_type,f&#34;&#39;{table_type}&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )      
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_&#39;+table_type,table_scheme,partition_name+&#39;_&#39;+table_type,string_start_date,string_end_date,table_frequency)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )      
    
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA AND MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_create_table_index),
        self.module
        )   
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.config_additional_table_others"><code class="name flex">
<span>def <span class="ident">config_additional_table_others</span></span>(<span>self, string_start_date: str = None, string_end_date: str = None, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Configuration of the other additional tables</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_start_date</code></strong> :&ensp;<code>str</code></dt>
<dd>start date for range condition
</dd>
<dt><strong><code>string_end_date</code></strong> :&ensp;<code>str</code></dt>
<dd>ending date for range condition</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def config_additional_table_others(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
    &#34;&#34;&#34;Configuration of the other additional tables
    
    Args:
        string_start_date (str): start date for range condition  
        string_end_date (str): ending date for range condition

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;operational&#39;
    adapter_table_name = &#39;additional_tables_structure&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
    if string_start_date == None:
        string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    if string_end_date == None:
        string_end_date = string_start_date
    customer_table = &#39;control.t_customer&#39;
    list_table = self.ps.select(adapter_table,&#39; order by table_name,column_order&#39;)
    df_table = pd.DataFrame(list_table)
    list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
    table_scheme = &#39;operational&#39;
    for table_name in df_table[&#39;table_name&#39;].drop_duplicates().values:
        columns = []
        columns.extend(column_base)
        for column_name in df_table[df_table[&#39;table_name&#39;] == table_name][&#39;column_name&#39;]:
            df_row = df_table[(df_table[&#39;table_name&#39;] == table_name) &amp; (df_table[&#39;column_name&#39;]== column_name)].reset_index(drop=True)
            columns.append({&#39;column_name&#39;:df_row[&#39;column_name&#39;][0],&#39;length&#39;:str(int(df_row[&#39;column_length&#39;][0])),&#39;column_type&#39;:df_row[&#39;column_type&#39;][0],&#39;column_decimal&#39;:str(int(df_row[&#39;column_decimal&#39;][0]))})
        if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):

            result_message = self.ps.create_table(columns,table_scheme+&#39;.&#39;+table_name,True,&#39;app_customer_code&#39;,&#39;list&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
            )    

        df_x = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name))
        df_y = pd.DataFrame(columns)
        if len(df_x) != len(df_y):
            list_table_difference = []
            for index, value in enumerate(df_y[&#39;column_name&#39;].values):
                if not value in (df_x[&#39;column_name&#39;].values):
                    list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
            message_column = self.ps.add_column(list_table_difference,table_scheme,table_name)

            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_column,
            self.module
            )    


        for customer in list_customer:
            customer_code = customer[&#39;code&#39;]
            partition_name = table_name+&#39;_&#39;+customer_code
            message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )    

            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )    
            message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )  
            message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
            
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )      
   
            message_partition  = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)
    
            log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            message_partition,
            self.module
            )  
    
    
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.fill_range"><code class="name flex">
<span>def <span class="ident">fill_range</span></span>(<span>self, list_value: list) ‑> list</span>
</code></dt>
<dd>
<div class="desc"><p>Generating a fill list</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>list_value</code></strong> :&ensp;<code>list</code></dt>
<dd>list of values </dd>
</dl>
<h2 id="returns">Returns</h2>
<p>list_string (list): list of processed values</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def fill_range(self,list_value:list)-&gt; list:
    &#34;&#34;&#34;Generating a fill list
    
    Args:
        list_value (list): list of values 

    Returns:
        list_string (list): list of processed values
    
    &#34;&#34;&#34;
    new_list = []
    list_string = []
    for value in list_value:
        if str(value).find(&#39;-&#39;)&gt;0:
            split_value=value.split(&#39;-&#39;)
            new_list.extend(range(int(split_value[0]),int(split_value[1])+1))
        else:
            new_list.append(int(value))
    list_string = map(str, new_list)
    return list_string</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_mastercard_interchange"><code class="name flex">
<span>def <span class="ident">load_mastercard_interchange</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None, number_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Mastercard exchange charge per adapter</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
<dt><strong><code>number_file</code></strong> :&ensp;<code>str</code></dt>
<dd>number of file in sequence</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_mastercard_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
    &#34;&#34;&#34;Mastercard exchange charge per adapter
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file
        number_file (str): number of file in sequence

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_mastercard_interchange&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    module = &#39;ADAPTER&#39;
    str_currency = &#39;&#39;
    str_condition_currency = &#39;&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading mastercard interchange&#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )   
    table_rules = self.ps.select(&#39;operational.m_interchange_rules_mc&#39;,&#39;where amount_transaction_currency is not null group by 1&#39;,&#39;amount_transaction_currency&#39;)
    if len(table_rules)&gt;0:
        for rules in table_rules:
            str_currency += f&#34;,coalesce((t.amount_transaction*case when cu.currency_alphabetic_code = &#39;{rules[&#39;amount_transaction_currency&#39;]}&#39; then 1 else ex_{rules[&#39;amount_transaction_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) amount_transaction_{rules[&#39;amount_transaction_currency&#39;]} &#34;
            str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;amount_transaction_currency&#39;]} on (ex_{rules[&#39;amount_transaction_currency&#39;]}.app_processing_date=to_date(to_char(t.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) and ex_{rules[&#39;amount_transaction_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;amount_transaction_currency&#39;]}.currency_to=&#39;{rules[&#39;amount_transaction_currency&#39;]}&#39; and ex_{rules[&#39;amount_transaction_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

    query_tmp = f&#34;&#34;&#34;
    SELECT 
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
    ,coalesce(tcf.jurisdiction_assigned::text,&#39;BLANK&#39;) jurisdiction
    ,coalesce(trim(t.business_activity_4)::text,&#39;BLANK&#39;) ird
    ,coalesce(trim(left(t.processing_code,2)),&#39;BLANK&#39;) processing_code
    ,coalesce(t.amount_transaction::text,&#39;BLANK&#39;) amount_transaction
    ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) amount_transaction_currency
    {str_currency}
    ,coalesce(t.card_acceptor_business_code_mcc::text,&#39;BLANK&#39;) card_acceptor_business_code
    ,coalesce(trim(tcf.gcms_product_identifier)::text,&#39;BLANK&#39;) gcms_product_identifier
    ,coalesce(trim(tcf.funding_source),&#39;BLANK&#39;) funding_source
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
    inner join operational.dh_mastercard_calculated_field_{customer_code}_{type_file}_{string_date} tcf
    on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
    left join operational.m_currency cu
    on (cu.currency_numeric_code = t.currency_code_transaction::int)
    {str_condition_currency}
    where t.app_hash_file=&#39;{hash_file}&#39;
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_interchange_eval&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    table_name_tmp = self.mastercard_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
    if table_name_tmp == &#39;-1&#39;:
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;MASTERCARD&#34;,
                self.log_name,
                &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    ps_block.drop_table(table_tmp)
    query_tmp = f&#34;&#34;&#34;
    with tmp_pre as
    (
    select to_date(to_char(a.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) date_and_time_local_transaction,a.currency_code_transaction::numeric currency_code_transaction
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
    group by 1,2
    )
    select *
    from operational.dh_exchange_rate er
    where (er.app_processing_date,er.currency_from_code::numeric) in (select date_and_time_local_transaction,currency_code_transaction from tmp_pre)
    and er.brand=&#39;MasterCard&#39;
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_ex_rate&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,a.amount_transaction
    ,a.currency_code_transaction currency_transaction
    ,c.rate_currency
    ,c.rate_variable::numeric
    ,c.rate_fixed::numeric
    ,c.rate_min::numeric
    ,c.rate_cap::numeric
    ,case
        when c.rate_variable is null then rate_fixed::numeric
        when not operational.isnumeric(c.rate_variable) then null
        else
            case
                when (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0) &lt;= rate_min then rate_min::numeric
                when (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0) &gt;= rate_cap then rate_cap::numeric
                else (rate_variable::numeric * (a.amount_transaction*case when c.rate_currency is null then 1 when c.rate_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.rate_fixed,0)
            end
    end calculated_value,
    e.intelica_id::numeric,
    e.region_country_code,
    e.ird
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
    inner join temporal.{customer_code}_{type_file}_{number_file}_mastercard_interchange_eval_assign e
    on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
    inner join operational.m_interchange_rules_mc c
    on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code and c.ird = e.ird 
    and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
    left join operational.m_currency cur on cur.currency_numeric_code = a.currency_code_transaction::numeric
    left join {table_tmp} er
    on (er.date=to_date(to_char(a.date_and_time_local_transaction,&#39;yyyymmdd&#39;),&#39;yyyymmdd&#39;) and er.currency_from_code::numeric=a.currency_code_transaction::numeric and er.currency_to=c.rate_currency and lower(er.brand)=&#39;mastercard&#39;)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_mastercard_interchange&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    message_insert = self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_insert,
    self.module
    )  

    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )

    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_visa_interchange"><code class="name flex">
<span>def <span class="ident">load_visa_interchange</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None, number_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Visa exchange charge per adapter</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
<dt><strong><code>number_file</code></strong> :&ensp;<code>str</code></dt>
<dd>number of file in sequence</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_visa_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
    &#34;&#34;&#34;Visa exchange charge per adapter
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file
        number_file (str): number of file in sequence

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_interchange&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    str_currency = &#39;&#39;
    str_condition_currency = &#39;&#39;
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading visa interchange &#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )

    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

    table_rules = self.ps.select(&#39;operational.m_interchange_rules_visa&#39;,&#39;where transaction_amount_currency is not null group by 1&#39;,&#39;transaction_amount_currency&#39;)
    if len(table_rules)&gt;0:
        for rules in table_rules:
            str_currency += f&#34;,coalesce((t.source_amount*case when cu.currency_alphabetic_code = &#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; then 1 else ex_{rules[&#39;transaction_amount_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) transaction_amount_{rules[&#39;transaction_amount_currency&#39;]} &#34;
            str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;transaction_amount_currency&#39;]} on (ex_{rules[&#39;transaction_amount_currency&#39;]}.app_processing_date=t.purchase_date and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_to=&#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; and ex_{rules[&#39;transaction_amount_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

    query_tmp = f&#34;&#34;&#34;
    SELECT 
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
    ,coalesce(upper(tcf.jurisdiction_assigned)::text,&#39;BLANK&#39;) jurisdiction
    ,coalesce(upper(tcf.business_mode)::text,&#39;BLANK&#39;) business_mode,
    coalesce(tcf.issuer_country::text,&#39;BLANK&#39;) issuer_country,
    coalesce(c.visa_region_code::text,&#39;BLANK&#39;) issuer_region
    ,coalesce(tcf.technology_indicator::text,&#39;BLANK&#39;)technology_indicator
    ,coalesce(tcf.product_id::text,&#39;BLANK&#39;)product_id
    ,coalesce(tcf.fast_funds::text,&#39;BLANK&#39;)fast_funds
    ,coalesce(tcf.travel_indicator::text,&#39;BLANK&#39;)travel_indicator
    ,coalesce(tcf.b2b_program_id::text,&#39;BLANK&#39;)b2b_program_id
    ,coalesce(tcf.funding_source::text,&#39;BLANK&#39;) account_funding_source
    ,coalesce(tcf.nnss_indicator::text,&#39;BLANK&#39;)nnss_indicator
    ,coalesce(tcf.product_subtype::text,&#39;BLANK&#39;)product_subtype
    ,coalesce(right(lpad(t.transaction_code::text,2,&#39;0&#39;),2),&#39;BLANK&#39;) transaction_code
    ,coalesce(t.transaction_code_qualifier_0::text,&#39;BLANK&#39;) transaction_code_qualifier
    ,coalesce(t.account_number::text,&#39;BLANK&#39;) payment_credential_combination
    ,coalesce(t.account_reference_number_acquiring_identifier::text,&#39;BLANK&#39;) acquiring_identifier
    ,coalesce(t.source_amount::text,&#39;BLANK&#39;) transaction_amount
    {str_currency}
    ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) transaction_amount_currency
    ,coalesce(t.merchant_country_code::text,&#39;BLANK&#39;) acquirer_country
    ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) acquirer_region
    ,coalesce(t.merchant_country_code::text,&#39;BLANK&#39;)merchant_country_code
    ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) merchant_country_region
    ,coalesce(t.merchant_category_code::text,&#39;BLANK&#39;)merchant_category_code
    ,coalesce(t.requested_payment_service::text,&#39;BLANK&#39;)requested_payment_service
    ,coalesce(t.usage_code::text,&#39;BLANK&#39;)usage_code
    ,coalesce(t.authorization_characteristics_indicator::text,&#39;BLANK&#39;)authorization_characteristics_indicator
    ,coalesce(tcf.authorization_code_valid::text,&#39;BLANK&#39;) authorization_code
    ,coalesce(t.pos_terminal_capacity::text,&#39;BLANK&#39;) pos_terminal_capability
    ,coalesce(t.cardholder_id_method::text,&#39;BLANK&#39;)cardholder_id_method
    ,coalesce(t.pos_entry_mode::text,&#39;BLANK&#39;)pos_entry_mode
    ,coalesce(tcf.timeless::text,&#39;BLANK&#39;) timeliness
    ,coalesce(t.reimbursement_attribute::text,&#39;BLANK&#39;)reimbursement_attribute
    ,coalesce(t.special_condition_indicator_merchant_transaction_indicator::text,&#39;BLANK&#39;) special_condition_indicator
    ,coalesce(t.fee_program_indicator::text,&#39;BLANK&#39;)fee_program_indicator
    ,&#39;BLANK&#39; processing_code
    ,coalesce(t.motoec_indicator::text,&#39;BLANK&#39;) moto_eci_indicator
    ,coalesce(t.acceptance_terminal_indicator::text,&#39;BLANK&#39;)acceptance_terminal_indicator
    ,coalesce(t.prepaid_card_indicator::text,&#39;BLANK&#39;)prepaid_card_indicator
    ,coalesce(t.pos_environment::text,&#39;BLANK&#39;) pos_environment_code
    ,coalesce(case
        when business_format_code_sp = &#39;SP&#39; then business_format_code_sp
        when business_format_code_sd = &#39;SD&#39; then business_format_code_sd
        when business_format_code_pd = &#39;PD&#39; then business_format_code_pd
        when business_format_code_ft = &#39;FT&#39; then business_format_code_ft
        when business_format_code_fl = &#39;FL&#39; then business_format_code_fl
        when business_format_code_df = &#39;DF&#39; then business_format_code_df
        when business_format_code_cr = &#39;CR&#39; then business_format_code_cr
    end::text,&#39;BLANK&#39;) business_format_code
    ,coalesce(t.business_application_id_cr::text,&#39;BLANK&#39;) business_application_id
    ,coalesce(t.type_of_purchase_fl::text,&#39;BLANK&#39;) type_purchase
    ,coalesce(case 
        when business_format_code_sd = &#39;SD&#39; then network_identification_code_sd
        when business_format_code_df = &#39;DF&#39; then network_identification_code_df
        when business_format_code_sp = &#39;SP&#39; then network_identification_code_sp
    end::text,&#39;BLANK&#39;) network_identification_code
    ,coalesce(case 
        when business_format_code_sd = &#39;SD&#39; then message_reason_code_sd
        when business_format_code_df = &#39;DF&#39; then message_reason_code_df
        when business_format_code_sp = &#39;SP&#39; then message_reason_code_sp
    end::text,&#39;BLANK&#39;) message_reason_code
    ,coalesce(case 
        when business_format_code_sd = &#39;SD&#39; then surcharge_amount_sd
        when business_format_code_sp = &#39;SP&#39; then surcharge_amount_sp
    end::text,&#39;BLANK&#39;) surcharge_amount
    ,coalesce(t.authorized_amount::text,&#39;BLANK&#39;)authorized_amount
    ,coalesce(t.authorization_response_code::text,&#39;BLANK&#39;)authorization_response_code
    ,coalesce(t.validation_code::text,&#39;BLANK&#39;)validation_code
    ,coalesce(t.merchant_verification_value::text,&#39;BLANK&#39;)merchant_verification_value
    ,coalesce(t.dcc_indicator::text,&#39;BLANK&#39;) dynamic_currency_conversion_indicator
    ,coalesce(substr(t.pan_token::text,2,1),&#39;BLANK&#39;) authorization_characteristics_indicator_5
    ,coalesce(t.cvv_result_code::text,&#39;BLANK&#39;) cvv2_result_code
    ,coalesce(t.national_tax_included::text,&#39;BLANK&#39;) national_tax_indicator
    ,coalesce(t.merchant_vat_registration_number::text,&#39;BLANK&#39;) merchant_vat
    ,coalesce(t.summary_commodity_code::text,&#39;BLANK&#39;) summary_commodity
    ,coalesce(t.message_identifier::text,&#39;BLANK&#39;)message_identifier
    ,&#39;BLANK&#39; processing_code_transaction_type
    ,&#39;BLANK&#39; point_of_service_condition_code
    from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
    inner join operational.dh_visa_transaction_calculated_field_{customer_code}_{type_file}_{string_date} tcf
    on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
    left join operational.m_country c
    on (c.country_code = tcf.issuer_country)
    left join operational.m_country c2
    on (c2.country_code = t.merchant_country_code)
    left join operational.m_currency cu
    on (cu.currency_numeric_code = t.source_currency_code::int)
    {str_condition_currency}
    where t.app_hash_file=&#39;{hash_file}&#39;
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_interchange_eval&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    ) 

    table_name_tmp = self.visa_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
    if table_name_tmp == &#39;-1&#39;:
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;INTERCHANGE OF VISA FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    ps_block.drop_table(table_tmp)
    query_tmp = f&#34;&#34;&#34;
    with tmp_pre as
    (
    select a.purchase_date,a.source_currency_code::numeric source_currency_code
    from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} a
    group by 1,2
    )
    select *
    from operational.dh_exchange_rate er
    where (er.app_processing_date,er.currency_from_code::numeric) in (select purchase_date,source_currency_code from tmp_pre)
    and er.brand=&#39;VISA&#39;
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_ex_pre&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,a.source_amount amount_transaction
    ,a.source_currency_code currency_transaction
    ,c.fee_currency
    ,c.fee_variable::numeric
    ,c.fee_fixed::numeric
    ,c.fee_min::numeric
    ,c.fee_cap::numeric
    ,case
        when c.fee_variable is null then fee_fixed::numeric
        when not operational.isnumeric(c.fee_variable) then null
        else
            case
                when (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &lt;= fee_min then fee_min::numeric
                when (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &gt;= fee_cap then fee_cap::numeric
                else (fee_variable::numeric * (a.source_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0)
            end
    end calculated_value,
    e.intelica_id::numeric
    ,e.region_country_code
    from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} a
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_{number_file}_visa_interchange_eval_assign e
    on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
    left join operational.m_interchange_rules_visa c
    on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code
    and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
    left join operational.m_currency cur on cur.currency_numeric_code = a.source_currency_code::numeric
    left join {table_tmp} er
    on (er.date=a.purchase_date and er.currency_from_code::numeric=a.source_currency_code::numeric and er.currency_to=c.fee_currency and lower(er.brand)=&#39;visa&#39;)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_interchange&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )   

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    ) 

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )

    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;INTERCHANGE OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_visa_sms_interchange"><code class="name flex">
<span>def <span class="ident">load_visa_sms_interchange</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None, number_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Visa exchange charge per adapter</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
<dt><strong><code>number_file</code></strong> :&ensp;<code>str</code></dt>
<dd>number of file in sequence</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_visa_sms_interchange(self, string_date: str = None,type_file: str = None, hash_file:str =None, number_file:str=None)-&gt;str:
    &#34;&#34;&#34;Visa exchange charge per adapter
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file
        number_file (str): number of file in sequence

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_sms_interchange&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    module = &#39;ADAPTER&#39;
    str_currency = &#39;&#39;
    str_condition_currency = &#39;&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading visa interchange &#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )

    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    table_rules = self.ps.select(&#39;operational.m_interchange_rules_visa&#39;,&#39;where transaction_amount_currency is not null group by 1&#39;,&#39;transaction_amount_currency&#39;)
    if len(table_rules)&gt;0:
        for rules in table_rules:
            str_currency += f&#34;,coalesce((t.transaction_amount*case when cu.currency_alphabetic_code = &#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; then 1 else ex_{rules[&#39;transaction_amount_currency&#39;]}.exchange_value end)::text,&#39;BLANK&#39;) transaction_amount_{rules[&#39;transaction_amount_currency&#39;]} &#34;
            str_condition_currency += f&#34;left join operational.dh_exchange_rate ex_{rules[&#39;transaction_amount_currency&#39;]} on (ex_{rules[&#39;transaction_amount_currency&#39;]}.app_processing_date=t.local_transaction_date and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_from = cu.currency_alphabetic_code and ex_{rules[&#39;transaction_amount_currency&#39;]}.currency_to=&#39;{rules[&#39;transaction_amount_currency&#39;]}&#39; and ex_{rules[&#39;transaction_amount_currency&#39;]}.brand=&#39;VISA&#39;) &#34;

    query_tmp = f&#34;&#34;&#34;
    SELECT 
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
    ,coalesce(upper(tcf.jurisdiction_assigned)::text,&#39;BLANK&#39;) jurisdiction
    ,coalesce(upper(tcf.business_mode)::text,&#39;BLANK&#39;) business_mode,
    coalesce(tcf.issuer_country::text,&#39;BLANK&#39;) issuer_country,
    coalesce(c.visa_region_code::text,&#39;BLANK&#39;) issuer_region
    ,coalesce(tcf.technology_indicator::text,&#39;BLANK&#39;)technology_indicator
    ,coalesce(tcf.product_id::text,&#39;BLANK&#39;)product_id
    ,coalesce(tcf.fast_funds::text,&#39;BLANK&#39;)fast_funds
    ,coalesce(tcf.travel_indicator::text,&#39;BLANK&#39;)travel_indicator
    ,coalesce(tcf.b2b_program_id::text,&#39;BLANK&#39;)b2b_program_id
    ,coalesce(tcf.funding_source::text,&#39;BLANK&#39;) account_funding_source
    ,coalesce(tcf.nnss_indicator::text,&#39;BLANK&#39;)nnss_indicator
    ,coalesce(tcf.product_subtype::text,&#39;BLANK&#39;)product_subtype
    ,coalesce(tcf.transaction_code_sms,&#39;BLANK&#39;) transaction_code
    --,coalesce(t.transaction_code_qualifier_0::text,&#39;BLANK&#39;) transaction_code_qualifier
    --,coalesce(t.account_number::text,&#39;BLANK&#39;) payment_credential_combination
    ,coalesce(t.transaction_amount::text,&#39;BLANK&#39;) transaction_amount
    {str_currency}
    ,coalesce(cu.currency_alphabetic_code::text,&#39;BLANK&#39;) transaction_amount_currency
    ,coalesce(t.card_acceptor_country::text,&#39;BLANK&#39;) acquirer_country
    ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) acquirer_region
    ,coalesce(t.card_acceptor_country::text,&#39;BLANK&#39;)merchant_country_code
    ,coalesce(c2.visa_region_code::text,&#39;BLANK&#39;) merchant_country_region
    ,coalesce(t.merchants_type::text,&#39;BLANK&#39;)merchant_category_code
    ,coalesce(t.requested_payment_service::text,&#39;BLANK&#39;) requested_payment_service
    ,coalesce(t.usage_code_sms::text,&#39;BLANK&#39;)usage_code
    ,coalesce(t.authorization_characteristics_indicator_sms::text,&#39;BLANK&#39;)authorization_characteristics_indicator
    ,coalesce(tcf.authorization_code_valid::text,&#39;BLANK&#39;) authorization_code
    ,coalesce(t.pos_terminal_entry_capability::text,&#39;BLANK&#39;) pos_terminal_capability
    ,coalesce(t.customer_identification_method::text,&#39;BLANK&#39;)cardholder_id_method
    ,coalesce(left(t.pos_entry_mode_sms::text,2),&#39;BLANK&#39;)pos_entry_mode
    ,coalesce(tcf.timeless::text,&#39;BLANK&#39;) timeliness
    ,coalesce(t.reimbursement_attribute_sms::text,&#39;BLANK&#39;)reimbursement_attribute
    ,coalesce(t.chargeback_special_condition_merchant_indicator::text,&#39;BLANK&#39;) special_condition_indicator
    ,coalesce(t.fee_program_indicator_sms::text,&#39;BLANK&#39;)fee_program_indicator
    --,&#39;BLANK&#39; processing_code
    ,coalesce(t.mailtelephone_or_electronic_commerce_indicator::text,&#39;BLANK&#39;) moto_eci_indicator
    ,coalesce(right(t.pos_terminal_type,1)::text,&#39;BLANK&#39;)acceptance_terminal_indicator
    --,coalesce(t.prepaid_card_indicator::text,&#39;BLANK&#39;)prepaid_card_indicator
    ,coalesce(t.recurring_payment_indicator_flag::text,&#39;BLANK&#39;) pos_environment_code
    /*,coalesce(case
        when business_format_code_sp = &#39;SP&#39; then business_format_code_sp
        when business_format_code_sd = &#39;SD&#39; then business_format_code_sd
        when business_format_code_pd = &#39;PD&#39; then business_format_code_pd
        when business_format_code_ft = &#39;FT&#39; then business_format_code_ft
        when business_format_code_fl = &#39;FL&#39; then business_format_code_fl
        when business_format_code_df = &#39;DF&#39; then business_format_code_df
        when business_format_code_cr = &#39;CR&#39; then business_format_code_cr
    end::text,&#39;BLANK&#39;) business_format_code*/
    ,coalesce(t.business_application_identifier::text,&#39;BLANK&#39;) business_application_id
    --,coalesce(t.type_of_purchase_fl::text,&#39;BLANK&#39;) type_purchase
    ,coalesce(t.network_id::text,&#39;BLANK&#39;) network_identification_code
    ,coalesce(t.message_reason_code_sms::text,&#39;BLANK&#39;) message_reason_code
    ,coalesce(t.surcharge_amount_sms::text,&#39;BLANK&#39;) surcharge_amount
    --,coalesce(t.authorized_amount::text,&#39;BLANK&#39;)authorized_amount
    ,coalesce(t.response_code::text,&#39;BLANK&#39;)authorization_response_code
    --,coalesce(t.validation_code::text,&#39;BLANK&#39;)validation_code
    --,coalesce(t.merchant_verification_value::text,&#39;BLANK&#39;)merchant_verification_value
    ,coalesce(t.dcc_indicator_sms::text,&#39;BLANK&#39;) dynamic_currency_conversion_indicator
    ,coalesce(t.cvv_result_code_sms::text,&#39;BLANK&#39;) cvv2_result_code
    --,coalesce(t.national_tax_included::text,&#39;BLANK&#39;) national_tax_indicator
    --,coalesce(t.merchant_vat_registration_number::text,&#39;BLANK&#39;) merchant_vat
    --,coalesce(t.summary_commodity_code::text,&#39;BLANK&#39;) summary_commodity
    --,coalesce(t.message_identifier::text,&#39;BLANK&#39;)message_identifier
    ,coalesce(left(t.processing_code::text,2),&#39;BLANK&#39;) processing_code_transaction_type
    ,coalesce(t.pos_condition_code::text,&#39;BLANK&#39;) point_of_service_condition_code
    from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
    inner join operational.dh_visa_transaction_sms_calculated_field_{customer_code}_{type_file}_{string_date} tcf
    on (tcf.app_id = t.app_id and tcf.app_hash_file = t.app_hash_file)
    left join operational.m_country c
    on (c.country_code = tcf.issuer_country)
    left join operational.m_country c2
    on (c2.country_code = t.card_acceptor_country)
    left join operational.m_currency cu
    on (cu.currency_numeric_code = t.transaction_currency_code::int)
    {str_condition_currency}
    where t.app_hash_file=&#39;{hash_file}&#39;
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_interchange_eval&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    ) 

    table_name_tmp = self.visa_sms_interchange_rule_assign(table_scheme_tmp,table_name_tmp,string_date)
    if table_name_tmp == &#39;-1&#39;:
        if self.debug == &#39;False&#39;:
            bulk_delete = ps_block.query_block()
            log.logs().exist_file(
                &#34;OPERATIONAL&#34;,
                customer_code,
                &#34;VISA&#34;,
                self.log_name,
                &#34;INTERCHANGE OF VISA SMS FILE&#34;,
                &#34;INFO&#34;,
                bulk_delete,
                self.module
            )
        return &#39;finished&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    ps_block.drop_table(table_tmp)
    query_tmp = f&#34;&#34;&#34;
    with tmp_pre as
    (
    select a.local_transaction_date,a.transaction_currency_code::numeric transaction_currency_code
    from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} a
    group by 1,2
    )
    select *
    from operational.dh_exchange_rate er
    where (er.app_processing_date,er.currency_from_code::numeric) in (select local_transaction_date,transaction_currency_code from tmp_pre)
    and er.brand=&#39;VISA&#39;
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_ex_pre&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,a.transaction_amount amount_transaction
    ,a.transaction_currency_code currency_transaction
    ,c.fee_currency
    ,c.fee_variable::numeric
    ,c.fee_fixed::numeric
    ,c.fee_min::numeric
    ,c.fee_cap::numeric
    ,case
        when c.fee_variable is null then fee_fixed::numeric
        when not operational.isnumeric(c.fee_variable) then null
        else
            case
                when (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &lt;= fee_min then fee_min::numeric
                when (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0) &gt;= fee_cap then fee_cap::numeric
                else (fee_variable::numeric * (a.transaction_amount*case when c.fee_currency is null then 1 when c.fee_currency = cur.currency_alphabetic_code then 1 else er.exchange_value end)) + coalesce(c.fee_fixed,0)
            end
    end calculated_value,
    e.intelica_id::numeric
    ,e.region_country_code
    from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} a
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_{number_file}_visa_sms_interchange_eval_assign e
    on (a.app_id = e.app_id::numeric and a.app_hash_file = e.app_hash_file)
    left join operational.m_interchange_rules_visa c
    on (c.intelica_id = e.intelica_id and c.region_country_code = e.region_country_code
    and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between c.valid_from::date and coalesce(c.valid_until::date,current_date))
    left join operational.m_currency cur on cur.currency_numeric_code = a.transaction_currency_code::numeric
    left join {table_tmp} er
    on (er.date=a.local_transaction_date and er.currency_from_code::numeric=a.transaction_currency_code::numeric and er.currency_to=c.fee_currency and lower(er.brand)=&#39;visa&#39;)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_{number_file}_visa_sms_interchange&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    ) 

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;INTERCHANGE OF VISA SMS FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )

    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;INTERCHANGE OF VISA SMS FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_config_table_adapter_dh"><code class="name flex">
<span>def <span class="ident">mastercard_config_table_adapter_dh</span></span>(<span>self, string_start_date: str = None, string_end_date: str = None, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Configuration of the mastercard adapter table dh</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_start_date</code></strong> :&ensp;<code>str</code></dt>
<dd>starting date for range
</dd>
<dt><strong><code>string_end_date</code></strong> :&ensp;<code>str</code></dt>
<dd>ending date for range </dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_config_table_adapter_dh(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
    &#34;&#34;&#34;Configuration of the mastercard adapter table dh
    
    Args:
        string_start_date (str): starting date for range  
        string_end_date (str): ending date for range 

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_mastercard_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_message_type&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
    module = &#39;ADAPTER&#39;
    &#34;&#34;&#34;log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    &#34;Operational table configuration: &#34;
    + adapter_table_scheme
    + &#34;.&#34;
    + adapter_table_name,
    self.module
    )   &#34;&#34;&#34;
      
    if string_start_date == None:
        string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    if string_end_date == None:
        string_end_date = string_start_date
    customer_table = &#39;control.t_customer&#39;
    list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_start_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date) and type_record&lt;&gt;&#39;private_data_subelement&#39;&#34;,&#39;distinct type_record&#39;)
    list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
    for value in list_type_record:
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard&#39;
        table_name += &#39;_&#39;+value[&#39;type_record&#39;]
        result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],True,True,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by pds,de&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(result_message),
        self.module
        )         
        customer_code = self.customer_code

        partition_name = table_name+&#39;_&#39;+customer_code
        message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )  

        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )  


        message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )  




        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )  

        message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )
        message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_idx&#39;,&#39;app_id,app_hash_file&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        )
        message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        )

    message_index = self.ps.create_table_index(table_scheme,&#39;dh_mastercard_data_element&#39;,&#39;dh_mastercard_data_pan_idx&#39;,&#39;pan&#39;)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    str(message_index),
    self.module
    ) 
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_config_table_adapter_stg"><code class="name flex">
<span>def <span class="ident">mastercard_config_table_adapter_stg</span></span>(<span>self, string_date: str = None, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Configuration of the mastercard adapter table staging</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range
</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_config_table_adapter_stg(self, string_date : str = None,log_name: str = None, client:str = None)-&gt;str:
    &#34;&#34;&#34;Configuration of the mastercard adapter table staging
    
    Args:
       string_date (str): date for range  

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_mastercard_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_message_type&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;text&#39;}]
    table_scheme = &#39;operational&#39;
    table_name_base = &#39;stg_adapter_mastercard&#39;
    module = &#39;ADAPTER&#39;

    pds_code = &#39;2&#39;
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    customer_table = &#39;control.t_customer&#39;
    list_type_record = self.ps.select(adapter_table,f&#34;where pds &lt;{pds_code} and to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
    list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
    for value in list_type_record:
        table_name = table_name_base + &#39;_&#39; + value[&#39;type_record&#39;]        
             
        result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],False,False,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by pds,de&#39;)
           
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(result_message),
        self.module
        )             
       
        customer_code = self.customer_code

        partition_name = table_name+&#39;_&#39;+customer_code
        message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )         

        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )         

        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )         

    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_interchange_rule_assign"><code class="name flex">
<span>def <span class="ident">mastercard_interchange_rule_assign</span></span>(<span>self, table_schema_source: str, table_name_source: str, string_date: str) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Direct Assignment Exchange Rules</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>table_schema_source</code></strong> :&ensp;<code>str</code></dt>
<dd>schema of table source</dd>
<dt><strong><code>table_name_source</code></strong> :&ensp;<code>str</code></dt>
<dd>table source name</dd>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date filter</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>table_name_result (str): Table name as result</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
    &#34;&#34;&#34;Direct Assignment Exchange Rules
    
    Args:
        table_schema_source (str): schema of table source
        table_name_source (str): table source name
        string_date (str): date filter

    Returns:
        table_name_result (str): Table name as result
    
    &#34;&#34;&#34;
    table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
    dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
    table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
    table_work = pd.DataFrame(self.ps.select(table))
    if table_work.empty:
        query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from, null ird from {table}&#39;
        message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  
        message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        return table_name_result
    table_work[&#39;rule&#39;] = 0
    table_work[&#39;id&#39;] = table_work.index + 1
    table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_mc r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and (region_country_code,ird) in (select jurisdiction,ird from {table} group by 1,2) order by region_country_code,intelica_id::numeric&#34;))
    table_rules[&#39;key&#39;] = table_rules.index + 1
    count_row=0
    count_condition = 0
    for rule in table_rules[&#39;key&#39;].values:
        table_test = pd.DataFrame()
        table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0) &amp; (table_work[&#39;ird&#39;] == table_rules[&#39;ird&#39;][count_row])],how=&#39;right&#39;)
        for condition in table_rules.columns.values:
            if condition not in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;amount_transaction_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_category&#39;,&#39;fee_tier&#39;,&#39;intelica_id&#39;,&#39;ird&#39;,&#39;rate_currency&#39;,&#39;rate_variable&#39;,&#39;rate_fixed&#39;,&#39;rate_min&#39;,&#39;rate_cap&#39;,&#39;masterpass_incentive_indicator&#39;,&#39;tti&#39;,&#39;additional_data&#39;,&#39;mastercard_assigned_id&#39;):
                value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                    if len(table_test)&gt;0:
                        try:
                            if condition in (&#39;amount_transaction&#39;):
                                table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;amount_transaction_currency&#39;][count_row]).lower()}&#34;
                                table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                    list_value_condition = value_condition.split(&#39;,&#39;)
                                    for value_str in list_value_condition:
                                        query_condition = f&#34;{value_condition_currency} {value_str.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                        table_test.query(query_condition,inplace=True)
                                elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                    split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                    table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                else:
                                    table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                continue
                            if condition in (&#39;card_acceptor_business_code&#39;):
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                else:
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                continue
                            if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                split_condition = value_condition.split(&#39;,&#39;)
                                if len(split_condition)&lt;2:
                                    if value_condition.find(&#39;.&#39;)&gt;=0:
                                        if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                            value_condition = str(int(float(value_condition)))
                                    table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                else:
                                    table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                            else:
                                value_condition = value_condition.upper()
                                split_condition = value_condition.split(&#39;,&#39;)
                                if len(split_condition)&lt;2:
                                    if value_condition.find(&#39;.&#39;)&gt;=0:
                                        if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                            value_condition = str(int(float(value_condition)))
                                    table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                else:
                                    value_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                            if table_test.empty:
                                break
                        except ValueError as error:                   
                            log.logs().exist_file(
                            &#34;OPERATIONAL&#34;,
                            &#34;&#34;,
                            &#34;MASTERCARD&#34;,
                            self.log_name,
                            &#34;ADAPTER OF MASTERCARD FILE&#34;,
                            &#34;ERROR&#34;,
                            &#34;Error has occurred:&#34;+ str(error),
                            self.module
                            )  
        if len(table_test)&gt;0:
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;ird&#39;] = table_rules[&#39;ird&#39;][count_row]
        count_row+=1
    if len(table_work)&gt;0:
        message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;INTERCHANGE OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  
        self.ps.insert_from_df(table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;valid_from&#39;,&#39;ird&#39;]].applymap(str),table_schema_source.lower(),table_name_result)
        return table_name_result
    return &#39;-1&#39; </code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">mastercard_load_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from mastercard</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_load_calculated_field_dh(self, string_date: str = None, type_file: str = None, hash_file:str = None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from mastercard
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_mastercard_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    
    query_tmp = f&#34;&#34;&#34;
    with iar_pre_1 as (
        select 
        to_date(a.effective_timestamp,&#39;yyddd24H&#39;) effective_date, to_date(to_char(a.app_date_valid::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;) app_date_valid, 
        to_date(to_char(a.app_date_end::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;) app_date_end, 
        left(a.low_range::varchar,18)::numeric low_key_for_range,
        left(a.high_range::varchar,18)::numeric high_key_for_range,
        a.card_country_alpha iar_country, 
        a.card_program_priority::numeric card_program_priority,
        a.card_program_identifier
        ,b.gcms_product_id gcms_product_identifier
        ,b.product_category funding_source
        from operational.dh_mastercard_iar a 
        left join operational.m_mastercard_brand_product b
        on (b.licensed_product_id=a.licensed_product_id and b.active_inactive_code=&#39;A&#39;)
        where to_date(to_char(a.app_date_valid::timestamp,&#39;yyyy-mm-dd&#39;),&#39;yyyy-mm-dd&#39;)&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
        and a.active_inactive_code=&#39;A&#39;
    ), bin_pre_2 as (
        select a.* 
        ,row_number()over(partition by low_key_for_range order by app_date_valid desc,card_program_priority) rn
        from iar_pre_1 a
    )
    select 
    app_date_valid,low_key_for_range::numeric low_key_for_range,high_key_for_range::numeric high_key_for_range,iar_country,gcms_product_identifier,funding_source,card_program_identifier
    from bin_pre_2 a
    where rn=1
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_iar_unique&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    
    query_tmp = f&#34;&#34;&#34;
    select
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date,
    a.&#34;settlement_indicator_1&#34; settlement_indicator,
    left(rpad(pan::varchar,18,&#39;0&#39;),18)::numeric num_card, 
    a.&#34;date_and_time_local_transaction&#34; purchase_date,
    right(a.&#34;card_acceptor_namelocation&#34;,3) card_purchase_country, 
    b.&#34;mastercard_region_code&#34; card_purchase_region
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} a
    left join operational.m_country b
    on b.&#34;country_code_alternative&#34; = right(a.&#34;card_acceptor_namelocation&#34;,3)
    where a.app_message_type in (&#39;1240&#39;,&#39;1442&#39;)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_pre&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_index = self.ps.create_table_index(table_scheme_tmp,table_name_tmp,f&#39;{customer_code}_{type_file}_mccf_pre_idx&#39;,&#39;num_card&#39;)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_index,
    self.module
    )  


    query_tmp = f&#34;&#34;&#34;
    select 
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date,
    case 
        when a.app_type_file = &#39;IN&#39;  then &#39;issuing&#39;
        when a.app_type_file = &#39;OUT&#39; then &#39;acquiring&#39;
        else a.app_type_file 
    end business_mode
    ,case
        when a.card_purchase_country = b.iar_country then
            case 
                when a.settlement_indicator = &#39;C&#39; then &#39;on-us&#39;
                when a.settlement_indicator = &#39;M&#39; then &#39;off-us&#39;
            end
        when a.card_purchase_country &lt;&gt; b.iar_country and bc.mastercard_region_code = ac.mastercard_region_code then &#39;Intraregional&#39;
        when a.card_purchase_country &lt;&gt; b.iar_country and bc.mastercard_region_code &lt;&gt; ac.mastercard_region_code then &#39;Interregional&#39;
        end jurisdiction, bc.country_code jurisdiction_country,r.region_code::text jurisdiction_region
    ,row_number()over(partition by a.app_id,a.app_hash_file order by b.app_date_valid desc,b.high_key_for_range desc) n
    ,b.*
    from {table_tmp} a
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_iar_unique b
    on a.num_card &gt;= b.low_key_for_range and a.num_card &lt;= b.high_key_for_range
    left join operational.m_country ac
    on (ac.country_code_alternative = a.card_purchase_country)
    left join operational.m_country bc
    on (bc.country_code_alternative = b.iar_country)
    left join operational.m_region r
    on (r.region_code = bc.mastercard_region_code)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_pre_2&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp= f&#34;&#34;&#34;
    select 
    t.app_id,t.app_hash_file
    ,t.app_type_file
    ,t.amount_reconciliation
    ,t.amount_transaction
    ,t.currency_code_transaction
    ,t.currency_code_reconciliation
    ,t.app_message_type
    ,ex_local.exchange_value exchange_value_local
    ,ex_settl.exchange_value exchange_value_settlement
    ,cus.local_currency_code
    ,cus.settlement_currency_code
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
    left join control.t_customer cus on cus.code = t.app_customer_code
    left join operational.dh_exchange_rate ex_local on 
    (ex_local.app_processing_date = t.app_processing_date and  trim(ex_local.currency_to)=trim(cus.local_currency_code) and 
        ex_local.currency_from_code = case when t.app_type_file != &#39;IN&#39; then t.currency_code_transaction::text end
    and ex_local.brand=&#39;MasterCard&#39;)
    left join operational.dh_exchange_rate ex_settl on 
    (ex_settl.app_processing_date = t.app_processing_date and  trim(ex_settl.currency_to)=trim(cus.settlement_currency_code) and 
        ex_settl.currency_from_code = case when t.app_type_file != &#39;IN&#39; then t.currency_code_transaction::text end
    and ex_settl.brand=&#39;MasterCard&#39;)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_ex_rate&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    ) 

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  
    
    query_tmp= f&#34;&#34;&#34;
    select app_hash_file,file_id
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date}
    where app_message_type = &#39;1644&#39; and function_code = 697
    group by 1,2
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_fi&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    ) 

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select 
    de.app_id,de.app_hash_file
    ,case 
        when de.app_type_file = &#39;IN&#39; then f_currency_reconcilation.currency_alphabetic_code::text
        else
            case 
                when jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then de.local_currency_code::text 
                else de.settlement_currency_code::text
            end    
    end as settlement_report_currency_code,
    round(
    case 
        when de.app_type_file = &#39;IN&#39; then  amount_reconciliation 
        else 
            case
                when jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then 
                    case 
                        when f_currency.currency_alphabetic_code = local_currency_code then amount_transaction
                        when de.exchange_value_local is not null then  amount_transaction *  de.exchange_value_local
                    end
                else
                    case
                        when f_currency.currency_alphabetic_code = de.settlement_currency_code then amount_transaction
                        when de.exchange_value_settlement is not null then  amount_transaction *  de.exchange_value_settlement
                    end
            end
    end::numeric,2) as settlement_report_amount
    ,fi.file_id mc_file_id
    from {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_ex_rate de 
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_fi fi on (fi.app_hash_file = de.app_hash_file)
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_pre_2 cf on cf.app_id = de.app_id and cf.app_hash_file = de.app_hash_file
    left join operational.m_currency f_currency on f_currency.currency_numeric_code = currency_code_transaction 
    left join operational.m_currency f_currency_reconcilation on f_currency_reconcilation.currency_numeric_code = currency_code_reconciliation
    where  (de.app_message_type = &#39;1240&#39; or de.app_message_type=&#39;1422&#39;)
    and cf.n=1
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field_amount&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    ) 

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    query_tmp = f&#34;&#34;&#34;
    select
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
    tp.business_mode,tp.jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.funding_source,
    tp.gcms_product_identifier,
    tp.card_program_identifier,
    case tp.jurisdiction when &#39;Intraregional&#39; then tp.jurisdiction_region
        when &#39;Interregional&#39; then &#39;9&#39;
        else tp.jurisdiction_country
    end jurisdiction_assigned,
    tp1.settlement_report_currency_code,tp1.settlement_report_amount,tp1.mc_file_id
    ,tp.iar_country
    from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date} t
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_pre_2 tp
    on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
    left join {table_scheme_tmp}.{customer_code}_{type_file}_mastercard_calculated_field_amount tp1
    on (tp1.app_id = t.app_id and tp1.app_hash_file = t.app_hash_file)
    where tp.n=1
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_mastercard_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    message_insert = self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF MASTERCARD FILE&#34;,
    &#34;INFO&#34;,
    message_insert,
    self.module
    )  
    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )

    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_exclusion_transaction"><code class="name flex">
<span>def <span class="ident">mastercard_load_exclusion_transaction</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Load of mastercard excluded transaction</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>Type of file</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_load_exclusion_transaction(self, string_date: str = None,type_file:str=None, hash_file:str=None)-&gt;str:
    &#34;&#34;&#34;Load of mastercard excluded transaction
    
    Args:
        string_date (str): date for range condition  
        type_file (str): Type of file
        type_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    module = &#39;ADAPTER&#39;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_mastercard_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;mastercard file&#34;,
    &#34;INFO&#34;,
    f&#34;loading exclusion transactions type file : {type_file}&#34;,
    self.module
    ) 

    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
    df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
    for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard_exclusion_messages&#39;

        select_query = f&#34;select app_id,app_customer_code,app_type_file,app_hash_file,app_processing_date,source_message_number_id,source_file_id from operational.dh_mastercard_data_element_{customer_code}_{type_file}_{string_date}  where app_message_type = &#39;1644&#39; and function_code =691&#34;
        
        table_tmp = f&#39;tmp_exclusion_transactions_{customer_code}&#39;
        partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
        self.ps.drop_table(table_tmp)
        self.ps.create_table_from_select(select_query,table_tmp)
        result_message = str(self.ps.insert_from_table(&#34;temporal&#34;, table_tmp, table_scheme, table_name))

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        result_message,
        self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_transaction"><code class="name flex">
<span>def <span class="ident">mastercard_load_transaction</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Load of mastercard transaction</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mastercard_load_transaction(self, string_date: str = None,type_file:str=None, hash_file:str=None)-&gt;str:
    &#34;&#34;&#34;Load of mastercard transaction
    
    Args:
        string_date (str): date for range condition  

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    module = &#39;ADAPTER&#39;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_mastercard_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;MASTERCARD&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading transactions type file : &#34;+ type_file,
    self.module
    ) 

    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
    df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
    for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_mastercard&#39;
        table_name_stg = &#39;stg_adapter_mastercard&#39;
        table_name += &#39;_&#39;+value
        table_name_stg += &#39;_&#39;+value
        df_structure_dh = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name,&#39;order by column_name&#39;))
        df_structure_stg = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name_stg,&#39;order by column_name&#39;))

        select_query = &#39;select &#39;
        left_query = &#39;&#39;
        str_column_dh = &#39;&#39;
        for column in df_structure_stg[&#39;column_name&#39;].values:
            if column in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;):
                continue
            str_column_format = column.replace(&#39;]&#39;,&#39;&#39;).replace(&#39;[&#39;,&#39;&#39;).replace(&#39;.&#39;,&#39;&#39;).replace(&#34;&#39;&#34;,&#39;&#39;).replace(&#39;)&#39;,&#39;&#39;).replace(&#39;(&#39;,&#39;&#39;).replace(&#39;/&#39;,&#39;&#39;).replace(&#39;-&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;_&#39;).replace(&#39;___&#39;,&#39;_&#39;).replace(&#39;__&#39;,&#39;_&#39;) + &#39;,&#39;
            str_column_dh += str_column_format
            column = f&#39;&#34;{column}&#34;&#39;
            if column == &#39;&#34;app_id&#34;&#39;:
                column =&#39;a.app_id::numeric&#39;
            elif column in (&#39;&#34;app_customer_code&#34;&#39;,&#39;&#34;app_type_file&#34;&#39;,&#39;&#34;app_hash_file&#34;&#39;,&#39;&#34;app_message_type&#34;&#39;,&#39;&#34;app_creation_user&#34;&#39;,&#39;&#34;app_creation_date&#34;&#39;):
                column = &#39;a.&#39;+column.replace(&#39;&#34;&#39;,&#39;&#39;)
            elif column == &#39;&#34;app_processing_date&#34;&#39;:
                column = f&#34;to_date(app_processing_date,&#39;yymmdd&#39;)&#34;
            elif column == &#39;&#34;pan&#34;&#39;:
                column = f&#34;case when operational.isnumeric(replace({column},&#39;*&#39;,&#39;0&#39;)) then replace({column},&#39;*&#39;,&#39;0&#39;)::bigint end&#34;
            elif column == &#39;&#34;amount transaction&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;amount reconciliation&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;amount cardholder billing&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;conversion rate reconciliation&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then substr({column},2)::numeric/(10^left({column},1)::numeric) end&#34;
            elif column == &#39;&#34;conversion rate cardholder billing&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then substr({column},2)::numeric/(10^left({column},1)::numeric) end&#34;
            elif column == &#39;&#34;amount net transaction in reconciliation currency 2&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;amounts transaction fee 5&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;amounts transaction fee 7&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;amount net fee in reconciliation currency 2&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(100) end&#34;
            elif column == &#39;&#34;date and time local transaction&#34;&#39;:
                column = f&#34;case when operational.isnumeric({column}) then to_timestamp({column},&#39;YYMMDDhh24miss&#39;) end&#34;
            elif column == &#39;&#34;date action&#34;&#39;:
                column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
            elif column == &#39;&#34;amount currency conversion assessment&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;business activity 5&#34;&#39;:
                column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
            elif column == &#39;&#34;settlement data 6&#34;&#39;:
                column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
            elif column == &#39;&#34;settlement data 8&#34;&#39;:
                column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
            elif column == &#39;&#34;business date&#34;&#39;:
                column = f&#34;case when operational.isnumeric({column}) then to_date({column},&#39;yymmdd&#39;) end&#34;
            else:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                if df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0] in [&#39;numeric&#39;,&#39;integer&#39;,&#39;bigint&#39;,&#39;timestamp&#39;,&#39;date&#39;]:
                    column = f&#34;case when operational.isnumeric({column}) then {column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]} end&#34;
                else:
                    column = f&#34;{column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
            select_query += f&#39; {column},&#39;
        
        left_query = f&#34;&#34;&#34;
        left join operational.m_currency c on (c.currency_numeric_code = case when operational.isnumeric(a.&#34;currency code transaction&#34;) then a.&#34;currency code transaction&#34;::integer end) 
        left join operational.m_currency d on (d.currency_numeric_code = case when operational.isnumeric(a.&#34;currency code reconciliation&#34;) then a.&#34;currency code reconciliation&#34;::integer end) 
        &#34;&#34;&#34;
        str_column_dh = str_column_dh[:-1]
        insert_query = f&#39;insert into {table_scheme}.{table_name} ({str_column_dh}) &#39;
        select_query = select_query[:-1] + f&#39; from {table_scheme}.{table_name_stg}_{customer_code}_{type_file} a &#39;
        query = insert_query + select_query + left_query
        partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
        result_message = self.ps.insert(query,[(table_name)])

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        str(result_message),
        self.module
        )
        result_message = str(self.ps.table_count(table_scheme,f&#39;{table_name}_{customer_code}_{type_file}&#39;)) +&#39; &#39; + result_message + &#39; &#39; + table_name
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;MASTERCARD&#34;,
        self.log_name,
        &#34;ADAPTER OF MASTERCARD FILE&#34;,
        &#34;INFO&#34;,
        result_message,
        self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.update_column_table_from_adapter"><code class="name flex">
<span>def <span class="ident">update_column_table_from_adapter</span></span>(<span>self, adapter_column_base: list, adapter_table_scheme: str, adapter_table_name: str, table_scheme: str, table_name: str, type_record: str, column_type: bool = False, column_format: bool = False, column_partition: str = None, partition_type: str = None, adapter_where: str = None, adapter_order: str = None, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Update columns from the adapter</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>adapter_column_base</code></strong> :&ensp;<code>list</code></dt>
<dd>List of columns for adapter</dd>
<dt><strong><code>adapter_table_scheme</code></strong> :&ensp;<code>str</code></dt>
<dd>adapter schema for table</dd>
<dt><strong><code>adapter_table_name</code></strong> :&ensp;<code>str</code></dt>
<dd>adapter table name</dd>
<dt><strong><code>table_scheme</code></strong> :&ensp;<code>str</code></dt>
<dd>temporal table schema</dd>
<dt><strong><code>table_name</code></strong> :&ensp;<code>str</code></dt>
<dd>temporal table name</dd>
<dt><strong><code>type_record</code></strong> :&ensp;<code>str</code></dt>
<dd>type of record</dd>
<dt><strong><code>column_type</code></strong> :&ensp;<code>bool</code></dt>
<dd>column type indicator</dd>
<dt><strong><code>column_format</code></strong> :&ensp;<code>bool</code></dt>
<dd>column format indicator</dd>
<dt><strong><code>column_partition</code></strong> :&ensp;<code>str</code></dt>
<dd>column for partition</dd>
<dt><strong><code>partition_type</code></strong> :&ensp;<code>str</code></dt>
<dd>type of partition</dd>
<dt><strong><code>adapter_where</code></strong> :&ensp;<code>str</code></dt>
<dd>condition for adapter query </dd>
<dt><strong><code>adapter_order</code></strong> :&ensp;<code>str</code></dt>
<dd>column order by for adapter query</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>result_message (str): Message</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def update_column_table_from_adapter(self, adapter_column_base:list, adapter_table_scheme:str, adapter_table_name: str, table_scheme: str, table_name: str, type_record: str, column_type: bool = False, column_format: bool = False, column_partition: str = None, partition_type: str = None, adapter_where: str = None, adapter_order: str = None,log_name: str = None, client:str = None)-&gt;str:
    &#34;&#34;&#34;Update columns from the adapter
    
    Args:
        adapter_column_base (list): List of columns for adapter
        adapter_table_scheme (str): adapter schema for table
        adapter_table_name (str): adapter table name
        table_scheme (str): temporal table schema
        table_name (str): temporal table name
        type_record (str): type of record
        column_type (bool): column type indicator
        column_format (bool): column format indicator
        column_partition (str): column for partition
        partition_type (str): type of partition
        adapter_where (str): condition for adapter query 
        adapter_order (str): column order by for adapter query

    Returns:
        result_message (str): Message
    &#34;&#34;&#34;
    module = &#39;ADAPTER&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    adapter_columns_name = &#39;column_name, length, column_type&#39;
    list_table_y = []
    list_table_x = []
    if adapter_where==None:
        adapter_where=&#39;&#39;
    if adapter_order==None:
        adapter_order=&#39;&#39;
    if column_format:
        adapter_columns_name = &#34; replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(column_name,&#39;]&#39;,&#39;&#39;),&#39;[&#39;,&#39;&#39;),&#39;.&#39;,&#39;&#39;),&#39;&#39;&#39;&#39;,&#39;&#39;),&#39;)&#39;,&#39;&#39;),&#39;(&#39;,&#39;&#39;),&#39;/&#39;,&#39;&#39;),&#39;-&#39;,&#39;_&#39;),&#39; &#39;,&#39;_&#39;),&#39;___&#39;,&#39;_&#39;),&#39;__&#39;,&#39;_&#39;) as column_name,length,column_type,column_decimal&#34;
    list_table_y.extend(adapter_column_base)
    list_table_x = self.ps.get_structure_table_from_db(table_scheme,table_name)
    list_table_y.extend(self.ps.select(adapter_table,f&#34;where type_record = &#39;{type_record}&#39; {adapter_where} {adapter_order}&#34;,adapter_columns_name))
    df_x = pd.DataFrame(list_table_x)
    df_y = pd.DataFrame(list_table_y)
    if not self.ps.table_exists(table_scheme+&#39;.&#39;+table_name):
        self.ps.create_table(list_table_y,table_scheme+&#39;.&#39;+table_name,column_type,column_partition,partition_type)  

        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            &#34;table created : &#34;
            + table_scheme
            + &#34;.&#34;
            + table_name,
            self.module
        )

        return self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,type_record,column_format=column_format,adapter_where=adapter_where,adapter_order=adapter_order)
    if len(df_x) != len(df_y):
        list_table_difference = []
        for index, value in enumerate(df_y[&#39;column_name&#39;].values):
            if not value in (df_x[&#39;column_name&#39;].values):
                list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
        result_message = self.ps.add_column(list_table_difference,table_scheme,table_name)
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            self.customer_code,
            &#34;VISA AND MASTERCARD&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA and MASTERCARD FILE&#34;,
            &#34;INFO&#34;,
            result_message,
            self.module
        )
        if len(df_x)&lt;=len(df_y):
            return self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,type_record,column_format=column_format,adapter_where=adapter_where,adapter_order=adapter_order)
        result_message = f&#39;columns difference to table : {table_scheme}.{table_name}&#39;
    if len(df_x) == len(df_y):
        list_table_difference = []
        for index, value in enumerate(df_y[&#39;column_name&#39;].values):
            if value in (df_x[&#39;column_name&#39;].values):
                if str(df_x[df_x[&#39;column_name&#39;] == df_y[&#39;column_name&#39;][index]][&#39;data_type&#39;].values[0]).replace(&#39;character varyinresult_messageg&#39;,&#39;varchar&#39;) != df_y[&#39;column_type&#39;][index]:
                    list_table_difference.append({&#39;column_name&#39;: df_y[&#39;column_name&#39;][index], &#39;length&#39; : df_y[&#39;length&#39;][index], &#39;column_type&#39;: df_y[&#39;column_type&#39;][index]})
        result_message = f&#39;{len(list_table_difference)} columns difference to table : {table_scheme}.{table_name}&#39;
    return result_message</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_config_table_adapter_dh"><code class="name flex">
<span>def <span class="ident">visa_config_table_adapter_dh</span></span>(<span>self, string_start_date: str = None, string_end_date: str = None, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Configuration of the visa adapter table dh</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_start_date</code></strong> :&ensp;<code>str</code></dt>
<dd>starting date for range
</dd>
<dt><strong><code>string_end_date</code></strong> :&ensp;<code>str</code></dt>
<dd>ending date for range</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_config_table_adapter_dh(self, string_start_date : str = None, string_end_date : str = None,log_name: str = None, client:str = None) -&gt;str:
    &#34;&#34;&#34;Configuration of the visa adapter table dh
    
    Args:
       string_start_date (str): starting date for range  
       string_end_date (str): ending date for range

    Returns:
        str: Message
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_visa_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;date&#39;}]
    if string_start_date == None:
        string_start_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    if string_end_date == None:
        string_end_date = string_start_date
    customer_table = &#39;control.t_customer&#39;
    list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_start_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
    list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
    for value in list_type_record:
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction&#39;
        if value[&#39;type_record&#39;]!=&#39;transaction&#39;:
            table_name += &#39;_&#39;+value[&#39;type_record&#39;]
        result_message = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],True,True,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by type_record,tcr,position,column_name&#39;)
        customer_code = self.customer_code
        partition_name = table_name+&#39;_&#39;+customer_code
        message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)
    
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )
                 
        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
        
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )          
                        
        message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_in&#39;,table_scheme,partition_name+&#39;_in&#39;,string_start_date,string_end_date)
        
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )                        
        
        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;,&#39;app_processing_date&#39;,&#39;range&#39;)
        
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )                   
        
        message_partition = self.ps.create_table_partition_range(table_scheme,partition_name+&#39;_out&#39;,table_scheme,partition_name+&#39;_out&#39;,string_start_date,string_end_date)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )      
        message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_idx&#39;,&#39;app_id,app_hash_file&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        )
        message_index = self.ps.create_table_index(table_scheme,table_name,table_name+&#39;_date_idx&#39;,&#39;app_processing_date&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        )
        
    message_index = self.ps.create_table_index(table_scheme,&#39;dh_visa_transaction&#39;,&#39;dh_visa_transaction_account_number_idx&#39;,&#39;account_number&#39;)
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_index),
        self.module
        )          
    
    message_create_table_index = self.ps.create_table_index(table_scheme,&#39;dh_visa_transaction_sms&#39;,&#39;dh_visa_transaction_sms_card_number_idx&#39;,&#39;card_number&#39;)
    
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_create_table_index),
        self.module
        )        

    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_config_table_adapter_stg"><code class="name flex">
<span>def <span class="ident">visa_config_table_adapter_stg</span></span>(<span>self, string_date: str = None, log_name: str = None, client: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Configuration of the visa adapter table staging</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range
</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_config_table_adapter_stg(self, string_date : str = None,log_name: str = None, client:str = None) -&gt;str:
    &#34;&#34;&#34;Configuration of the visa adapter table staging
    
    Args:
       string_date (str): date for range  

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_visa_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    adapter_column_base = [{&#39;column_name&#39;: &#39;app_id&#39;,&#39;length&#39;: &#39;10&#39;, &#39;column_type&#39;: &#39;numeric&#39;},{&#39;column_name&#39;: &#39;app_customer_code&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_type_file&#39;,&#39;length&#39;: &#39;50&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_hash_file&#39;,&#39;length&#39;: &#39;300&#39;, &#39;column_type&#39;: &#39;text&#39;},{&#39;column_name&#39;: &#39;app_processing_date&#39;,&#39;length&#39;: &#39;30&#39;, &#39;column_type&#39;: &#39;text&#39;}]
    table_scheme = &#39;operational&#39;
    table_name_base = &#39;stg_adapter_visa_transaction&#39;
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    customer_table = &#39;control.t_customer&#39;
    list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
    list_customer = self.ps.select(customer_table,&#34;where status = &#39;ACTIVE&#39;&#34;,&#39;name, code&#39;)
    for value in list_type_record:
        table_name = table_name_base

        if value[&#39;type_record&#39;]!=&#39;transaction&#39;:
            table_name += &#39;_&#39;+value[&#39;type_record&#39;]             
        
        message_update = self.update_column_table_from_adapter(adapter_column_base,adapter_table_scheme,adapter_table_name,table_scheme,table_name,value[&#39;type_record&#39;],False,False,&#39;app_customer_code&#39;,&#39;list&#39;,adapter_order=&#39; order by type_record,tcr,position,column_name&#39;)
                     
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_update),
        self.module
        )                      
        
        customer_code = self.customer_code

        partition_name = table_name+&#39;_&#39;+customer_code
        message_partition = self.ps.create_table_partition_list(table_scheme,table_name,table_scheme,partition_name,f&#34;&#39;{customer_code}&#39;&#34;,&#39;app_type_file&#39;,&#39;list&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )      
        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_in&#39;,f&#34;&#39;IN&#39;&#34;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )      
        message_partition = self.ps.create_table_partition_list(table_scheme,partition_name,table_scheme,partition_name+&#39;_out&#39;,f&#34;&#39;OUT&#39;&#34;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(message_partition),
        self.module
        )      


    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_interchange_rule_assign"><code class="name flex">
<span>def <span class="ident">visa_interchange_rule_assign</span></span>(<span>self, table_schema_source: str, table_name_source: str, string_date: str) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Direct Assignment Exchange Rules</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>table_schema_source</code></strong> :&ensp;<code>str</code></dt>
<dd>schema of table source</dd>
<dt><strong><code>table_name_source</code></strong> :&ensp;<code>str</code></dt>
<dd>table source name</dd>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date filter</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>table_name_result (str): Table name as result</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
    &#34;&#34;&#34;Direct Assignment Exchange Rules
    
    Args:
        table_schema_source (str): schema of table source
        table_name_source (str): table source name
        string_date (str): date filter

    Returns:
        table_name_result (str): Table name as result 
    
    &#34;&#34;&#34;
    table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
    dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
    table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
    table_work = pd.DataFrame(self.ps.select(table))
    if table_work.empty:
        query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from from {table}&#39;
        message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  
        message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        return table_name_result
    table_work[&#39;rule&#39;] = 0
    table_work[&#39;id&#39;] = table_work.index + 1
    table_work[&#39;product_id&#39;] = table_work[&#39;product_id&#39;].str.strip()
    table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_visa r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and region_country_code in (select jurisdiction from {table} group by 1) order by region_country_code,intelica_id::numeric&#34;))
    table_rules[&#39;key&#39;] = table_rules.index + 1
    count_row=0
    count_condition = 0
    for rule in table_rules[&#39;key&#39;].values:
        table_test = pd.DataFrame()
        table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0)],how=&#39;right&#39;)
        for condition in table_rules.columns.values:
            if condition not in (&#39;processing_code_transaction_type&#39;,&#39;point_of_service_condition_code&#39;,&#39;app_id&#39;,&#39;intelica_id_original&#39;,&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;transaction_amount_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_program&#39;,&#39;intelica_id&#39;,&#39;fpi&#39;,&#39;fee_descriptor&#39;,&#39;fee_description&#39;,&#39;cod_hierarchy&#39;,&#39;program_default&#39;,&#39;fee_currency&#39;,&#39;fee_variable&#39;,&#39;fee_fixed&#39;,&#39;fee_min&#39;,&#39;fee_cap&#39;,&#39;acquiring_identifier&#39;,&#39;message_identifier&#39;,&#39;merchant_verification_value&#39;,&#39;validation_code&#39;,&#39;v_i_p_full_financial_message_sets&#39;,&#39;sender_data&#39;,&#39;additional_sender_data&#39;,&#39;settlement_service&#39;,&#39;other_criteria_applies&#39;):
                value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                    if len(table_test)&gt;0:
                        try:

                            if condition in (&#39;nnss_indicator&#39;,&#39;cardholder_id_method&#39;,&#39;moto_eci_indicator&#39;,&#39;acceptance_terminal_indicator&#39;,&#39;merchant_vat&#39;):
                                value_condition = value_condition.lower().replace(&#39;space&#39;,&#39; &#39;).upper()
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition.replace(&#39;NOT:&#39;,&#39;&#39;)
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[~table_test[condition].astype(str).isin(split_condition)]
                                else:
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[table_test[condition].astype(str).isin(split_condition)]
                                continue
                            if condition in (&#39;transaction_amount&#39;):
                                table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;transaction_amount_currency&#39;][count_row]).lower()}&#34;
                                table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                    query_condition = f&#34;{value_condition_currency} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                    table_test.query(query_condition,inplace=True)
                                elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                    split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                    table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                else:
                                    table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                continue
                            if condition in (&#39;surcharge_amount&#39;,&#39;timeliness&#39;):
                                table_test = table_test[table_test[condition] != &#39;BLANK&#39;]
                                table_test[condition] = pd.to_numeric(table_test[condition])
                                if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                    query_condition = f&#34;{condition} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                    table_test.query(query_condition,inplace=True)
                                elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                    split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                    table_test=table_test[table_test[condition].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                else:
                                    table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                continue
                            if condition in (&#39;merchant_category_code&#39;):
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                else:
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                continue
                            if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                split_condition = value_condition.split(&#39;,&#39;)
                                if len(split_condition)&lt;2:
                                    if value_condition.find(&#39;.&#39;)&gt;=0:
                                        if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                            value_condition = str(int(float(value_condition)))
                                    table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                else:
                                    table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                            else:
                                value_condition = value_condition.upper()
                                split_condition = value_condition.split(&#39;,&#39;)
                                if len(split_condition)&lt;2:
                                    if value_condition.find(&#39;.&#39;)&gt;=0:
                                        if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                            value_condition = str(int(float(value_condition)))
                                    table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                else:
                                    value_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                            if table_test.empty:
                                break
                        except ValueError as error:                   
                            log.logs().exist_file(
                            &#34;OPERATIONAL&#34;,
                            &#34;&#34;,
                            &#34;VISA&#34;,
                            self.log_name,
                            &#34;ADAPTER OF VISA FILE&#34;,
                            &#34;ERROR&#34;,
                            &#34;Error has occurred:&#34;+ str(error),
                            self.module
                            )  
        if len(table_test)&gt;0:
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;cod_hierarchy&#39;] = table_rules[&#39;cod_hierarchy&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
        count_row+=1
    if len(table_work)&gt;0:
        message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  
        table_work = table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;cod_hierarchy&#39;,&#39;valid_from&#39;]].applymap(str)
        table_work[&#34;intelica_id&#34;] = table_work[&#34;intelica_id&#34;].replace(&#34;nan&#34;,None)
        table_work[&#34;region_country_code&#34;] = table_work[&#34;region_country_code&#34;].replace(&#34;nan&#34;,None)
        aasa =  table_work.loc[table_work[&#34;region_country_code&#34;] == None] 
        print(aasa)
        self.ps.insert_from_df(table_work,table_schema_source.lower(),table_name_result)
        return table_name_result
    return &#39;-1&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">visa_load_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from visa</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_calculated_field_dh(self, string_date: str = None, type_file: str = None, hash_file:str = None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from visa
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message

    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_transaction_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)

    log.logs().exist_file(&#34;OPERATIONAL&#34;,self.customer_code,&#34;VISA&#34;,self.log_name,&#34;ADAPTER OF VISA FILE&#34;,&#34;INFO&#34;,f&#34;calculating field {table_scheme}.{table_name}&#34;,self.module)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    
    query_tmp = f&#34;&#34;&#34;
    with ardef_pre_1 as (
        select distinct 
        app_date_valid,
        rpad(left(trim(low_key_for_range),9),16,&#39;0&#39;)::BIGINT low_key_for_range,
        rpad(left(trim(table_key),9),16,&#39;9&#39;)::BIGINT high_key_for_range,
        ardef_country, a.account_funding_source,a.product_id,a.delete_indicator
        ,country issuer_country
        ,technology_indicator
        ,fast_funds
        ,travel_indicator
        ,b2b_program_id
        ,nnss_indicator
        ,product_subtype
        from operational.dh_visa_ardef a
        where app_date_valid&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
        --group by 1,2,3,4,5,6,7
    ), ardef_pre_r as (
        select a.* --app_date_valid,low_key_for_range,high_key_for_range,ardef_country,account_funding_source,product_id,
        ,row_number()over(partition by low_key_for_range order by app_date_valid desc,delete_indicator,high_key_for_range desc) rn
        from ardef_pre_1 a
    )
    select * from ardef_pre_r where rn=1
    &#34;&#34;&#34;
    
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_ardef_unique&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
    )
    ps_block.drop_table(table_tmp)

    create_message = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    create_message,
    self.module
    )  
    

    query_tmp = f&#34;&#34;&#34;
    select
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
    case 
        when right(t.authorization_code, 1) = &#39;x&#39; then &#39;INVALID&#39;
        when right(t.authorization_code, 5) in (&#39;     &#39;,&#39;00000&#39;,&#39;0000 &#39;,&#39;0000n&#39;,&#39;0000p&#39;,&#39;0000y&#39;) then &#39;INVALID&#39;
        else &#39;VALID&#39;
    end authorization_code_valid,
    case 
        when t.app_type_file = &#39;IN&#39; /*and t.transaction_code in (5,6,7,25,26,27)) or (t.app_type_file = &#39;OUT&#39; and t.transaction_code in (15,16,17,35,36,37))*/ then &#39;issuing&#39;
        when t.app_type_file = &#39;OUT&#39; /*and t.transaction_code in (5,6,7,25,26,27)) or (t.app_type_file = &#39;IN&#39; and t.transaction_code in (15,16,17,35,36,37))*/ then &#39;acquiring&#39;
        else t.app_type_file 
    end business_mode,
    case
            when a.ardef_country = trim(t.merchant_country_code) then 
                case
                    when t.app_type_file = &#39;IN&#39; then 
                        case 
                            when (string_to_array(left(t.account_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_6_digits,&#39;,&#39;) or string_to_array(left(t.account_number::text,8),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_8_digits,&#39;,&#39;)) and upper(t.collection_only_flag) = &#39;C&#39; then &#39;on-us&#39;
                            else &#39;off-us&#39;
                        end
                    when t.app_type_file = &#39;OUT&#39; then 
                        case
                            when string_to_array(left(t.account_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.acquiring_bins,&#39;,&#39;) and upper(t.collection_only_flag) = &#39;C&#39; then &#39;on-us&#39;
                            else &#39;off-us&#39;
                        end     
                end
            when a.ardef_country &lt;&gt; trim(t.merchant_country_code) and cra.visa_region_code = crt.visa_region_code then &#39;Intraregional&#39;
            when a.ardef_country &lt;&gt; trim(t.merchant_country_code) and cra.visa_region_code &lt;&gt; crt.visa_region_code then &#39;Interregional&#39;
    end jurisdiction, crt.country_code jurisdiction_country,r.region_code jurisdiction_region
    ,a.ardef_country
    ,t.merchant_country_code
    ,central_processing_date - t.purchase_date timeless
    ,a.account_funding_source funding_source, a.product_id
    ,row_number()over(partition by t.app_id,t.app_hash_file order by a.app_date_valid desc,a.high_key_for_range desc) n
    ,issuer_country
    ,technology_indicator
    ,fast_funds
    ,travel_indicator
    ,b2b_program_id
    ,nnss_indicator
    ,product_subtype
    from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_ardef_unique a
    on (t.account_number between low_key_for_range and high_key_for_range)
    left join operational.m_country crt
    on (crt.country_code = trim(t.merchant_country_code))
    left join operational.m_country cra
    on (cra.country_code = a.ardef_country)
    left join operational.m_region r
    on (r.region_code = crt.visa_region_code)
    left join control.t_customer c
    on (upper(c.code) = upper(&#39;{customer_code}&#39;))
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_calculated_field_pre&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    message_drop = self.ps.drop_table(table_tmp)
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
    )
    ps_block.drop_table(table_tmp)

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  
    query_tmp = f&#34;&#34;&#34;
    select 
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date
    ,t.destination_amount
    ,t.source_amount
    ,t.destination_currency_code
    ,t.source_currency_code
    ,t.transaction_code
    ,t.merchant_category_code
    ,t.special_condition_indicator_merchant_transaction_indicator
    ,t.transaction_code_qualifier_0
    ,t.usage_code
    ,ex_local.exchange_value exchange_value_local
    ,ex_settl.exchange_value exchange_value_settlement
    ,cus.local_currency_code
    from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
    left join control.t_customer cus on cus.code = t.app_customer_code
    left join operational.dh_exchange_rate ex_local on 
    (ex_local.app_processing_date = t.app_processing_date and  trim(ex_local.currency_to)=trim(cus.local_currency_code) and 
        ex_local.currency_from_code = case when t.destination_amount &gt; 0 then t.destination_currency_code
                else t.source_currency_code 
                end
    and ex_local.brand=&#39;VISA&#39;)
    left join operational.dh_exchange_rate ex_settl on 
    (ex_settl.app_processing_date = t.app_processing_date and  trim(ex_settl.currency_to)=trim(cus.settlement_currency_code) and 
        ex_settl.currency_from_code = case when t.destination_amount &gt; 0 then t.destination_currency_code
                else t.source_currency_code 
                end
    and ex_settl.brand=&#39;VISA&#39;)
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sfc_pre&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    message_drop = self.ps.drop_table(table_tmp)
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
    )
    ps_block.drop_table(table_tmp)  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
    case t.app_type_file
        when &#39;IN&#39; then
            case 
                when transaction_code in (&#39;05&#39;,&#39;15&#39;,&#39;25&#39;,&#39;35&#39;) then 
                    case         
                        when special_condition_indicator_merchant_transaction_indicator in (&#39;7&#39;,&#39;8&#39;) then 3
                        when special_condition_indicator_merchant_transaction_indicator not in (&#39;7&#39;,&#39;8&#39;) then 1
                        else 255
                    end
                when transaction_code in (&#39;07&#39;,&#39;17&#39;,&#39;27&#39;,&#39;37&#39;) then 
                    case 
                        when merchant_category_code in (6010) then 21 --MANUAL CASH
                        when merchant_category_code in (6011) then 22 -- ATM
                        else 255
                    end 
                when transaction_code in (&#39;06&#39;,&#39;16&#39;,&#39;26&#39;,&#39;36&#39;) then 
                    case
                        when special_condition_indicator_merchant_transaction_indicator is not null and special_condition_indicator_merchant_transaction_indicator not in (&#39;8&#39;) and transaction_code_qualifier_0 = 0 then 19
                        when special_condition_indicator_merchant_transaction_indicator is null and transaction_code_qualifier_0 = 0 then 20
                        when special_condition_indicator_merchant_transaction_indicator in (&#39;8&#39;) and transaction_code_qualifier_0 = 0 then 20
                        when special_condition_indicator_merchant_transaction_indicator is not null and special_condition_indicator_merchant_transaction_indicator not in (&#39;8&#39;) and transaction_code_qualifier_0 = 2 then 25
                        when special_condition_indicator_merchant_transaction_indicator is null and transaction_code_qualifier_0 = 2 then 25
                        when special_condition_indicator_merchant_transaction_indicator in (&#39;8&#39;) and transaction_code_qualifier_0 = 2 then 25
                        else 255
                    end
                else 255
            end
        when &#39;OUT&#39; then
            case 
                when transaction_code in (&#39;05&#39;,&#39;15&#39;,&#39;25&#39;,&#39;35&#39;) then 
                    case         
                        when merchant_category_code not in (4829, 6051, 7995) then 1 -- purchase 1
                        when merchant_category_code in (4829, 6051, 7995) then 3 -- quasi cash
                        else 255
                    end
                when transaction_code in (&#39;07&#39;,&#39;17&#39;,&#39;27&#39;,&#39;37&#39;) then 
                    case 
                        when merchant_category_code  in (6010) then 21 --MANUAL CASH
                        when merchant_category_code  in (6011) then 22 -- ATM
                        else 255
                    end 
                when transaction_code in (&#39;06&#39;,&#39;16&#39;,&#39;26&#39;,&#39;36&#39;) then 
                    case        
                        when merchant_category_code not in (4829, 6051, 7995) and transaction_code_qualifier_0 = 0 then 19
                        when merchant_category_code in (4829, 6051, 7995) and transaction_code_qualifier_0 = 0 then 20  -- purchase 1
                        when merchant_category_code not in (4829, 6051, 7995) and transaction_code_qualifier_0 &lt;&gt; 0 then 25  -- purchase 1
                        else 255
                    end
                else 255
            end
    end business_transaction_type
    ,case
        when transaction_code in(&#39;05&#39;,&#39;06&#39;,&#39;07&#39;) then 
            case
                when usage_code = 1 then 11
                when usage_code = 2 then 23
                when usage_code = 9 then 6
                else 255
            end
        when transaction_code in (&#39;15&#39;,&#39;16&#39;,&#39;17&#39;,&#39;35&#39;,&#39;36&#39;,&#39;37&#39;) then
            case
                when usage_code = 1 then 1
                when usage_code = 9 then 4
                else 255
            end
        when transaction_code in (&#39;25&#39;,&#39;26&#39;,&#39;27&#39;) then
            case
                when usage_code = 1 then 11 -- reversal must be 1
                when usage_code = 9 then 6  --reversal must be 1
                when usage_code = 2 then 25
                else 255
            end 
        else 255
    end business_transaction_cycle
    ,case when transaction_code::integer &gt;= 20 and transaction_code::integer&lt;30 and usage_code in (1,9) then 1 else 0
    end reversal_indicator
    ,case 
        when dhvtc.jurisdiction in (&#39;on-us&#39;,&#39;off-us&#39;) then 
            round(case 
                    when t.exchange_value_local is null then
                        case 
                            when t.destination_amount &gt; 0  and t.destination_currency_code = cast(cur.currency_numeric_code as varchar(4)) then t.destination_amount 
                            else 
                                case 
                                    when t.source_currency_code = cast(cur.currency_numeric_code as varchar(4)) then source_amount 
                                    else null
                                end
                        end
                    else
                        case 
                            when t.destination_amount &gt; 0 then t.destination_amount * t.exchange_value_local 
                            else source_amount * t.exchange_value_local 
                        end
                end::numeric,2)
        when dhvtc.jurisdiction not in (&#39;on-us&#39;,&#39;off-us&#39;) then 
            round(case
                    when t.exchange_value_settlement is null then
                        case 
                            when t.destination_amount &gt; 0  and t.destination_currency_code = cast(cur.currency_numeric_code as varchar(4)) then t.destination_amount 
                            else 
                                case 
                                    when t.source_currency_code = cast(cur.currency_numeric_code as varchar(4)) then source_amount 
                                    else null
                                end
                        end
                    else
                        case 
                            when t.destination_amount &gt; 0 then t.destination_amount * t.exchange_value_settlement 
                            else source_amount * t.exchange_value_settlement 
                        end
                end::numeric,2)
    end settlement_report_amount
    ,t.local_currency_code settlement_report_currency_code
    from {table_tmp} t
    inner join temporal.{customer_code}_{type_file}_visa_calculated_field_pre dhvtc 
    on (dhvtc.app_id = t.app_id and dhvtc.app_hash_file = t.app_hash_file)
    left join operational.m_currency cur on cur.currency_alphabetic_code = t.local_currency_code
    where dhvtc.n = 1
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sfc_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    message_drop = self.ps.drop_table(table_tmp)
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
    )
    ps_block.drop_table(table_tmp)  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  
    query_tmp = f&#34;&#34;&#34;
    select
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
    tp.authorization_code_valid,tp.business_mode,lower(tp.jurisdiction) jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.timeless,tp.funding_source,tp.product_id
    ,tp.ardef_country
    ,tp1.reversal_indicator
    ,tp1.business_transaction_type
    ,tp1.business_transaction_cycle
    ,case lower(tp.jurisdiction) when &#39;intraregional&#39; then tp.jurisdiction_region::text
        when &#39;interregional&#39; then &#39;9&#39;
        else tp.jurisdiction_country::text
    end jurisdiction_assigned
    ,tp.issuer_country
    ,tp.technology_indicator
    ,tp.fast_funds
    ,tp.travel_indicator
    ,tp.b2b_program_id
    ,tp.nnss_indicator
    ,tp.product_subtype
    ,tp1.settlement_report_amount
    ,tp1.settlement_report_currency_code
    from operational.dh_visa_transaction_{customer_code}_{type_file}_{string_date} t
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_calculated_field_pre tp
    on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sfc_field tp1
    on (t.app_id = tp1.app_id and t.app_hash_file = tp1.app_hash_file)
    where tp.n = 1
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    message_drop = self.ps.drop_table(table_tmp)
    log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
    )
    ps_block.drop_table(table_tmp)  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )
    print(f&#34;Debug is {self.debug}&#34;)
    if self.debug == &#39;False&#39;:
        
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_sms_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">visa_load_sms_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from visa sms</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_sms_calculated_field_dh(self, string_date: str = None,type_file: str = None,hash_file: str = None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from visa sms
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_transaction_sms_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading sms calculated field dh&#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )   

    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    
    query_tmp = f&#34;&#34;&#34;
    with ardef_pre_1 as (
        select distinct 
        app_date_valid,
        rpad(left(trim(low_key_for_range),9),19,&#39;0&#39;)::numeric low_key_for_range,
        rpad(left(trim(table_key),9),19,&#39;9&#39;)::numeric high_key_for_range,
        ardef_country, a.account_funding_source,a.product_id,a.delete_indicator
        ,country issuer_country
        ,technology_indicator
        ,fast_funds
        ,travel_indicator
        ,b2b_program_id
        ,nnss_indicator
        ,product_subtype
        from operational.dh_visa_ardef a
        where app_date_valid&lt;=to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;)
        --group by 1,2,3,4,5,6,7
    ), ardef_pre_r as (
        select a.* --app_date_valid,low_key_for_range,high_key_for_range,ardef_country,account_funding_source,product_id,
        ,row_number()over(partition by low_key_for_range order by app_date_valid desc,delete_indicator,high_key_for_range desc) rn
        from ardef_pre_1 a
    )
    select * from ardef_pre_r where rn=1
    &#34;&#34;&#34;
    
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_ardef_unique&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;

    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    query_tmp = f&#34;&#34;&#34;
    select
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,t.request_message_type
    ,case 
        when response_code = &#39;00&#39; and settlement_amount &lt;&gt; 0 then --Transaccion aceptada y procesada, excepto autorizacion, etc.
            case 
                when left(processing_code,2) in (&#39;00&#39;,&#39;20&#39;,&#39;26&#39;,&#39;11&#39;) then --Purchase / Credit Voucher
                    case 
                        when request_message_type in (&#39;0420&#39;) then 1 
                        else 0
                    end 
                when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;,&#39;10&#39;) then --Cash / Adjustment
                    case 
                        when request_message_type in (&#39;0420&#39;) then 1 
                        else 0
                    end
            end
    END as reversal_indicator,
    case 
        when response_code = &#39;00&#39; and settlement_amount &lt;&gt; 0 then --Transaccion aceptada y procesada, excepto autorizacion, etc.
            case 
                when left(processing_code,2) in (&#39;00&#39;) then 1 --Purchase
                when left(processing_code,2) in (&#39;20&#39;) then 19 --Credit Voucher
                when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;) then 22 --Cash / Adjustment
                --when left(processing_code,2) in (&#39;30&#39;) then 247 --Balance Inquiry
                when left(processing_code,2) in (&#39;10&#39;) then 30 -- Account Funding
                when left(processing_code,2) in (&#39;11&#39;) then 3 -- Quasi-cash
                when left(processing_code,2) in (&#39;19&#39;) then 115 -- Fee Collection
                when left(processing_code,2) in (&#39;26&#39;) then 25  -- Original Credit
                when left(processing_code,2) in (&#39;29&#39;) then 200 -- Funds Disbursement
                when left(processing_code,2) in (&#39;40&#39;) then 250 -- CardHolder Account Transfer
                when left(processing_code,2) in (&#39;50&#39;) then 27  -- Payment / Bill Payment (US ONLY)    
            end
        when response_code = &#39;00&#39; and settlement_amount = 0 then
            case 
                when left(processing_code,2) in (&#39;30&#39;) then 247 
            end
        when response_code &lt;&gt; &#39;00&#39; and settlement_amount = 0 then
            case 
                when left(processing_code,2) in (&#39;00&#39;) then 236 --Purchase
                when left(processing_code,2) in (&#39;01&#39;,&#39;02&#39;,&#39;22&#39;,&#39;30&#39;) then 249 --Cash / Adjustment
            end
    end as business_transaction_type
    ,case 
        when response_code IN (&#39;00&#39;) AND settlement_amount &lt;&gt; 0 then 
            case 
                when request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;01&#39;) THEN 4 -- Cash Dispute
                WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;01&#39;) THEN 6 -- Cash Dispute Response
                WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;02&#39;) THEN 4 -- Debit Adjustment Dispute
                WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;02&#39;) THEN 7 -- Debit Adjustment
                WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;22&#39;) THEN 4 -- Credit Adjustment Dispute
                WHEN request_message_type IN (&#39;0220&#39;) AND LEFT(processing_code,2) IN (&#39;22&#39;) THEN 5 -- Credit Adjustment                                 
                WHEN request_message_type IN (&#39;0422&#39;) AND LEFT(processing_code,2) IN (&#39;00&#39;,&#39;20&#39;) THEN 4 -- Dispute / Response for Purchase and Credit Voucher
                WHEN request_message_type IN (&#39;0200&#39;,&#39;0220&#39;,&#39;0400&#39;,&#39;0420&#39;)  THEN 11 -- Original 
            end
        WHEN response_code NOT IN (&#39;00&#39;) AND settlement_amount = 0 THEN 100  -- Transacciones sin ciclo 
    end as business_transaction_cycle
    ,case 
        when right(t.authorization_id_resp_code, 1) = &#39;x&#39; then &#39;invalid&#39;
        when right(t.authorization_id_resp_code, 5) in (&#39;     &#39;,&#39;00000&#39;,&#39;0000 &#39;,&#39;0000n&#39;,&#39;0000p&#39;,&#39;0000y&#39;) then &#39;invalid&#39;
        else &#39;valid&#39;
    end authorization_code_valid,
    case upper(t.issuer_acquirer_indicator)
        when &#39;A&#39; then &#39;acquiring&#39;
        when &#39;I&#39; then &#39;issuing&#39;
    end business_mode,
    case
            when a.ardef_country = trim(t.card_acceptor_country) then 
                case upper(t.issuer_acquirer_indicator)
                    when &#39;A&#39; then
                        case
                            when string_to_array(left(t.card_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.acquiring_bins,&#39;,&#39;) then &#39;on-us&#39;
                            else &#39;off-us&#39;
                        end
                    when &#39;I&#39; then 
                        case 
                            when (string_to_array(left(t.card_number::text,6),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_6_digits,&#39;,&#39;) or string_to_array(left(t.card_number::text,8),&#39;,&#39;) &lt;@ string_to_array(c.issuing_bins_8_digits,&#39;,&#39;)) then &#39;on-us&#39;
                            else &#39;off-us&#39;
                        end
                end
            when a.ardef_country &lt;&gt; trim(t.card_acceptor_country) and cra.visa_region_code = crt.visa_region_code then &#39;Intraregional&#39;
            when a.ardef_country &lt;&gt; trim(t.card_acceptor_country) and cra.visa_region_code &lt;&gt; crt.visa_region_code then &#39;Interregional&#39;
    end jurisdiction, crt.country_code jurisdiction_country,r.region_code jurisdiction_region
    ,a.ardef_country
    ,t.card_acceptor_country
    ,vss_processing_date - t.local_transaction_date timeless
    ,a.account_funding_source funding_source, a.product_id
    ,row_number()over(partition by t.app_id,t.app_hash_file order by a.app_date_valid desc,a.high_key_for_range desc) n
    ,issuer_country
    ,technology_indicator
    ,fast_funds
    ,travel_indicator
    ,b2b_program_id
    ,nnss_indicator
    ,product_subtype
    from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sms_ardef_unique a
    on (t.card_number between low_key_for_range and high_key_for_range)
    left join operational.m_country crt
    on (crt.country_code = trim(t.card_acceptor_country))
    left join operational.m_country cra
    on (cra.country_code = a.ardef_country)
    left join operational.m_region r
    on (r.region_code = crt.visa_region_code)
    left join control.t_customer c
    on (upper(c.code) = upper(&#39;{customer_code}&#39;))
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field_pre&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create= self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select
    t.*
    ,case 
        when request_message_type in (&#39;0200&#39;, &#39;0220&#39;, &#39;0420&#39;) and (business_transaction_cycle not in (4,6) or business_transaction_cycle is null) 
            then case 
                    when reversal_indicator = 0
                        then case 
                                when business_transaction_type in (1,3) then &#39;05&#39;
                                when business_transaction_type in (19,25) then &#39;06&#39;
                                when business_transaction_type in (22,30) then &#39;07&#39;
                            end
                    when reversal_indicator = 1
                        then case  
                                when business_transaction_type in (1,3) then &#39;25&#39;
                                when business_transaction_type in (19,25) then &#39;26&#39;
                                when business_transaction_type in (22,30) then &#39;27&#39;
                            end
                end
    end transaction_code_sms
    from {table_tmp} t
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field_pre_2&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create= self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA SMS file&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    select
    t.app_id,t.app_customer_code,t.app_type_file,t.app_hash_file,t.app_processing_date,
    tp.authorization_code_valid,tp.business_mode,lower(tp.jurisdiction) jurisdiction,tp.jurisdiction_country,tp.jurisdiction_region,tp.timeless,tp.funding_source,tp.product_id
    ,tp.ardef_country
    ,tp.reversal_indicator
    ,tp.business_transaction_type
    ,tp.business_transaction_cycle
    ,tp.transaction_code_sms
    ,case lower(tp.jurisdiction) when &#39;intraregional&#39; then tp.jurisdiction_region::text
        when &#39;interregional&#39; then &#39;9&#39;
        else tp.jurisdiction_country::text
    end jurisdiction_assigned
    ,tp.issuer_country
    ,tp.technology_indicator
    ,tp.fast_funds
    ,tp.travel_indicator
    ,tp.b2b_program_id
    ,tp.nnss_indicator
    ,tp.product_subtype
    from operational.dh_visa_transaction_sms_{customer_code}_{type_file}_{string_date} t
    inner join {table_scheme_tmp}.{customer_code}_{type_file}_visa_sms_calculated_field_pre_2 tp
    on (t.app_id = tp.app_id and t.app_hash_file = tp.app_hash_file)
    where tp.n = 1
    &#34;&#34;&#34;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_sms_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )
    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_transaction"><code class="name flex">
<span>def <span class="ident">visa_load_transaction</span></span>(<span>self, string_date: str = None, type_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Load of visa transaction</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_transaction(self, string_date: str = None,type_file: str = None)-&gt;str:
    &#34;&#34;&#34;Load of visa transaction
    
    Args:
        string_date (str): date for range condition  

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    adapter_table_scheme = &#39;control&#39;
    adapter_table_name = &#39;t_visa_adapter&#39;
    adapter_table = adapter_table_scheme+&#39;.&#39;+adapter_table_name
    customer_code = self.customer_code
    module = &#39;ADAPTER&#39;
    hash_file = &#39;45b9c08a79b0a9ffc3803433b6cf241b86acb2aa94c78f51fe7147ed18a1423b&#39;
    number_file = &#39;1&#39;
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading transactions type file : &#34;+ type_file,
    self.module
    )   
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)
    list_type_record = self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;,&#39;distinct type_record&#39;)
    df_adapter = pd.DataFrame(self.ps.select(adapter_table,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between start_date and coalesce(end_date,current_date)&#34;))
    for value in df_adapter[&#39;type_record&#39;].drop_duplicates().values:
        table_scheme = &#39;operational&#39;
        table_name = &#39;dh_visa_transaction&#39;
        table_name_stg = &#39;stg_adapter_visa_transaction&#39;
        if value!=&#39;transaction&#39;:
            table_name += &#39;_&#39;+value
            table_name_stg += &#39;_&#39;+value
        df_structure_dh = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name,&#39;order by column_name&#39;))
        df_structure_stg = pd.DataFrame(self.ps.get_structure_table_from_db(table_scheme,table_name_stg,&#39;order by column_name&#39;))
        select_query = &#39;select &#39;
        left_query = &#39;&#39;
        str_column_dh = &#39;&#39;
        for column in df_structure_stg[&#39;column_name&#39;].values:
            if column in (&#39;app_creation_user&#39;,&#39;app_creation_date&#39;):
                continue
            str_column_format = column.replace(&#39;]&#39;,&#39;&#39;).replace(&#39;[&#39;,&#39;&#39;).replace(&#39;.&#39;,&#39;&#39;).replace(&#34;&#39;&#34;,&#39;&#39;).replace(&#39;)&#39;,&#39;&#39;).replace(&#39;(&#39;,&#39;&#39;).replace(&#39;/&#39;,&#39;&#39;).replace(&#39;-&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;_&#39;).replace(&#39;___&#39;,&#39;_&#39;).replace(&#39;__&#39;,&#39;_&#39;) + &#39;,&#39;
            str_column_dh += str_column_format
            column = f&#39;&#34;{column}&#34;&#39;
            if column == &#39;&#34;app_id&#34;&#39;:
                column =&#39;a.app_id::numeric&#39;
            elif column in (&#39;&#34;app_customer_code&#34;&#39;,&#39;&#34;app_type_file&#34;&#39;,&#39;&#34;app_hash_file&#34;&#39;,&#39;&#34;app_creation_user&#34;&#39;,&#39;&#34;app_creation_date&#34;&#39;):
                column = &#39;a.&#39;+column.replace(&#39;&#34;&#39;,&#39;&#39;)
            elif column == &#39;&#34;app_processing_date&#34;&#39;:
                column = f&#34;to_date(app_processing_date,&#39;yyyy-mm-dd&#39;)&#34;
            elif column == &#39;&#34;account number&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
            elif column == &#39;&#34;account number extension&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
            elif column == &#39;&#34;account reference number date&#34;&#39;:
                column = f&#34;&#34;&#34;
                case 
                    when {column} is not null then 
                        case 
                            when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                            else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                        end
                end
                &#34;&#34;&#34;
            elif column == &#39;&#34;purchase date&#34;&#39;:
                column = f&#34;&#34;&#34;
                case 
                    when {column} &lt;&gt; &#39;0000&#39; then 
                        case 
                            when left({column},2)::integer&lt;=substr(app_processing_date,6,2)::integer then to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)
                            else to_date((left(app_processing_date,4)::integer - 1)::varchar||{column},&#39;yyyymmdd&#39;)
                        end
                end
                &#34;&#34;&#34;
            elif column == &#39;&#34;destination amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
            elif column == &#39;&#34;source amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
            elif column == &#39;&#34;central processing date&#34;&#39;:
                column = f&#34;to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)&#34;
            elif column == &#39;&#34;national reimbursement fee&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;{column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]})&#34;
            elif column == &#39;&#34;conversion date&#34;&#39;:
                column = f&#34;&#34;&#34;
                case 
                    when {column} &lt;&gt; &#39;0000&#39; then 
                        case 
                            when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                            else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                        end
                end
                &#34;&#34;&#34;
            elif column == &#39;&#34;merchant country code&#34;&#39;:
                column = f&#34;trim({column})&#34;
            elif column == &#39;&#34;surcharge amount sp&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;surcharge amount sd&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;surcharge amount in cardholder billing currency sp&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;surcharge amount in cardholder billing currency sd&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;surcharge amount df&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;money transfer foreign exchange fee&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;authorized amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;total authorized amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;interchange fee amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;source currency to base currency exchange rate&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;base currency to destination currency exchange rate&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;optional issuer isa amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;local tax&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;national tax&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;other tax&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;settlement date&#34;&#39;:
                column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
            elif column == &#39;&#34;report date 140&#34;&#39;:
                column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
            elif column == &#39;&#34;report date 110&#34;&#39;:
                column = f&#34;to_date(right({column},5),&#39;yyddd&#39;)&#34;
            elif column == &#39;&#34;credit amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;debit amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;interchange amount (settlement currency) 140&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;interchange amount (settlement currency) 130&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;clearing amount (clearing currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;interchange value credits (settlement currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;visa charges credits (settlement currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;reimbursement fee credits (settlement currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;visa charges debits (settlement currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;reimbursement fee debits (settlement currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;interchange value debits (settlement currency)&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^c.currency_decimal_separator) end&#34;
            elif column == &#39;&#34;processing date header&#34;&#39;:
                column = f&#34;to_date({column},&#39;yyddd&#39;)&#34;
            elif column == &#39;&#34;processing date&#34;&#39;:
                column = f&#34;case when {column} &lt;&gt;&#39;00000&#39; then to_date({column},&#39;yyddd&#39;) end&#34;
            elif column == &#39;&#34;destination amount trailer&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;source amount trailer&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;rate table date&#34;&#39;:
                column = f&#34;&#34;&#34;
                case 
                    when {column} is not null then 
                        case 
                            when right({column},3)::integer&lt;=right(to_char(to_date(app_processing_date,&#39;yyyy-mm-dd&#39;),&#39;yyyyddd&#39;),3)::integer then to_date(left(app_processing_date,4)||right({column},3),&#39;yyyyddd&#39;)
                            else to_date((left(app_processing_date,4)::integer - 1)::varchar||right({column},3),&#39;yyyyddd&#39;)
                        end
                end
                &#34;&#34;&#34;
            elif column == &#39;&#34;local transaction date&#34;&#39;:
                column = f&#34;&#34;&#34;
                case 
                    when {column} is not null then 
                        case 
                            when left({column},2)::integer&lt;=substr(app_processing_date,6,2)::integer then to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)
                            else to_date((left(app_processing_date,4)::integer - 1)::varchar||{column},&#39;yyyymmdd&#39;)
                        end
                end
                &#34;&#34;&#34;
            elif column == &#39;&#34;online settlement date&#34;&#39;:
                column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
            elif column == &#39;&#34;plus settlement date&#34;&#39;:
                column = f&#34;to_date({column},&#39;mmddyy&#39;)&#34;
            elif column == &#39;&#34;reimbursement fee&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;transaction amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;filed 54 - original amount - clearing currency&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;transmission date&#34;&#39;:
                column = f&#34;to_date(left(app_processing_date,4)||{column},&#39;yyyymmdd&#39;)&#34;
            elif column == &#39;&#34;settlement amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;transaction integrity fee&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column = f&#34;case when operational.isnumeric({column}) then {column}::numeric/(10^{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]}) end&#34;
            elif column == &#39;&#34;surcharge amount sms&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;terminal transaction date&#34;&#39;:
                column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
            elif column == &#39;&#34;settlement date sms&#34;&#39;:
                column = f&#34;to_date({column},&#39;mmddyy&#39;)&#34;
            elif column == &#39;&#34;cardholder billing amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;vss processing date&#34;&#39;:
                column = f&#34;to_date({column},&#39;yymmdd&#39;)&#34;
            elif column == &#39;&#34;cryptogram amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;pre-currency conversion amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;cardholder bililng other amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;cryptogram cashback amount&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;optional issuer fee - settlement currency&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;optional issuer fee - cardholder billing currency&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;optional issuer isa amount in settlement currency&#34;&#39;:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                column_decimal = df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_decimal&#39;].values[0]
                column = f&#34;case when operational.isnumeric(operational.eval_amount({column})) then operational.eval_amount({column})::numeric/(10^{column_decimal}) end&#34;
            elif column == &#39;&#34;card number&#34;&#39;:
                column = f&#34;replace({column},&#39;*&#39;,&#39;0&#39;)::numeric&#34;
            else:
                column_str = column.replace(&#39;&#34;&#39;,&#39;&#39;)
                if df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0] in [&#39;numeric&#39;,&#39;integer&#39;,&#39;bigint&#39;]:
                    column = f&#34;case when operational.isnumeric({column}) then {column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]} end&#34;
                else:
                    column = f&#34;{column}::{df_adapter[(df_adapter[&#39;type_record&#39;] == value) &amp; (df_adapter[&#39;column_name&#39;] == column_str)][&#39;column_type&#39;].values[0]}&#34;
            select_query += f&#39; {column},&#39;
        if value in [&#39;vss_110&#39;,&#39;vss_120&#39;,&#39;vss_130&#39;,&#39;vss_140&#39;]:
            vss_report_code = value[-3:]
            left_query = f&#39;left join operational.m_currency c on (c.currency_numeric_code = case when operational.isnumeric(a.&#34;settlement currency code {vss_report_code}&#34;) then a.&#34;settlement currency code {vss_report_code}&#34;::integer end)&#39;
        
        str_column_dh = str_column_dh[:-1]
        insert_query = f&#39;insert into {table_scheme}.{table_name} ({str_column_dh}) &#39;
        select_query = select_query[:-1] + f&#39; from {table_scheme}.{table_name_stg}_{customer_code}_{type_file} a &#39;
        query = insert_query + select_query + left_query
        partition = f&#34;{table_name}_{customer_code}_{type_file}&#34;
        result_message = self.ps.insert(query,[(table_name)])

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        str(result_message),
        self.module
        ) 
        result_message = str(self.ps.table_count(table_scheme,f&#39;{table_name}_{customer_code}_{type_file}&#39;)) +&#39; &#39; + result_message + &#39; &#39; + table_name
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        self.customer_code,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA FILE&#34;,
        &#34;INFO&#34;,
        result_message,
        self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_110_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">visa_load_vss_110_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from visa vss 110</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_vss_110_calculated_field_dh(self, string_date: str = None,type_file:str = None, hash_file:str = None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from visa vss 110
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)


    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading vss 110 calculated field dh into &#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )   

    query_tmp = f&#34;&#34;&#34;
    with rollup_group as (
    select rollup_to_sre_identifier_110 rollup_group
    from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date}
    where rollup_to_sre_identifier_110 &lt;&gt; reporting_for_sre_identifier_110
    group by 1
    ), rollup_1 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
        from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_110 &lt;&gt; reporting_for_sre_identifier_110
    ), rollup_2 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
        from rollup_1
    ), rollup_3 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_110 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_110, reporting_for_sre_identifier_110
        from rollup_2
    )
    select  
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,110 report_type
    ,case 
        when a.rollup_to_sre_identifier_110 = a.reporting_for_sre_identifier_110 then 10
        when b.reporting_indicator is not null then b.reporting_indicator
        when c.reporting_indicator is not null then c.reporting_indicator
        when d.reporting_indicator is not null then d.reporting_indicator
        else 0
    end aggregation_level
    from operational.dh_visa_transaction_vss_110_{customer_code}_{type_file}_{string_date} a
    left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
    left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
    left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_110_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  


    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )

    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_120_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">visa_load_vss_120_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from visa vss 120</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_vss_120_calculated_field_dh(self, string_date: str = None,type_file:str = None,hash_file:str = None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from visa vss 120
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    customer_code = self.customer_code
    number_file = &#39;1&#39;
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading vss 120 calculated field dh into &#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )


    query_tmp = f&#34;&#34;&#34;
    with rollup_group as (
    select rollup_to_sre_identifier_120 rollup_group
    from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date}
    where rollup_to_sre_identifier_120 &lt;&gt; reporting_for_sre_identifier_120
    group by 1
    ), rollup_1 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
        from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_120 &lt;&gt; reporting_for_sre_identifier_120
    ), rollup_2 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
        from rollup_1
    ), rollup_3 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_120 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_120, reporting_for_sre_identifier_120
        from rollup_2
    )
    select  
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,120 report_type
    ,case 
        when a.rollup_to_sre_identifier_120 = a.reporting_for_sre_identifier_120 then 10
        when b.reporting_indicator is not null then b.reporting_indicator
        when c.reporting_indicator is not null then c.reporting_indicator
        when d.reporting_indicator is not null then d.reporting_indicator
        else 0
    end aggregation_level
    from operational.dh_visa_transaction_vss_120_{customer_code}_{type_file}_{string_date} a
    left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
    left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
    left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_120_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    
    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )

    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_130_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">visa_load_vss_130_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from visa vss 130</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_vss_130_calculated_field_dh(self, string_date: str = None,type_file:str = None,hash_file:str=None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from visa vss 130
    
    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    number_file = &#39;1&#39;
    customer_code = self.customer_code
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading vss 130 calculated field dh into &#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )

    query_tmp = f&#34;&#34;&#34;
    with rollup_group as (
    select rollup_to_sre_identifier_130 rollup_group
    from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date}
    where rollup_to_sre_identifier_130 &lt;&gt; reporting_for_sre_identifier_130
    group by 1
    ), rollup_1 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
        from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_130 &lt;&gt; reporting_for_sre_identifier_130
    ), rollup_2 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
        from rollup_1
    ), rollup_3 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_130 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_130, reporting_for_sre_identifier_130
        from rollup_2
    )
    select  
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,130 report_type
    ,case 
        when a.rollup_to_sre_identifier_130 = a.reporting_for_sre_identifier_130 then 10
        when b.reporting_indicator is not null then b.reporting_indicator
        when c.reporting_indicator is not null then c.reporting_indicator
        when d.reporting_indicator is not null then d.reporting_indicator
        else 0
    end aggregation_level
    from operational.dh_visa_transaction_vss_130_{customer_code}_{type_file}_{string_date} a
    left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
    left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
    left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_130_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    )  

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  
    
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )

    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_140_calculated_field_dh"><code class="name flex">
<span>def <span class="ident">visa_load_vss_140_calculated_field_dh</span></span>(<span>self, string_date: str = None, type_file: str = None, hash_file: str = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Loading calculated fields from visa vss 140</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date for range condition
</dd>
<dt><strong><code>type_file</code></strong> :&ensp;<code>str</code></dt>
<dd>type of file</dd>
<dt><strong><code>hash_file</code></strong> :&ensp;<code>str</code></dt>
<dd>hash code of file</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_load_vss_140_calculated_field_dh(self, string_date: str = None,type_file:str=None,hash_file:str=None)-&gt;str:
    &#34;&#34;&#34;Loading calculated fields from visa vss 140

    Args:
        string_date (str): date for range condition  
        type_file (str): type of file
        hash_file (str): hash code of file

    Returns:
        str: Message
    
    &#34;&#34;&#34;
    table_scheme = &#39;operational&#39;
    table_name = &#39;dh_visa_transaction_vss_calculated_field&#39;
    adapter_table = table_scheme+&#39;.&#39;+table_name
    number_file = &#39;1&#39;
    customer_code = self.customer_code
    module = &#39;ADAPTER&#39;
    ps_block = con.connect_to_postgreSQL(bool_query=True)
    if string_date == None:
        string_date = datetime.now().strftime(&#39;%Y%m%d&#39;)


    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    &#34;loading vss 140 calculated field dh into &#34;
    + table_scheme
    + &#34;.&#34;
    + table_name,
    self.module
    )


    query_tmp = f&#34;&#34;&#34;
    with rollup_group as (
    select rollup_to_sre_identifier_140 rollup_group
    from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date}
    where rollup_to_sre_identifier_140 &lt;&gt; reporting_for_sre_identifier_140
    group by 1
    ), rollup_1 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
        from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date}
        where rollup_to_sre_identifier_140 &lt;&gt; reporting_for_sre_identifier_140
    ), rollup_2 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
        from rollup_1
    ), rollup_3 as (
        select app_id,app_hash_file,case when reporting_for_sre_identifier_140 in (select rollup_group from rollup_group) then 1 else 0 end reporting_indicator, rollup_to_sre_identifier_140, reporting_for_sre_identifier_140
        from rollup_2
    )
    select  
    a.app_id,a.app_customer_code,a.app_type_file,a.app_hash_file,a.app_processing_date
    ,140 report_type
    ,case 
        when a.rollup_to_sre_identifier_140 = a.reporting_for_sre_identifier_140 then 10
        when b.reporting_indicator is not null then b.reporting_indicator
        when c.reporting_indicator is not null then c.reporting_indicator
        when d.reporting_indicator is not null then d.reporting_indicator
        else 0
    end aggregation_level
    from operational.dh_visa_transaction_vss_140_{customer_code}_{type_file}_{string_date} a
    left join rollup_1 b on (a.app_id = b.app_id and a.app_hash_file = b.app_hash_file)
    left join rollup_2 c on (a.app_id = c.app_id and a.app_hash_file = c.app_hash_file)
    left join rollup_3 d on (a.app_id = d.app_id and a.app_hash_file = d.app_hash_file)
    &#34;&#34;&#34;
    table_scheme_tmp = &#39;temporal&#39;
    table_name_tmp = f&#39;{customer_code}_{type_file}_visa_vss_140_calculated_field&#39;
    table_tmp = f&#39;{table_scheme_tmp}.{table_name_tmp}&#39;
    
    message_drop = self.ps.drop_table(table_tmp)
    ps_block.drop_table(table_tmp)

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_drop,
    self.module
    ) 

    message_create = self.ps.create_table_from_select(query_tmp,table_tmp)
    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    message_create,
    self.module
    )  

    log.logs().exist_file(
    &#34;OPERATIONAL&#34;,
    self.customer_code,
    &#34;VISA&#34;,
    self.log_name,
    &#34;ADAPTER OF VISA FILE&#34;,
    &#34;INFO&#34;,
    self.ps.insert_from_table(table_scheme_tmp, table_name_tmp,table_scheme, table_name),
    self.module
    )
    if self.debug == &#39;False&#39;:
        bulk_delete = ps_block.query_block()
        log.logs().exist_file(
            &#34;OPERATIONAL&#34;,
            customer_code,
            &#34;VISA&#34;,
            self.log_name,
            &#34;ADAPTER OF VISA FILE&#34;,
            &#34;INFO&#34;,
            bulk_delete,
            self.module
        )
    return &#39;finished&#39;</code></pre>
</details>
</dd>
<dt id="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_sms_interchange_rule_assign"><code class="name flex">
<span>def <span class="ident">visa_sms_interchange_rule_assign</span></span>(<span>self, table_schema_source: str, table_name_source: str, string_date: str) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Direct Assignment Exchange Rules</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>table_schema_source</code></strong> :&ensp;<code>str</code></dt>
<dd>schema of table source</dd>
<dt><strong><code>table_name_source</code></strong> :&ensp;<code>str</code></dt>
<dd>table source name</dd>
<dt><strong><code>string_date</code></strong> :&ensp;<code>str</code></dt>
<dd>date filter</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>table_name_result (str): Table name as result</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visa_sms_interchange_rule_assign(self, table_schema_source:str,table_name_source:str,string_date:str)-&gt;str:
    &#34;&#34;&#34;Direct Assignment Exchange Rules
    
    Args:
        table_schema_source (str): schema of table source
        table_name_source (str): table source name
        string_date (str): date filter

    Returns:
        table_name_result (str): Table name as result
    
    &#34;&#34;&#34;
    table = f&#39;{table_schema_source.lower()}.{table_name_source.lower()}&#39;
    dict_table = {&#39;app_id&#39;:sqlalchemy.Numeric}
    table_name_result = f&#39;{table_name_source.lower()}_assign&#39;
    table_work = pd.DataFrame(self.ps.select(table))
    if table_work.empty:
        query_tmp = f&#39;select null app_id,null app_hash_file,null &#34;rule&#34;,null region_country_code,null intelica_id,null cod_hierarchy,null valid_from from {table}&#39;
        message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  
        message_create =  self.ps.create_table_from_select(query_tmp,f&#39;{table_schema_source}.{table_name_result}&#39;)
        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;VISA&#34;,
        self.log_name,
        &#34;ADAPTER OF VISA SMS FILE&#34;,
        &#34;INFO&#34;,
        message_create,
        self.module
        )  

        return table_name_result
    table_work[&#39;rule&#39;] = 0
    table_work[&#39;id&#39;] = table_work.index + 1
    table_work[&#39;product_id&#39;] = table_work[&#39;product_id&#39;].str.strip()
    table_rules = pd.DataFrame(self.ps.select(&#39;operational.m_interchange_rules_visa r&#39;,f&#34;where to_date(&#39;{string_date}&#39;,&#39;yyyymmdd&#39;) between r.valid_from::date and coalesce(r.valid_until::date,current_date) and region_country_code in (select jurisdiction from {table} group by 1) order by region_country_code,intelica_id::numeric&#34;))
    table_rules[&#39;key&#39;] = table_rules.index + 1
    count_row=0
    count_condition = 0
    for rule in table_rules[&#39;key&#39;].values:
        table_test = pd.DataFrame()
        table_test = table_test.join(table_work[(table_work[&#39;jurisdiction&#39;] == table_rules[&#39;region_country_code&#39;][count_row]) &amp; (table_work[&#39;rule&#39;] == 0)],how=&#39;right&#39;)
        for condition in table_rules.columns.values:
            if condition not in (&#39;transaction_code_qualifier&#39;,&#39;payment_credential_combination&#39;,&#39;prepaid_card_indicator&#39;,&#39;business_format_code&#39;,&#39;type_purchase&#39;,&#39;authorized_amount&#39;,&#39;national_tax_indicator&#39;,&#39;merchant_vat&#39;,&#39;summary_commodity&#39;,&#39;message_identifier&#39;,&#39;app_id&#39;,&#39;intelica_id_original&#39;,&#39;app_creation_user&#39;,&#39;app_creation_date&#39;,&#39;key&#39;,&#39;transaction_amount_currency&#39;,&#39;jurisdiction&#39;,&#39;region_country_code&#39;,&#39;guide_date&#39;,&#39;valid_from&#39;,&#39;valid_until&#39;,&#39;fee_program&#39;,&#39;intelica_id&#39;,&#39;fpi&#39;,&#39;fee_descriptor&#39;,&#39;fee_description&#39;,&#39;cod_hierarchy&#39;,&#39;program_default&#39;,&#39;fee_currency&#39;,&#39;fee_variable&#39;,&#39;fee_fixed&#39;,&#39;fee_min&#39;,&#39;fee_cap&#39;,&#39;acquiring_identifier&#39;,&#39;message_identifier&#39;,&#39;merchant_verification_value&#39;,&#39;validation_code&#39;,&#39;v_i_p_full_financial_message_sets&#39;,&#39;sender_data&#39;,&#39;additional_sender_data&#39;,&#39;settlement_service&#39;,&#39;other_criteria_applies&#39;):
                value_condition = str(table_rules[condition][count_row]).replace(&#39; &#39;,&#39;&#39;)
                if value_condition.lower().replace(&#39;nan&#39;,&#39;none&#39;)  != &#39;none&#39;:
                    if len(table_test)&gt;0:
                        try:

                            if condition in (&#39;nnss_indicator&#39;,&#39;cardholder_id_method&#39;,&#39;moto_eci_indicator&#39;,&#39;acceptance_terminal_indicator&#39;,&#39;merchant_vat&#39;):
                                value_condition = value_condition.lower().replace(&#39;space&#39;,&#39; &#39;).upper()
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition.replace(&#39;NOT:&#39;,&#39;&#39;)
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[~table_test[condition].astype(str).isin(split_condition)]
                                else:
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[table_test[condition].astype(str).isin(split_condition)]
                                continue
                            if condition in (&#39;transaction_amount&#39;):
                                table_test = table_test[table_test[condition].astype(str) != &#39;BLANK&#39;]
                                value_condition_currency = f&#34;{condition}_{str(table_rules[&#39;transaction_amount_currency&#39;][count_row]).lower()}&#34;
                                table_test = table_test[table_test[value_condition_currency].astype(str) != &#39;BLANK&#39;]
                                table_test[value_condition_currency] = pd.to_numeric(table_test[value_condition_currency])
                                if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                    query_condition = f&#34;{value_condition_currency} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                    table_test.query(query_condition,inplace=True)
                                elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                    split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                    table_test=table_test[table_test[value_condition_currency].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                else:
                                    table_test=table_test[table_test[value_condition_currency].astype(str).str.strip() == value_condition]
                                continue
                            if condition in (&#39;surcharge_amount&#39;,&#39;timeliness&#39;):
                                table_test = table_test[table_test[condition] != &#39;BLANK&#39;]
                                table_test[condition] = pd.to_numeric(table_test[condition])
                                if value_condition.find(&#39;&lt;&#39;)&gt;=0 or value_condition.find(&#39;&gt;&#39;)&gt;=0 or value_condition.find(&#39;=&#39;)&gt;=0:
                                    query_condition = f&#34;{condition} {value_condition.replace(&#39;&lt;=&#39;,&#39;&lt;= &#39;).replace(&#39;&gt;=&#39;,&#39;&gt;= &#39;).replace(&#39;&gt;&#39;,&#39;&gt; &#39;).replace(&#39;&lt;&#39;,&#39;&lt; &#39;)}&#34;
                                    table_test.query(query_condition,inplace=True)
                                elif value_condition.lower().find(&#39;between&#39;)&gt;=0:
                                    split_condition = value_condition.lower().replace(&#39; &#39;,&#39;&#39;).replace(&#39;between&#39;,&#39;&#39;).split(&#39;and&#39;)
                                    table_test=table_test[table_test[condition].astype(float).between(int(split_condition[0]),int(split_condition[1]),inclusive=True)]
                                else:
                                    table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                continue
                            if condition in (&#39;merchant_category_code&#39;):
                                if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                    value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                    else:
                                        table_test=table_test[~table_test[condition].isin(self.fill_range(split_condition))]
                                else:
                                    split_condition = value_condition.split(&#39;,&#39;)
                                    if len(split_condition)&lt;2:
                                        table_test=table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                    else:
                                        table_test=table_test[table_test[condition].isin(self.fill_range(split_condition))]
                                continue
                            if value_condition.find(&#39;NOT:&#39;)&gt;=0:
                                value_condition = value_condition.replace(&#39;NOT:&#39;,&#39;&#39;).strip()
                                split_condition = value_condition.split(&#39;,&#39;)
                                if len(split_condition)&lt;2:
                                    if value_condition.find(&#39;.&#39;)&gt;=0:
                                        if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                            value_condition = str(int(float(value_condition)))
                                    table_test = table_test[table_test[condition].astype(str).str.strip() != value_condition]
                                else:
                                    table_test = table_test[~table_test[condition].astype(str).str.strip().isin(split_condition)]
                            else:
                                value_condition = value_condition.upper()
                                split_condition = value_condition.split(&#39;,&#39;)
                                if len(split_condition)&lt;2:
                                    if value_condition.find(&#39;.&#39;)&gt;=0:
                                        if value_condition.replace(&#39;.&#39;,&#39;&#39;).isnumeric():
                                            value_condition = str(int(float(value_condition)))
                                    table_test = table_test[table_test[condition].astype(str).str.strip() == value_condition]
                                else:
                                    value_condition = value_condition.split(&#39;,&#39;)
                                    table_test = table_test[table_test[condition].astype(str).str.strip().isin(split_condition)]
                            if table_test.empty:
                                break
                        except ValueError as error:                   
                            log.logs().exist_file(
                            &#34;OPERATIONAL&#34;,
                            &#34;&#34;,
                            &#34;VISA&#34;,
                            self.log_name,
                            &#34;ADAPTER OF VISA FILE&#34;,
                            &#34;ERROR&#34;,
                            &#34;Error has occurred:&#34;+ str(error),
                            self.module
                            )  
        if len(table_test)&gt;0:
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;rule&#39;] = rule
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;region_country_code&#39;] = table_rules[&#39;region_country_code&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;intelica_id&#39;] = table_rules[&#39;intelica_id&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;cod_hierarchy&#39;] = table_rules[&#39;cod_hierarchy&#39;][count_row]
            table_work.loc[table_work[&#39;id&#39;].isin(table_test[&#39;id&#39;].values),&#39;valid_from&#39;] = table_rules[&#39;valid_from&#39;][count_row]
        count_row+=1
    if len(table_work)&gt;0:
        message_drop = self.ps.drop_table(f&#39;{table_schema_source}.{table_name_result}&#39;)

        log.logs().exist_file(
        &#34;OPERATIONAL&#34;,
        &#34;&#34;,
        &#34;VISA&#34;,
        self.log_name,
        &#34;INTERCHANGE OF VISA FILE&#34;,
        &#34;INFO&#34;,
        message_drop,
        self.module
        )  
        table_work = table_work[[&#39;app_id&#39;,&#39;app_hash_file&#39;,&#39;rule&#39;,&#39;region_country_code&#39;,&#39;intelica_id&#39;,&#39;cod_hierarchy&#39;,&#39;valid_from&#39;]].applymap(str)
        table_work[&#34;intelica_id&#34;] = table_work[&#34;intelica_id&#34;].replace(&#34;nan&#34;,None)
        table_work[&#34;region_country_code&#34;] = table_work[&#34;region_country_code&#34;].replace(&#34;nan&#34;,None)
        self.ps.insert_from_df(table_work,table_schema_source.lower(),table_name_result)
        return table_name_result
    return &#39;-1&#39;</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter" href="index.html">PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters">get_adapters</a></code></h4>
<ul class="">
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_clear_stg" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_clear_stg">mastercard_clear_stg</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_extract_pds" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_extract_pds">mastercard_extract_pds</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_find_pds" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_find_pds">mastercard_find_pds</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_upload_adapter" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.mastercard_upload_adapter">mastercard_upload_adapter</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_apply_condition" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_apply_condition">visa_apply_condition</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_clear_stg" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_clear_stg">visa_clear_stg</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_read_condition" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_read_condition">visa_read_condition</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_read_sms" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_read_sms">visa_read_sms</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_upload_adapter" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_adapters.visa_upload_adapter">visa_upload_adapter</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others">get_others</a></code></h4>
<ul class="">
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.config_additional_table" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.config_additional_table">config_additional_table</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.config_additional_table_others" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.config_additional_table_others">config_additional_table_others</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.fill_range" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.fill_range">fill_range</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_mastercard_interchange" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_mastercard_interchange">load_mastercard_interchange</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_visa_interchange" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_visa_interchange">load_visa_interchange</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_visa_sms_interchange" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.load_visa_sms_interchange">load_visa_sms_interchange</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_config_table_adapter_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_config_table_adapter_dh">mastercard_config_table_adapter_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_config_table_adapter_stg" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_config_table_adapter_stg">mastercard_config_table_adapter_stg</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_interchange_rule_assign" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_interchange_rule_assign">mastercard_interchange_rule_assign</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_calculated_field_dh">mastercard_load_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_exclusion_transaction" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_exclusion_transaction">mastercard_load_exclusion_transaction</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_transaction" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.mastercard_load_transaction">mastercard_load_transaction</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.update_column_table_from_adapter" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.update_column_table_from_adapter">update_column_table_from_adapter</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_config_table_adapter_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_config_table_adapter_dh">visa_config_table_adapter_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_config_table_adapter_stg" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_config_table_adapter_stg">visa_config_table_adapter_stg</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_interchange_rule_assign" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_interchange_rule_assign">visa_interchange_rule_assign</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_calculated_field_dh">visa_load_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_sms_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_sms_calculated_field_dh">visa_load_sms_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_transaction" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_transaction">visa_load_transaction</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_110_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_110_calculated_field_dh">visa_load_vss_110_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_120_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_120_calculated_field_dh">visa_load_vss_120_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_130_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_130_calculated_field_dh">visa_load_vss_130_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_140_calculated_field_dh" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_load_vss_140_calculated_field_dh">visa_load_vss_140_calculated_field_dh</a></code></li>
<li><code><a title="PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_sms_interchange_rule_assign" href="#PROY-INTELICA-INTERCAMBIO-2022.Module.Adapter.adapters.get_others.visa_sms_interchange_rule_assign">visa_sms_interchange_rule_assign</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>